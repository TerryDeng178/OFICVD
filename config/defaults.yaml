# -*- coding: utf-8 -*-
# OFI+CVD 交易系统 - 默认配置文件
# HARVEST 数据目录规范（统一版）

paths:
  data_root: "${OFICVD_DATA_ROOT:./deploy/data/ofi_cvd}"
  artifacts_root: "${OFICVD_ARTIFACTS_ROOT:./deploy/artifacts/ofi_cvd}"
  timezone: "UTC"    # 分区的基准时区（强烈建议 UTC）
  layer: "raw"       # harvester 默认只写 raw；preview 由派生/接线任务产出

# 交易对配置（6个主要交易对）
symbols:
  - "BTCUSDT"
  - "ETHUSDT"
  - "BNBUSDT"
  - "SOLUSDT"
  - "XRPUSDT"
  - "DOGEUSDT"

harvest:
  rotate:
    max_rows: 500000
    max_sec: 300
  kinds:
    raw: ["prices", "orderbook", "aggtrade", "depth"]
    preview: ["ofi", "cvd", "fusion", "divergence", "events", "features"]
  dq:
    stale_ms: 1500
    require_fields: ["ts_ms", "symbol", "row_id"]
    min_price: 0.0
    min_qty: 0.0

system:
  version: "v4.0.0"
  environment: "development"

features:
  ofi:
    window_ms: 5000
    zscore_window: 30000
    levels: 5
    weights: [0.4, 0.25, 0.2, 0.1, 0.05]
    ema_alpha: 0.2
  cvd:
    window_ms: 60000
    z_mode: "delta"   # delta|level
  fusion:
    method: "zsum"    # zsum|weighted (预留字段，当前实现未使用，仅使用 w_ofi/w_cvd)
    w_ofi: 0.6
    w_cvd: 0.4
  divergence:
    lookback_bars: 60

sink:
  kind: jsonl         # jsonl|sqlite|dual
  output_dir: ./runtime
  db_name: signals.db  # SQLite数据库文件名（仅sqlite/dual使用）

executor:
  mode: backtest      # backtest|testnet|live
  sink: ${sink.kind}  # 继承全局sink配置
  output_dir: ${sink.output_dir}  # 继承全局output_dir
  symbols: [BTCUSDT]
  slippage_bps: 1.0   # 回测用滑点（bps）
  fee_bps: 1.93       # 成本估计，回测/测试网默认（bps）
  max_parallel_orders: 4  # 最大并发订单数（live模式）
  order_size_usd: 100     # 每单名义额（USD）
  tif: GTC               # 订单有效期（GTC/IOC/FOK）
  order_type: market     # 订单类型（market/limit）

adapter:
  impl: backtest  # backtest|testnet|live（如果未设置，从executor.mode推断）
  rate_limit:
    place: { rps: 8, burst: 16 }
    cancel: { rps: 5, burst: 10 }
    query: { rps: 10, burst: 20 }
  max_inflight_orders: 32
  rules_ttl_sec: 300
  idempotency_ttl_sec: 600
  order_size_usd: 100
  tif: GTC
  order_type: market
  retry:
    max_retries: 5
    base_delay_ms: 200
    factor: 2.0
    jitter_pct: 0.25

broker:
  name: binance-futures
  api_key_env: BINANCE_API_KEY      # 环境变量名（优先）
  secret_env: BINANCE_API_SECRET    # 环境变量名（优先）
  # api_key: ""                      # 直接配置（不推荐，仅用于测试）
  # secret_key: ""                   # 直接配置（不推荐，仅用于测试）
  testnet: true         # 是否使用测试网（true=测试网，false=实盘）
  dry_run: true         # dry-run模式（testnet模式默认开启）
  mock_enabled: true    # 是否启用Mock模式（默认启用，设为false使用真实API）
  # ⚠️ 实盘模式配置示例（谨慎使用）:
  # testnet: false
  # dry_run: false
  # mock_enabled: false
  # 实盘密钥通过环境变量设置：.\scripts\setup_binance_live_env.ps1

execution:
  enabled: true
  mode: "dry_run"        # dry_run | live
  rate_limit:
    max_qps: 10
    max_concurrency: 2
  retry:
    max_attempts: 3
    backoff_ms: 500
  sink:
    # 默认复用 V13_OUTPUT_DIR
    base_dir: "./runtime"
  business:
    # 交易决策阈值配置
    long_score_threshold: 0.5    # score > threshold 时做多
    short_score_threshold: -0.5  # score < threshold 时做空
    base_order_qty: 100.0        # 基础订单数量（USD）
  debug:
    # 调试配置
    log_skipped_signals: false   # 是否记录被跳过的信号到轻量JSONL

components:
  ofi:
    # TODO: 添加 OFI 配置参数
    pass
  
  cvd:
    # TODO: 添加 CVD 配置参数
    pass
  
  fusion:
    # TODO: 添加 FUSION 配置参数
    pass
  
  divergence:
    # TODO: 添加 DIVERGENCE 配置参数
    pass
  
  strategy:
    risk:
      enabled: ${RISK_INLINE_ENABLED:false}  # 环境变量控制，默认关闭（回退到legacy）
      guards:
        spread_bps_max: 8.0      # 价差上限（bps），与signal.spread_bps_cap对齐
        lag_sec_cap: 1.5         # 延迟上限（秒），与signal.lag_cap_sec对齐
        activity_min_tpm: 10.0   # 最小活跃度（每分钟交易数）
      position:
        max_notional_usd: 20000  # 最大名义额（USD）
        max_leverage: 5          # 最大杠杆
        symbol_limits:
          BTCUSDT: { max_qty: 0.5 }
          ETHUSDT: { max_qty: 5.0 }
      stop_rules:
        take_profit_bps: 40      # 止盈（bps）
        stop_loss_bps: 25        # 止损（bps）
      shadow_mode:
        compare_with_legacy: true  # 是否启用shadow对比
        diff_alert: ">=1%"         # 不一致占比阈值
      logging:
        sampling_rate: 0.01       # 通过单抽样率（1%，可配置，便于临时提权到100%）
        log_passed: true           # 是否记录通过单（抽样）
        log_denied: true           # 是否记录拒绝单（100%）
        log_schema_failed: true    # 是否记录Schema校验失败（100%）
        log_shadow_alert: true     # 是否记录Shadow告警（100%）

signal:
  dedupe_ms: 250
  weak_signal_threshold: 0.15
  consistency_min: 0.12
  # 分模式/分场景的一致性阈值（优先级高于 consistency_min）
  consistency_min_per_regime:
    active: 0.10
    quiet: 0.15
  # consistency 保守底座配置（略微抬高）
  consistency_floor: 0.10
  consistency_floor_when_abs_score_ge: 0.45
  consistency_floor_on_divergence: 0.15
  spread_bps_cap: 20.0
  lag_cap_sec: 3.0
  weights:
    w_ofi: 0.6
    w_cvd: 0.4
  activity:
    active_min_tps: 3.0
    normal_min_tps: 1.0
  thresholds:
    base:
      buy: 0.6
      strong_buy: 1.2
      sell: -0.6
      strong_sell: -1.2
    active:
      buy: 0.5
      strong_buy: 1.0
      sell: -0.5
      strong_sell: -1.0
    quiet:
      buy: 0.7
      strong_buy: 1.4
      sell: -0.7
      strong_sell: -1.4
  sink:
    kind: jsonl         # jsonl|sqlite|null
    output_dir: ./runtime
  replay_mode: 0
  debug: true

strategy_mode:
  mode: auto                            # auto | force_active | force_quiet
  hysteresis:
    window_secs: 60                      # 滑动窗口秒数
    min_active_windows: 2                 # 连续满足 active 条件的窗口数
    min_quiet_windows: 4                  # 连续不满足 active 条件的窗口数
  triggers:
    combine_logic: OR                     # OR 逻辑：schedule OR market（默认全天有效 + 市场活跃择一触发）
    schedule:
      enabled: true
      timezone: "Asia/Tokyo"              # 默认时区（与当前环境一致）
      enabled_weekdays: []                # 空数组=全周有效
      active_windows: []                  # 空数组=全天有效
      wrap_midnight: true
    market:
      enabled: true
      window_secs: 60                     # 市场指标滑动窗口
      basic_gate_multiplier: 0.5          # P0: 基础门槛倍率（生产基线）
      min_trades_per_min: 30              # 最小交易数/分钟
      min_quote_updates_per_sec: 40       # 最小报价更新/秒
      max_spread_bps: 5                   # 最大点差（bps）
      min_volatility_bps: 4               # 最小波动率（bps）
      min_volume_usd: 200000              # 最小成交量（USD）
      use_median: true                    # 使用中位数统计（提高稳健性）
      winsorize_percentile: 95            # Winsorize 百分位（去噪）

backtest:
  taker_fee_bps: 2.0      # Taker费率（bps）
  slippage_bps: 1.0       # 滑点（bps）
  notional_per_trade: 1000  # 每单名义额（USD）
  reverse_on_signal: false  # 是否反向开仓
  take_profit_bps: null     # 止盈（bps），null表示不启用
  stop_loss_bps: null       # 止损（bps），null表示不启用
  min_hold_time_sec: null   # 最小持仓时长（秒），null表示不启用
  max_hold_time_sec: 3600   # 最大持仓时长（秒）
  deadband_bps: 0          # 死区带（bps）
  ignore_gating: false      # 是否忽略门控（用于纯策略收益评估）
  rollover_timezone: UTC    # 日切时区
  rollover_hour: 0          # 日切小时（0-23）
