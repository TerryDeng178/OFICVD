# -*- coding: utf-8 -*-
# OFI+CVD 交易系统 - Staging 环境配置
# 基于 defaults.yaml，采用 AND 逻辑 + 工作日核心时段，用于预生产验证

paths:
  data_root: "${OFICVD_DATA_ROOT:./deploy/data/ofi_cvd}"
  artifacts_root: "${OFICVD_ARTIFACTS_ROOT:./deploy/artifacts/ofi_cvd}"
  timezone: "UTC"
  layer: "raw"

symbols:
  - "BTCUSDT"
  - "ETHUSDT"
  - "BNBUSDT"
  - "SOLUSDT"
  - "XRPUSDT"
  - "DOGEUSDT"

harvest:
  rotate:
    max_rows: 500000
    max_sec: 300
  kinds:
    raw: ["prices", "orderbook", "aggtrade", "depth"]
    preview: ["ofi", "cvd", "fusion", "divergence", "events", "features"]
  dq:
    stale_ms: 1500
    require_fields: ["ts_ms", "symbol", "row_id"]
    min_price: 0.0
    min_qty: 0.0

system:
  version: "v4.0.0"
  environment: "staging"

features:
  ofi:
    window_ms: 5000
    zscore_window: 30000
    levels: 5
    weights: [0.4, 0.25, 0.2, 0.1, 0.05]
    ema_alpha: 0.2
  cvd:
    window_ms: 60000
    z_mode: "delta"
  fusion:
    method: "zsum"
    w_ofi: 0.6
    w_cvd: 0.4
  divergence:
    lookback_bars: 60

sink:
  kind: jsonl
  output_dir: ./runtime

signal:
  dedupe_ms: 250
  weak_signal_threshold: 0.15            # Staging: 比 smoke 收紧，比 prod 放宽
  consistency_min: 0.10                  # Staging: 比 smoke 收紧，比 prod 放宽
  spread_bps_cap: 20.0
  lag_cap_sec: 3.0
  weights:
    w_ofi: 0.6
    w_cvd: 0.4
  activity:
    active_min_tps: 3.0
    normal_min_tps: 1.0
  thresholds:
    base:
      buy: 0.6
      strong_buy: 1.2
      sell: -0.6
      strong_sell: -1.2
    active:
      buy: 0.5
      strong_buy: 1.0
      sell: -0.5
      strong_sell: -1.0
    quiet:
      buy: 0.65                           # Staging: 比 smoke 收紧
      strong_buy: 1.3                     # Staging: 比 smoke 收紧
      sell: -0.65                         # Staging: 比 smoke 收紧
      strong_sell: -1.3                   # Staging: 比 smoke 收紧
  sink:
    kind: jsonl
    output_dir: ./runtime
  replay_mode: 1
  debug: true

strategy_mode:
  mode: auto
  hysteresis:
    window_secs: 60
    min_active_windows: 2
    min_quiet_windows: 4
  triggers:
    combine_logic: AND                     # Staging: 改为 AND，需要 schedule AND market 都满足
    schedule:
      enabled: true
      timezone: "UTC"
      enabled_weekdays: ["Mon", "Tue", "Wed", "Thu", "Fri"]  # 仅工作日
      # 核心交易时段（覆盖亚洲+欧洲+美洲主要时段）
      # 08:00 UTC = 亚洲时段开始（北京时间 16:00）
      # 24:00 UTC = 覆盖到美洲时段结束（纽约时间 19:00）
      active_windows:
        - start: 480   # 08:00 UTC (亚洲时段开始)
          end: 1440    # 24:00 UTC (覆盖亚洲+欧洲+美洲)
        - start: 0     # 00:00 UTC (美洲时段延续到次日)
          end: 480     # 08:00 UTC (美洲时段延续)
      wrap_midnight: true
    market:
      enabled: true
      window_secs: 60
      basic_gate_multiplier: 0.5          # Staging: 比 smoke 收紧（0.3 -> 0.5）
      min_trades_per_min: 25               # Staging: 比 smoke 收紧（20 -> 25）
      min_quote_updates_per_sec: 4        # Staging: 比 smoke 收紧（3 -> 4）
      max_spread_bps: 20                   # Staging: 比 smoke 收紧（30 -> 20）
      min_volatility_bps: 0.4              # Staging: 比 smoke 收紧（0.3 -> 0.4）
      min_volume_usd: 7500                 # Staging: 比 smoke 收紧（5000 -> 7500）
      use_median: true
      winsorize_percentile: 95

