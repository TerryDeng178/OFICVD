# -*- coding: utf-8 -*-
# CoreAlgorithm 信号参数调优 - 生产级配置 (Prod-like)
# TASK_PARAM_CORE_TUNING: 2025-11-16 调参完成
# ============================================================================
# 调优结论：参数调优未能显著提升交易数量
# 根本问题：CoreAlgorithm confirm逻辑过严，导致98.6%的信号被过滤
# ============================================================================
# 当前配置结果 (2025-11-15T15:00-15:05数据窗口):
# - 处理信号: 3,681个
# - confirm=True: 50个 (1.4%)
# - 实际交易: 30笔 (0.8%转化率)
# - Legacy模式: 135笔交易 (3.7%转化率，比strict多350%)
#
# Phase B1结果：weak_signal_threshold × consistency_min 网格搜索
# - 测试了9个参数组合 (0.10~0.20 × 0.00~0.10)
# - 所有组合结果相同：30笔交易
# - 结论：参数变化对结果影响很小
#
# Phase B2结果：min_consecutive_same_dir 测试
# - 测试了1, 2, 3三个值
# - 所有值结果相同：30笔交易
# - 结论：参数对confirm=False问题无效
#
# Phase C结果：Legacy vs Strict对比
# - Strict: 30笔交易 (受到confirm限制)
# - Legacy: 135笔交易 (忽略confirm/gating)
# - 差异: 105笔交易 (Legacy比Strict多350%)
#
# 下一步建议：
# 1. 调整CoreAlgorithm confirm阈值 (consistency_min从0.15降低)
# 2. 调整weak_signal_threshold (从0.20降低)
# 3. 或调整confirm逻辑本身
# ============================================================================

signal:
  sink: jsonl  # jsonl | sqlite | null
  output_dir: ./runtime
  replay_mode: 1  # Always 1 for backtest

  # === 信号质量控制参数 (调优目标) ===
  # TASK_PARAM_CORE_TUNING: 参数调优结论 - 这些参数对结果影响很小
  # 主要拦截原因是confirm=False (98.6%)，不是参数设置
  weak_signal_threshold: 0.20  # 弱信号阈值 - baseline: 0.20 (拦截73.1%信号)
  consistency_min: 0.15  # 最小一致性要求 - baseline: 0.15 (拦截97.8%信号)
  consistency_min_per_regime:
    active: 0.18  # 活跃模式一致性阈值 - baseline: 0.18
    quiet: 0.12   # 静默模式一致性阈值 - baseline: 0.12

  # === TASK_CONFIRM_PIPELINE_TUNING: Phase A 新增诊断配置 ===
  # 确认漏斗诊断开关
  enable_confirm_funnel_diagnostics: true

  # 漏斗统计输出
  funnel_output_mode: "both"  # json|log|both - 输出到JSON文件、日志、或两者
  min_consecutive_same_dir: 1  # 最小连续同向要求 - baseline: 1 (调优测试1/2/3，结果相同)

  # === 其他信号参数 (保持默认) ===
  min_abs_score_for_side: 0.0  # 默认0.0，允许任何非零score决定方向
  thresholds:
    active:
      buy: 0.4
      sell: -0.4

components:
  fusion:
    w_ofi: 0.6
    w_cvd: 0.4
    adaptive_cooldown_k: 0.6
    flip_rearm_margin: 0.05
    min_consecutive: 3

  cvd:
    winsor_limit: 2.0

strategy:
  mode: active
  direction: both
  entry_threshold: 0.0
  exit_threshold: 0.0

execution:
  cooldown_ms: 500

risk:
  max_position_notional: 10000
  max_drawdown_bps: 2000
  gates:
    max_spread_bps: 2.5
    max_lag_sec: 0.5
    require_activity: true

aligner:
  lag_threshold_ms: 5000
  spread_threshold: 2.0
  volatility_threshold: 5.0

reader:
  dedup_keep_hours: 2

backtest:
  taker_fee_bps: 2.0
  slippage_bps: 1.0
  notional_per_trade: 1000
  reverse_on_signal: false
  take_profit_bps: null
  stop_loss_bps: null
  min_hold_time_sec: null
  ignore_gating_in_backtest: true
  rollover_timezone: "UTC"
  rollover_hour: 0
  slippage_model: "static"
  fee_model: "taker_static"

  slippage_piecewise:
    scenario_multipliers:
      A_H: 1.5
      A_L: 1.0
      Q_H: 1.5
      Q_L: 0.8
    spread_base_multiplier: 1.0

  fee_tiered:
    tier_mapping:
      TM: 2.0
      TK: 2.0
      MM: 1.0
      MK: 1.0

  fee_maker_taker:
    scenario_probs:
      Q_H: 0.2
      A_L: 0.8
      A_H: 0.4
      Q_L: 0.6
    spread_slope: 0.7
    spread_threshold_wide: 5.0
    spread_threshold_narrow: 1.0
    side_bias:
      buy: 1.2
      sell: 0.8
    maker_fee_ratio: 0.5

data:
  features_price_dir: "deploy/data/ofi_cvd"

paths:
  input_dir: ./deploy/data/ofi_cvd
  output_dir: ./runtime/backtest
