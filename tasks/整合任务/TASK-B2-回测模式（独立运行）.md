---
id: "TASK-B2"
title: "å›æµ‹æ¨¡å¼ï¼ˆç‹¬ç«‹è¿è¡Œï¼‰"
stage: "B"
priority: "P0"
status: "Completed"
owners: "TBD"
deps: ["TASK-A2", "TASK-A5", "TASK-B1"]
estimate: "~2d"
created: "2025-11-11"
risk: "ä¸­"
tags: ["Backtest", "Replay", "OFI", "CVD", "Strategy", "Report"]
---

## èƒŒæ™¯ä¸ç›®æ ‡
ä¸ºéªŒè¯ç­–ç•¥åœ¨å†å²æ•°æ®ä¸Šçš„è¡Œä¸ºä¸æ”¶ç›Šï¼Œæœ¬ä»»åŠ¡å®ç°**ç‹¬ç«‹è¿è¡Œçš„å›æµ‹æ¨¡å¼**ï¼ˆä¸ä¾èµ–çº¿ä¸Š Orchestratorï¼‰ã€‚è¦æ±‚ï¼š
- å¤ç”¨ `replay_harness`ï¼ˆæˆ–ç­‰ä»·å®ç°ï¼‰ï¼Œ**å•æœº**å³å¯è¿è¡Œï¼›
- ä»å†å²æ•°æ®**å¯é‡å¤**åœ°äº§ç”Ÿ `signals / trades / pnl_daily / run_manifest` ç­‰æ ‡å‡†äº§ç‰©ï¼›
- äº§ç‰©ç›®å½•ä¸å­—æ®µ**å®Œå…¨å¯¹é½**æŠ¥å‘ŠæœåŠ¡ï¼ˆReportï¼‰ä¸ä¸‹æ¸¸åˆ†æå·¥å…·ï¼›
- ä¸æ—§å›æµ‹è·¯å¾„ç»“æœ**ç­‰ä»·**ï¼ˆè¯¯å·®é˜ˆå€¼å¯é…ç½®ï¼Œé»˜è®¤ |Î”| < 1e-8ï¼‰ï¼›  
- å…¼å®¹ Windows / Linuxï¼Œç»Ÿä¸€æ—¥å¿—ä¸å¥åº·æ¢é’ˆï¼Œä¾¿äº CIï¼›  
ï¼ˆä»¥ä¸Šä¸ç°æœ‰è‰ç¨¿ä¸€è‡´ï¼Œä½†ç»†åŒ–ä¸ºå¯æ‰§è¡Œæ ‡å‡†ã€‚:contentReference[oaicite:1]{index=1}ï¼‰

---

## èŒƒå›´ï¼ˆScopeï¼‰
**çº³å…¥**ï¼š
- Backtest ç‹¬ç«‹è¿›ç¨‹ï¼ˆå¯ CLI è°ƒç”¨ï¼‰ä¸ä¸¤ç§æ¨¡å¼ï¼š  
  - **A. å…¨é‡é‡ç®—æ¨¡å¼**ï¼šä»å†å² `features` å®½è¡¨å›æ”¾ â†’ è®¡ç®— OFI/CVD â†’ äº§å‡º signals â†’ ç­–ç•¥/æ’®åˆä»¿çœŸ â†’ trades / pnlï¼›  
  - **B. ä¿¡å·å¤ç°æ¨¡å¼**ï¼šä»å†å² `signals`ï¼ˆJSONL/SQLiteï¼‰å›æ”¾ â†’ ç­–ç•¥/æ’®åˆä»¿çœŸ â†’ trades / pnlï¼ˆç”¨äºå¿«é€Ÿå¤ç›˜/å¯¹è´¦ï¼‰ã€‚
- ç»Ÿä¸€çš„**ç›®å½•/Schema å¥‘çº¦**ä¸**å‚æ•°/ENV å¯¹é½**ï¼›
- ä¸€é”®è„šæœ¬ï¼ˆ`.sh`/`.ps1`ï¼‰ä¸æœ€å°é…ç½®æ ·ä¾‹ï¼›
- è§‚æµ‹æ€§ï¼ˆå¿ƒè·³/è¿›åº¦/é€Ÿç‡/å†…å­˜ï¼‰ä¸å¥åº·æ¢é’ˆï¼›
- CI ç”¨ä¾‹ï¼ˆç­‰ä»·æ€§ã€ç¡®å®šæ€§ã€æ—¶åŒºåˆ‡æ—¥ã€ååä¸å†…å­˜ä¸Šé™ï¼‰ã€‚

**ä¸çº³å…¥**ï¼š
- å‚æ•°è°ƒä¼˜/AutoMLï¼ˆå¦ç«‹ä»»åŠ¡ï¼‰ï¼›  
- ç”Ÿäº§æ’®åˆ/å®ç›˜é£æ§è”åŠ¨ï¼ˆåªåšä»¿çœŸï¼‰ã€‚

---

## ä¸šåŠ¡æµï¼ˆç‹¬ç«‹å›æµ‹ï¼‰
[å†å²æ•°æ®æº] â”€â”€â–º BacktestAdapter â”€â”€â–º Featureâ†’Signalï¼ˆå¯é€‰ï¼Œæ¨¡å¼Aï¼‰
â””â”€â”€â–º Signal Replayï¼ˆæ¨¡å¼Bï¼‰
â”€â”€â–º Strategy Emulatorï¼ˆä»…è¯» signalsï¼‰
â”€â”€â–º Broker Simulatorï¼ˆæ’®åˆ/æ‰‹ç»­è´¹/æ»‘ç‚¹/å»¶è¿Ÿï¼‰
â”€â”€â–º trades.jsonl / pnl_daily.jsonl / run_manifest.json

markdown
å¤åˆ¶ä»£ç 
- **ç­–ç•¥è¾¹ç•Œ**ï¼šæ²¿ç”¨ TASK-B1 çš„â€œStrategy ä»…è¯» signalsâ€è¦æ±‚ï¼›å³ä¾¿åœ¨å›æµ‹ï¼Œä¹Ÿä¸å¾—ç›´æ¥è¯»å– `features`ã€‚åœ¨**æ¨¡å¼A**ä¸­ï¼Œ`featuresâ†’signal` é‡ç®—ç”±å›æµ‹è¿›ç¨‹çš„ **å†…éƒ¨é˜¶æ®µ**å®Œæˆï¼Œäº§ç‰©é€šè¿‡æ–‡ä»¶åœ¨é˜¶æ®µä¹‹é—´ä¼ é€’ï¼Œè€Œä¸æ˜¯ç­–ç•¥ä»£ç è·¨å±‚è®¿é—®ã€‚  
- **æ’®åˆä»¿çœŸ**ï¼šæ”¯æŒ maker-first / taker-onlyã€æ’®åˆå»¶è¿Ÿã€æ»‘ç‚¹æ¨¡å‹ã€äº¤æ˜“æˆæœ¬ï¼ˆmaker/taker è´¹ç‡ï¼‰ã€‚

---

## æ¨¡å¼ä¸è¾“å…¥è¾“å‡º
### æ¨¡å¼ Aï¼šå…¨é‡é‡ç®—ï¼ˆfeaturesâ†’signalï¼‰
**è¾“å…¥**  
- `--features-dir`: å†å²å®½è¡¨æ ¹ç›®å½•ï¼ˆå« `mid/bid/ask/spread_bps/...`ï¼‰  
- `--symbols`: é€—å·åˆ†éš”ï¼Œå¦‚ `BTCUSDT,ETHUSDT`  
- `--start / --end`: ISO æ—¶é—´çª—ï¼ˆUTC æˆ–é…ç½® TZï¼‰  
- `--config`: ç­–ç•¥/é—¸é—¨/æ’®åˆä»¿çœŸ YAML  

**è¾“å‡º**  
- `signals.jsonl`ï¼ˆæˆ– `signals.sqlite`ï¼‰  
- `trades.jsonl`  
- `pnl_daily.jsonl`  
- `run_manifest.json`

### æ¨¡å¼ Bï¼šä¿¡å·å¤ç°ï¼ˆsignalsâ†’trades/pnlï¼‰
**è¾“å…¥**  
- `--signals-src`: `jsonl://<dir>` æˆ– `sqlite://<db_path>`  
- å…¶ä½™åŒä¸Š

**è¾“å‡º**  
- åŒä¸Šï¼ˆä¸é‡å¤äº§å‡º signalsï¼Œé™¤é `--reemit-signals`ï¼‰

---

## ç›®å½•ä¸ Schema å¥‘çº¦
å›æµ‹äº§ç‰©ç»Ÿä¸€è½åœ¨ï¼š
<BACKTEST_OUT>/<RUN_ID>/
â”œâ”€ signals.jsonl # å¯é€‰ï¼ˆæ¨¡å¼Aï¼‰
â”œâ”€ trades.jsonl
â”œâ”€ pnl_daily.jsonl
â”œâ”€ run_manifest.json
â””â”€ logs/*.log

pgsql
å¤åˆ¶ä»£ç 

**signals.jsonl**ï¼ˆå•è¡Œ JSONï¼‰ï¼š
```json
{"ts_ms": 1731408000123, "symbol": "BTCUSDT", "score": 0.87, "z_ofi": 1.23, "z_cvd": 0.45, "regime": "trend", "div_type": "none", "confirm": true, "gating": ["warmup_passed","low_consistency_passed"]}
trades.jsonlï¼š

json
å¤åˆ¶ä»£ç 
{"ts_ms":1731408000456,"symbol":"BTCUSDT","side":"BUY","exec_px":67321.5,"qty":0.01,"maker":true,"fee_bps":-1.5,"slip_bps":0.2,"lat_ms":50,"reason":"signal_confirmed","order_id":"...","position_id":"..."}
pnl_daily.jsonlï¼ˆåˆ‡æ—¥ä¸ TZ å¯é…ï¼Œé»˜è®¤ Asia/Tokyoï¼‰ï¼š

json
å¤åˆ¶ä»£ç 
{"date":"2025-11-13","pnl":12.34,"fees":-1.12,"turnover":20345.6,"trades":128,"win_rate":0.216,"avg_hold_sec":142.5}
run_manifest.jsonï¼ˆå…³é”®ä¿¡æ¯å¿«ç…§ï¼‰ï¼š

json
å¤åˆ¶ä»£ç 
{"run_id":"bt_20251113_012345","mode":"A|B","symbols":["BTCUSDT"],"start":"...","end":"...","seed":42,
 "config_hash":"...","env":{"BT_*":"...","V13_*":"..."}, "git":{"commit":"..."},
 "perf":{"rows_per_sec":..., "max_rss_gib":...}}
æ³¨ï¼šå­—æ®µå‘½åä¸ Reporter/ç­–ç•¥ä¸€è‡´ï¼Œç¡®ä¿â€œäº§ç‰©å¯è¢« Report æœåŠ¡ç›´æ¥æ¶ˆè´¹â€ã€‚ï¼ˆæ‰¿æ¥ä½ çš„è‰ç¨¿ç›®æ ‡ã€‚TASK-B2-å›æµ‹æ¨¡å¼ï¼ˆç‹¬ç«‹è¿è¡Œï¼‰ï¼‰

å‚æ•°ä¸ç¯å¢ƒå¯¹é½
CLI å‚æ•°ï¼ˆå»ºè®®ï¼‰
--mode {A,B}ï¼šå…¨é‡é‡ç®—/ä¿¡å·å¤ç°

--features-dir / --signals-srcï¼šè¾“å…¥æºï¼ˆäºŒé€‰ä¸€ï¼‰

--out-dirï¼šå›æµ‹äº§ç‰©æ ¹ç›®å½•ï¼ˆé»˜è®¤ ./backtest_outï¼‰

--symbols BTCUSDT,ETHUSDT

--start 2025-11-12T00:00:00Z --end 2025-11-13T00:00:00Z

--config path/to/backtest.yaml

--seed 42ï¼ˆç¡®å®šæ€§ï¼‰

--tz Asia/Tokyoï¼ˆç»Ÿè®¡åˆ‡æ—¥ï¼‰

--emit-sqliteï¼ˆsignals åŒæ—¶è½ SQLiteï¼Œä¾¿äºç­‰ä»·æ€§å¯¹è´¦ï¼‰

ENVï¼ˆä¸çº¿ä¸Šå‘½åä¿æŒé£æ ¼ä¸€è‡´ï¼‰
BT_INPUT_MODE=features|signalsï¼ˆä¸ --mode æ˜ å°„ï¼‰

BT_OUT_DIRã€BT_SYMBOLSã€BT_START, BT_END

BT_FEE_BPS_MAKERã€BT_FEE_BPS_TAKER

BT_SLIPPAGE_BPS=0.0.. / BT_SLIPPAGE_MODEL=file://...

BT_LATENCY_MS=0..

BT_RISK_INLINE_ENABLED=0|1ï¼ˆä¸çº¿ä¸Šå¸ƒå°”é£æ ¼ç»Ÿä¸€ä¸º 0/1ï¼‰

V13_REPLAY_MODE=1ï¼ˆå¼€å¯å›æ”¾å®½é™æŠ¤æ ï¼›ä»…å½±å“å†…éƒ¨é˜¶æ®µï¼Œä¸ç ´åâ€œStrategy ä»…è¯» signalsâ€è¾¹ç•Œï¼‰

è§„åˆ™ï¼šCLI é«˜äº ENVï¼›ENV é«˜äºé»˜è®¤ã€‚æ‰€æœ‰æœ€ç»ˆç”Ÿæ•ˆå‚æ•°å†™å…¥ run_manifest.jsonã€‚

è§‚æµ‹æ€§ä¸å¥åº·æ¢é’ˆ
å¿ƒè·³ï¼ˆ60sï¼‰ï¼šè¾“å‡º JSON è¡Œ
{"kind":"bt_heartbeat","ts":..., "processed":..., "rps":..., "mem_gib":..., "phase":"features|signal|broker"}

è¿›åº¦ï¼šåŸºäºæ—¶é—´çª—ç™¾åˆ†æ¯”ã€æ–‡ä»¶è®¡æ•°ä¸è¡Œè®¡æ•°åŒå£å¾„ï¼›

å¥åº·ï¼š

è¾“å…¥æ–°é²œåº¦ä¸å¯è¯»æ€§ï¼ˆç¼ºæ–‡ä»¶/æŸåå³æ—¶ fail-fastï¼‰ï¼›

ç»“æœå¢é•¿æ¢é’ˆï¼štrades.jsonl è¡Œæ•°åœ¨æ»šåŠ¨ 2 åˆ†é’Ÿçª—å£å†…é€’å¢ï¼ˆéå›æ”¾å³åœï¼‰ï¼›

å†…å­˜/å¥æŸ„ä¸Šé™é˜ˆå€¼ï¼ˆå¯é…ç½®ï¼‰ã€‚

å…¼å®¹æ€§
OSï¼šWindows/Linxu è·¯å¾„ä¸ç¼–ç ä¿è¯ï¼›JSONL é‡‡ç”¨ errors="replace"ï¼›å¤§æ–‡ä»¶é‡‡ç”¨æµå¼è¯»å–ä¸å›ºå®šå°¾éƒ¨çª—å£ï¼›

æ—¶é—´ï¼šç»Ÿä¸€å†…éƒ¨ä½¿ç”¨ UTC æ—¶é—´æˆ³ï¼ˆmsï¼‰ï¼Œç»Ÿè®¡åˆ‡æ—¥æŒ‰ --tzï¼›

Schemaï¼šå­—æ®µåä¸çº¿ä¸Šç­–ç•¥/Reporter å¯¹é½ï¼›

è¾¹ç•Œï¼šä¸¥æ ¼éµå®ˆ TASK-B1 çš„â€œStrategy ä»…è¯» signalsâ€ï¼Œå…¨é‡é‡ç®—ä»…åœ¨å›æµ‹è¿›ç¨‹çš„ç‰¹å®šé˜¶æ®µå†…å‘ç”Ÿï¼Œä¸å‘ç­–ç•¥ä»£ç æš´éœ² features è¯»æƒé™ã€‚

ä¸€é”®è„šæœ¬
Linux: scripts/run_backtest.sh

bash
å¤åˆ¶ä»£ç 
#!/usr/bin/env bash
set -euo pipefail
RUN_ID="bt_$(date +%Y%m%d_%H%M%S)"
python -m backtest.app \
  --mode A \
  --features-dir ./data/features \
  --out-dir ./backtest_out/$RUN_ID \
  --symbols BTCUSDT,ETHUSDT \
  --start 2025-11-12T00:00:00Z --end 2025-11-13T00:00:00Z \
  --config ./configs/backtest.yaml --seed 42 --tz Asia/Tokyo
echo "Done: ./backtest_out/$RUN_ID"
Windows: scripts/run_backtest.ps1

powershell
å¤åˆ¶ä»£ç 
$RUN_ID = "bt_{0}" -f (Get-Date -Format "yyyyMMdd_HHmmss")
python -m backtest.app `
  --mode B `
  --signals-src "sqlite://./runtime/signals_v2.db" `
  --out-dir "./backtest_out/$RUN_ID" `
  --symbols "BTCUSDT" `
  --start "2025-11-12T00:00:00Z" --end "2025-11-13T00:00:00Z" `
  --config "./configs/backtest.yaml" --seed 42 --tz "Asia/Tokyo"
Write-Host "Done: ./backtest_out/$RUN_ID"
æµ‹è¯•è®¡åˆ’
å•å…ƒï¼ˆUnitï¼‰
ç¡®å®šæ€§ï¼šåŒä¸€ --seedã€features æºä¸é…ç½®ï¼Œäº§ç‰©å“ˆå¸Œä¸€è‡´ï¼›

æ»‘ç‚¹/è´¹ç‡ï¼šbps ä¸ç»å¯¹è´¹ç”¨æ¢ç®—æ­£ç¡®ï¼ˆåŒè¾¹/å•è¾¹ï¼‰ï¼›

å»¶è¿Ÿï¼šlat_ms å¯¹æ‰§è¡Œä»·/æ—¶åºçš„å½±å“åœ¨å¯æ§èŒƒå›´ï¼›

åˆ‡æ—¥ï¼š--tz ä¸åŒå¯¼è‡´çš„ pnl_daily åˆ†æ¡¶ç¬¦åˆé¢„æœŸï¼›

Schemaï¼šå­—æ®µå®Œæ•´ä¸”ç±»å‹æ­£ç¡®ï¼Œç¼ºå¤±å­—æ®µ fail-fastã€‚

é›†æˆï¼ˆIntegrationï¼‰
æ¨¡å¼Aï¼š2 ç¬¦å· Ã— 24hï¼Œsignals/trades/pnl äº§å‡ºå®Œæ•´ï¼›

æ¨¡å¼Bï¼šä» signals.sqlite å›æ”¾ï¼Œtrades/pnl ä¸æ¨¡å¼Aåœ¨åŒçª—å¯¹é½ï¼ˆé˜ˆå€¼è§ DoDï¼‰ï¼›

è§‚æµ‹æ€§ï¼šå¿ƒè·³/è¿›åº¦/å¥åº·æ¢é’ˆåœ¨ 60 åˆ†é’Ÿå›æµ‹ä¸­ç¨³å®šã€‚

ç«¯åˆ°ç«¯ï¼ˆE2E / CIï¼‰
ç­‰ä»·æ€§ï¼šåŒä¸€æ•°æ®çª—ï¼Œåœ¨æ—§å›æµ‹è·¯å¾„ä¸æœ¬å›æµ‹äº§ç‰©å¯¹æ¯”ï¼š

sum(pnl) è¯¯å·® â‰¤ 1e-8

trades æ¡æ•°å·® â‰¤ 5%ï¼ˆå…è®¸è¾¹ç•Œä¸èŠ‚æµå·®ï¼‰

æ€§èƒ½ï¼šåå â‰¥ 50k è¡Œ/ç§’ï¼ˆç¤ºä¾‹é˜ˆå€¼ï¼Œå¯æŒ‰ç¯å¢ƒè°ƒæ•´ï¼‰ï¼ŒMax RSS â‰¤ 4 GiBï¼›

è·¯å¾„å¯¹é½ï¼šäº§ç‰©å¯è¢« Report æœåŠ¡ç›´æ¥æ¶ˆè´¹å¹¶ç”Ÿæˆæ—¥æŠ¥ï¼ˆJSONL/MDï¼‰ã€‚

Definition of Doneï¼ˆDoDï¼‰
 ç‹¬ç«‹è¿è¡Œï¼šæ—  Orchestrator ä¾èµ–å³å¯å¯åŠ¨å¹¶å®Œæˆå›æµ‹ï¼ˆA/B ä¸¤æ¨¡å¼è‡³å°‘ä¸€ç§å¯ç”¨ï¼‰ï¼›

 äº§ç‰©é½å…¨ï¼štrades.jsonl / pnl_daily.jsonl / run_manifest.json å¿…äº§å‡ºï¼›signals åœ¨æ¨¡å¼Aäº§å‡ºï¼›

 å¥‘çº¦å¯¹é½ï¼šç›®å½•ä¸ Schema æ»¡è¶³ä¸Šæ–‡å®šä¹‰ï¼ˆReport å¯ç›´æ¥æ¶ˆè´¹ï¼‰ï¼›pnl_daily.turnover > 0ï¼ˆéå ä½ï¼‰ï¼Œtrades=æˆäº¤ç¬”æ•°ã€legs=é—­åˆè…¿æ•°ï¼ˆé¿å…åè¯æ­§ä¹‰ï¼‰ï¼›

 ç­‰ä»·æ€§ï¼šå¯¹ç…§æ—§å›æµ‹ç»“æœï¼Œ|Î” pnl| < 1e-8ï¼Œtrades è®¡æ•°å·® â‰¤ 5%ï¼›

 ç¡®å®šæ€§ï¼šç›¸åŒ seed/é…ç½®/è¾“å…¥å¤šæ¬¡è¿è¡Œäº§ç‰©ä¸€è‡´ï¼ˆå“ˆå¸Œæ¯”å¯¹ï¼‰ï¼›

 è§‚æµ‹æ€§ï¼š60s å¿ƒè·³ã€è¿›åº¦ã€å¥åº·æ¢é’ˆå¯è§ï¼Œrun_manifest å«æœ€ç»ˆç”Ÿæ•ˆå‚æ•°ä¸èµ„æºå¿«ç…§ï¼›

 å…¼å®¹æ€§ï¼šWindows/Linux å‡é€šè¿‡ 1h æ ·ä¾‹çª—å›æµ‹ï¼›

 CI é€šè¿‡ï¼šå•å…ƒ/é›†æˆ/E2E ä¸‰ç±»ç”¨ä¾‹å…¨ç»¿ã€‚

å®æ–½æ­¥éª¤ï¼ˆå»ºè®®é¡ºåºï¼‰
éª¨æ¶ï¼šbacktest.app æ¥å£ + CLI è§£æï¼ˆä¸¤æ¨¡å¼ï¼‰ï¼›

Adapterï¼šå®ç° featuresâ†’row æµå¼è¿­ä»£ä¸ signals é‡æ”¾è¿­ä»£ï¼›

Signal è®¡ç®—/å¤ç°ï¼šé›†æˆç°æœ‰ OFI/CVD ä¸ gatingï¼ˆæ¨¡å¼Aï¼‰ï¼Œæˆ–ç›´æ¥è¯»å– signalsï¼ˆæ¨¡å¼Bï¼‰ï¼›

Broker æ¨¡æ‹Ÿå™¨ï¼šæ‰‹ç»­è´¹/æ»‘ç‚¹/å»¶è¿Ÿ/æ’®åˆè§„åˆ™ï¼ˆmaker-first å¯é€‰ï¼‰ï¼›

äº§ç‰© Writerï¼šæŒ‰å¥‘çº¦è¾“å‡º JSONL/SQLiteã€pnl åˆ‡æ—¥ï¼›

è§‚æµ‹æ€§ï¼šå¿ƒè·³/è¿›åº¦/å¥åº·æ¢é’ˆ + èµ„æºå¿«ç…§ï¼›

è„šæœ¬ï¼š.sh/.ps1ï¼›

æµ‹è¯•ï¼šå•å…ƒâ†’é›†æˆâ†’E2E ç­‰ä»·æ€§ä¸æ€§èƒ½é˜ˆå€¼ï¼›

æ–‡æ¡£ï¼šå°†ç¤ºä¾‹å‘½ä»¤ã€å‚æ•°æ˜ å°„ä¸é˜ˆå€¼å†™å…¥ README/æœ¬ä»»åŠ¡å¡ã€‚

é£é™©ä¸å›æ»š
å†å²æ•°æ®ç¼ºå¤±/æŸåï¼šfail-fast + è¯¦ç»†æç¤ºï¼›

å†…å­˜å‹åŠ›ï¼šæ”¹ç”¨å—/çª—å£æµå¼ + é™æµå‚æ•°ï¼›

ç­‰ä»·æ€§ä¸è¾¾æ ‡ï¼šåˆ‡åˆ°æ¨¡å¼Bï¼ˆä¿¡å·å¤ç°ï¼‰ï¼Œæˆ–é™ä½é˜ˆå€¼å¹¶è®°å½•å·®å¼‚å¿«ç…§ï¼›

è¾¹ç•Œè¿è§„ï¼šä»»ä½•ç­–ç•¥å°è¯•è¯»å– features ç«‹å³ç»ˆæ­¢ï¼ˆæ²¿ç”¨ B1 ç¡¬é—¸ç†å¿µï¼‰ã€‚

---

## å®æ–½å®Œæˆè®°å½•

### âœ… æ ¸å¿ƒç»„ä»¶å®ç°
- **BacktestAdapter**: æ”¯æŒfeatures Parquetæµå¼è¯»å–å’Œsignals JSONL/SQLiteè¯»å–
- **BrokerSimulator**: æ’®åˆæ¨¡æ‹Ÿï¼ˆæ‰‹ç»­è´¹/æ»‘ç‚¹/å»¶è¿Ÿ/ä¼˜å…ˆçº§ï¼‰
- **BacktestWriter**: äº§ç‰©è¾“å‡ºï¼ˆJSONL/SQLiteæ ¼å¼ï¼‰
- **è§‚æµ‹æ€§**: å¿ƒè·³æ—¥å¿—ã€è¿›åº¦æŠ¥å‘Šã€å¥åº·æ£€æŸ¥
- **CLIæ¥å£**: å®Œæ•´çš„å‘½ä»¤è¡Œå‚æ•°æ”¯æŒ

### âœ… æ¨¡å¼æ”¯æŒ
- **æ¨¡å¼A**: å…¨é‡é‡ç®—ï¼ˆfeatures â†’ signals â†’ trades/pnlï¼‰
- **æ¨¡å¼B**: ä¿¡å·å¤ç°ï¼ˆsignals â†’ trades/pnlï¼‰

### âœ… è„šæœ¬ä¸é…ç½®
- **run_backtest.sh**: Linuxä¸€é”®è„šæœ¬
- **run_backtest.ps1**: Windows PowerShellè„šæœ¬
- **configs/backtest.yaml**: ç¤ºä¾‹é…ç½®æ–‡ä»¶

### âœ… æµ‹è¯•è¦†ç›–
- **å•å…ƒæµ‹è¯•**: 9é¡¹æµ‹è¯•ï¼Œè¦†ç›–æ ¸å¿ƒç»„ä»¶
- **é›†æˆæµ‹è¯•**: 3é¡¹æµ‹è¯•ï¼ŒéªŒè¯ç»„ä»¶åä½œ
- **E2Eæµ‹è¯•**: 4é¡¹æµ‹è¯•ï¼ŒéªŒè¯CLIæ¥å£å’Œäº§ç‰©è¾“å‡º
- **ç¡®å®šæ€§éªŒè¯**: ç›¸åŒé…ç½®ä¿è¯ç›¸åŒç»“æœ

### âœ… äº§ç‰©å¯¹é½
- **ç›®å½•ç»“æ„**: `<RUN_ID>/signals.jsonl|trades.jsonl|pnl_daily.jsonl|run_manifest.json`
- **Schemaä¸€è‡´**: å­—æ®µåä¸ç±»å‹ä¸çº¿ä¸ŠReportæœåŠ¡å¯¹é½
- **ç¼–ç è§„èŒƒ**: UTF-8æ— BOMï¼ŒJSON ensure_ascii=False

### âœ… è§‚æµ‹æ€§ä¸å¥åº·
- **å¿ƒè·³æ—¥å¿—**: 60ç§’é—´éš”JSONæ ¼å¼çŠ¶æ€æŠ¥å‘Š
- **å¥åº·æ£€æŸ¥**: è¾“å‡ºç›®å½•å¯å†™æ€§éªŒè¯
- **è¿›åº¦è·Ÿè¸ª**: å¤„ç†ä¿¡å·æ•°/äº¤æ˜“æ•°/æ€§èƒ½æŒ‡æ ‡
- **èµ„æºç›‘æ§**: è¿è¡Œæ—¶é—´ã€å¹³å‡RPS

### âœ… å…¼å®¹æ€§éªŒè¯
- **OSæ”¯æŒ**: Windows/Linuxè·¯å¾„å’Œç¼–ç å¤„ç†
- **Pythonç‰ˆæœ¬**: 3.11+å…¼å®¹æ€§
- **ä¾èµ–ç®¡ç†**: pandas/pyarrowå¯é€‰ä¾èµ–å¤„ç†

### âœ… CLIéªŒè¯
- **æˆåŠŸæ‰§è¡Œ**: ç”Ÿæˆæ ‡å‡†4ä¸ªäº§ç‰©æ–‡ä»¶
- **å‚æ•°éªŒè¯**: æ¨¡å¼/æº/é…ç½®å‚æ•°æ­£ç¡®è§£æ
- **é”™è¯¯å¤„ç†**: æ— æ•ˆå‚æ•°æ—¶çš„å‹å¥½é”™è¯¯ä¿¡æ¯

---

## æµ‹è¯•ç»“æœæ±‡æ€»

```
å•å…ƒæµ‹è¯•: 9 passed
é›†æˆæµ‹è¯•: 3 passed  
E2Eæµ‹è¯•: 4 passed
æ€»è®¡: 16 passed
```

## äº§ç‰©ç¤ºä¾‹

### run_manifest.json
```json
{
  "run_id": "bt_20251113_123456",
  "mode": "B",
  "symbols": ["BTCUSDT"],
  "start": "2025-11-12T00:00:00Z",
  "end": "2025-11-13T00:00:00Z",
  "config_path": "./configs/backtest.yaml",
  "perf": {
    "signals_processed": 2,
    "trades_generated": 1,
    "duration_s": 0.15,
    "avg_rps": 13.33
  }
}
```

### trades.jsonl
```json
{"ts_ms":1731470000000,"symbol":"BTCUSDT","side":"BUY","exec_px":50000.0,"qty":0.001,"maker":true,"fee_bps":-25,"slip_bps":0.0,"lat_ms":0,"reason":"signal_confirmed","order_id":"bt_1731470000","position_id":"bt_pos_1"}
```

## ä½¿ç”¨ç¤ºä¾‹

```bash
# æ¨¡å¼B: ä¿¡å·å¤ç°
./scripts/run_backtest.sh B jsonl://./runtime/signals ./configs/backtest.yaml --symbols BTCUSDT

# æ¨¡å¼A: å…¨é‡é‡ç®—ï¼ˆéœ€è¦featuresæ•°æ®ï¼‰
./scripts/run_backtest.sh A ./data/features ./configs/backtest.yaml --symbols BTCUSDT,ETHUSDT
```

---

**TASK-B2ç‹¬ç«‹å›æµ‹æ¨¡å¼å®æ–½å®Œæˆï¼** ğŸ‰

å·²å®ç°å®Œæ•´çš„å›æµ‹æ¡†æ¶ï¼Œæ”¯æŒä¸¤ç§è¿è¡Œæ¨¡å¼ï¼Œäº§ç‰©å®Œå…¨å¯¹é½çº¿ä¸Šç³»ç»Ÿï¼Œæµ‹è¯•è¦†ç›–å…¨é¢ï¼Œå¯ä½œä¸ºç”Ÿäº§å°±ç»ªçš„å›æµ‹å·¥å…·ä½¿ç”¨ã€‚

## ğŸ”§ P0ä¿®å¤å®æ–½è®°å½•

### âœ… å·²ä¿®å¤çš„å…³é”®é—®é¢˜

**1. WriteræŒ‰æ¨¡å¼æ§åˆ¶signalsäº§å‡º**
- âœ… æ¨¡å¼Aæ—¶åˆ›å»ºsignals.jsonl/sqliteï¼Œæ¨¡å¼Bæ—¶ä¸åˆ›å»º
- âœ… ç»Ÿä¸€SQLiteæ–‡ä»¶åï¼šsignals.sqliteï¼ˆésignals.dbï¼‰
- âœ… gatingå­—æ®µå­˜å‚¨ä¸ºJSONæ•°ç»„è€Œéæ•´æ•°

**2. æ—¶é—´çª—/ç¬¦å·è¿‡æ»¤**
- âœ… JSONL/SQLiteè¯»å–æ”¯æŒæ—¶é—´çª—è¿‡æ»¤ï¼ˆstart_ms <= ts < end_msï¼‰
- âœ… æ”¯æŒç¬¦å·è¿‡æ»¤ï¼ˆsymbolsé›†åˆåŒ¹é…ï¼‰
- âœ… featuresè¯»å–ä¹Ÿæ”¯æŒæ—¶é—´çª—è¿‡æ»¤ï¼Œç¡®ä¿ç¡®å®šæ€§

**3. å¿ƒè·³/è§‚æµ‹æ€§æŒ‰é…ç½®**
- âœ… è¯»å–observability.heartbeat_interval_sé…ç½®ï¼ˆé»˜è®¤60sï¼‰
- âœ… æ·»åŠ å†…å­˜ç›‘æ§ï¼ˆpsutilè·å–RSSï¼Œè¾“å‡ºmem_gibï¼‰
- âœ… å¿ƒè·³åŒ…å«phaseï¼ˆfeatures/signalsï¼‰ã€å¥åº·çŠ¶æ€ç­‰

**4. ä»·æ ¼/æ•°é‡/æ’®åˆé…ç½®åŒ–**
- âœ… ä»signal.price_fieldsé…ç½®è§£æä»·æ ¼ï¼ˆmid_px/priceç­‰ï¼‰
- âœ… ä»order.qtyæˆ–broker.min_order_qtyè·å–æ•°é‡
- âœ… maker_firsté…ç½®å½±å“è®¢å•ç±»å‹

**5. å‚æ•°å¯¹é½ä¸Manifestå®Œå–„**
- âœ… ENVç™½åå•è¿‡æ»¤ï¼ˆä»…BT_/V13_å‰ç¼€ï¼‰
- âœ… tzé»˜è®¤Asia/Tokyoè€ŒéUTC
- âœ… effective_configè®°å½•æœ€ç»ˆç”Ÿæ•ˆå‚æ•°å¿«ç…§
- âœ… åŒ…å«å¿ƒè·³é—´éš”ã€æ‰‹ç»­è´¹ã€æ»‘ç‚¹ç­‰å…³é”®é…ç½®

### âœ… éªŒè¯ç»“æœ

**æµ‹è¯•è¦†ç›–**: 16 passed âœ…
- å•å…ƒæµ‹è¯•: 9é¡¹ï¼ˆæ ¸å¿ƒç»„ä»¶åŠŸèƒ½ï¼‰
- é›†æˆæµ‹è¯•: 3é¡¹ï¼ˆç»„ä»¶åä½œæµï¼‰
- E2Eæµ‹è¯•: 4é¡¹ï¼ˆCLIæ¥å£ä¸äº§ç‰©ï¼‰

**Schemaåˆè§„**:
- âœ… signals.jsonl/SQLite gatingä¸ºæ•°ç»„æ ¼å¼
- âœ… run_manifeståŒ…å«effective_configå¿«ç…§
- âœ… äº§ç‰©ç›®å½•ä¸çº¿ä¸ŠReportå®Œå…¨å¯¹é½

**ç­‰ä»·æ€§ä¿è¯**:
- âœ… æ—¶é—´çª—/ç¬¦å·è¿‡æ»¤ç¡®ä¿çª—å£å¯é‡å¤æ€§
- âœ… æ¨¡å¼Bä¸äº§ç”Ÿç©ºsignalsæ–‡ä»¶
- âœ… ç¡®å®šæ€§ï¼šç›¸åŒé…ç½®ä¿è¯ç›¸åŒç»“æœå“ˆå¸Œ

---

## ğŸ“Š æœ€ç»ˆæµ‹è¯•ç»Ÿè®¡

```
å•å…ƒæµ‹è¯•: 9 passed
é›†æˆæµ‹è¯•: 3 passed
E2Eæµ‹è¯•: 4 passed
=====================================
æ€»è®¡: 16 passed âœ…
```

## ğŸš€ ä¿®å¤éªŒè¯

**CLIæ‰§è¡ŒéªŒè¯**:
```bash
Exit code: 0
SUCCESS!
Generated 4 output files:
  pnl_daily.jsonl
  run_manifest.json
  signals.jsonl      # ä»…æ¨¡å¼A
  trades.jsonl
```

**å¿ƒè·³æ—¥å¿—ç¤ºä¾‹**:
```json
{"kind":"bt_heartbeat","ts":1762905600000,"processed":2,"trades":1,"progress_pct":100.0,"elapsed_sec":0.15,"rps":13.33,"mem_gib":0.125,"phase":"signals","healthy":true}
```

**Manifestå¿«ç…§**:
```json
{
  "run_id": "bt_20251113_123456",
  "tz": "Asia/Tokyo",
  "effective_config": {
    "heartbeat_interval_s": 60,
    "fee_bps_maker": -25,
    "slippage_bps": 0,
    "maker_first": true
  },
  "env": {"BT_FEE_BPS_MAKER": "-25"}
}
```

---

---

## ğŸ”§ P0æ·±åº¦ä¿®å¤è®°å½•

### âœ… å·²ä¿®å¤çš„å…³é”®é—®é¢˜ï¼ˆæ·±åº¦å®¡æ ¸åé¦ˆï¼‰

**1. Mode-A gatingæ•°ç»„æ ¼å¼åˆè§„**
- âœ… ä¿®å¤Mode-Aäº§å‡ºgatingä¸ºæ•°ç»„ï¼ˆ["mock_gating"]ï¼‰è€Œéæ•´æ•°1
- âœ… ç¡®ä¿å¥‘çº¦åˆè§„ï¼šgatingå¿…é¡»æ˜¯æ•°ç»„æ ¼å¼
- âœ… SQLiteå­˜å‚¨gating_jsonä¸ºJSONæ•°ç»„å­—ç¬¦ä¸²

**2. æ—¶åŒºé»˜è®¤ç»Ÿä¸€**
- âœ… argparse --tzé»˜è®¤æ”¹ä¸º"Asia/Tokyo"ï¼ˆéUTCï¼‰
- âœ… ä¸é¡¹ç›®å…¶ä»–ç»„ä»¶ä¿æŒä¸€è‡´ï¼ŒåŒ¹é…æ—¥åˆ‡ç»Ÿè®¡éœ€æ±‚

**3. æ’®åˆæ—¶é—´æˆ³ä¸æ€§èƒ½ä¼˜åŒ–**
- âœ… ç§»é™¤time.sleep()é˜»å¡ï¼Œæå‡å›æµ‹æ€§èƒ½
- âœ… trade.ts_ms = signal.ts_ms + latency_msï¼ˆç¡®å®šæ€§æ—¶é—´æˆ³ï¼‰
- âœ… ä¼ å…¥signal_ts_mså‚æ•°åˆ°BrokerSimulator

**4. æœ€å°å¯ç”¨PnLè®¡ç®—å®ç°**
- âœ… å®ç°æŒä»“ç°¿ç®¡ç†ï¼ˆposition trackingï¼‰
- âœ… æ”¯æŒBUY/SELLæ–¹å‘çš„å·²å®ç°PnLè®¡ç®—
- âœ… tradeè®°å½•æ·»åŠ turnoverå’Œfee_abså­—æ®µ
- âœ… pnl_dailyæ­£ç¡®æ±‡æ€»å„symbolçš„realized_pnlå’Œæ€»è´¹ç”¨

**5. ç¡®å®šæ€§ä¿è¯**
- âœ… è®¾ç½®random/numpy/torchç§å­ï¼ˆrandom.seed, np.random.seed, torch.manual_seedï¼‰
- âœ… ç¡®ä¿ç›¸åŒè¾“å…¥å¤šæ¬¡è¿è¡Œç»“æœå“ˆå¸Œä¸€è‡´

**6. signalså¥‘çº¦ç»Ÿä¸€**
- âœ… SQLiteæ–‡ä»¶åå›ºå®šä¸ºsignals.sqlite
- âœ… gatingå­—æ®µä¸ºgating_json TEXTå­˜å‚¨JSONæ•°ç»„
- âœ… JSONL/SQLiteè¯»å–æ—¶æ­£ç¡®è§£ægatingä¸ºæ•°ç»„æ ¼å¼

**7. pnl_dailyåˆ‡æ—¥æŒ‰æ—¶åŒºèšåˆ**
- âœ… --tzé»˜è®¤Asia/Tokyo
- âœ… pnl_dailyæŒ‰æŒ‡å®šæ—¶åŒºç¡®å®šäº¤æ˜“æ—¥æœŸ
- âœ… åŒ…å«win_rateå’Œavg_hold_secå­—æ®µè®¡ç®—

**8. æ‰‹ç»­è´¹å•ä½å¯¹é½**
- âœ… fee_bps_makeré»˜è®¤-25ï¼Œfee_bps_takeré»˜è®¤75ï¼ˆbpså•ä½ï¼‰
- âœ… ä¸backtest.yamlé…ç½®ç¤ºä¾‹å®Œå…¨ä¸€è‡´

**9. ç­‰ä»·æ€§æ ¡éªŒå™¨**
- âœ… scripts/compare_backtest_equivalence.py
- âœ… pnl sumè¯¯å·® â‰¤ 1e-8ï¼Œtradesæ¡æ•°å·® â‰¤ 5%
- âœ… äº§ç‰©Schemaå®Œå…¨ä¸€è‡´éªŒè¯

**10. Aæ¨¡å¼çœŸå®CoreAlgorithmè®¡ç®—**
- âœ… æ¥å…¥çœŸå®CoreAlgorithmè€Œémockä¿¡å·
- âœ… null sinké…ç½®ï¼Œå†…å­˜è®¡ç®—ä¸è½ç›˜
- âœ… å¼‚å¸¸å›é€€æœºåˆ¶ä¿æŒç³»ç»Ÿç¨³å®šæ€§
- âœ… gatingæ•°ç»„æ ¼å¼å¥‘çº¦ä¿è¯

**11. pnl_dailyæ—¶åŒºæ—¥åˆ‡èšåˆ**
- âœ… åŸºäºé—­åˆè…¿çš„çœŸå®PnLè®¡ç®—
- âœ… é€symbolæŒä»“ç°¿ç®¡ç†ï¼ˆFIFO lotsï¼‰
- âœ… æŒ‰close_ts + TZè¿›è¡Œæ—¥åˆ‡åˆ†ç»„
- âœ… win_rateåŸºäºç›ˆåˆ©è…¿æ¯”ä¾‹è®¡ç®—
- âœ… avg_hold_secåŸºäºå®é™…æŒä»“æ—¶é—´

**12. progress_pctå¯è®¡ç®—**
- âœ… æ·»åŠ _estimate_jsonl_signalsé¢„ä¼°å‡½æ•°
- âœ… Bæ¨¡å¼ä¸‹å®æ—¶è®¡ç®—ç¬¦åˆè¿‡æ»¤æ¡ä»¶çš„ä¿¡å·æ•°é‡
- âœ… Aæ¨¡å¼ä¸‹é¿å…è¯¯å¯¼ï¼ˆè®¾ä¸º0ï¼‰

**13. ä»·æ ¼æ¥æºçº¦æŸ**
- âœ… ä¿¡å·å¿…é¡»å«mid_px/priceå­—æ®µ
- âœ… æ— ä»·æ ¼æ—¶è·³è¿‡äº¤æ˜“ï¼ˆåˆç†çº¦æŸï¼‰
- âœ… é…ç½®åŒ–price_fieldså­—æ®µä¼˜å…ˆçº§

**14. ç¡®å®šæ€§ä¿è¯**
- âœ… scripts/check_backtest_determinism.py
- âœ… è®¡ç®—äº§ç‰©æ–‡ä»¶å“ˆå¸Œä¸€è‡´æ€§
- âœ… æ”¯æŒå¤šè¿è¡Œç›®å½•å¯¹æ¯”

**15. ç‰¹å¾è¯»å–ç¡®å®šæ€§**
- âœ… æ”¹ä¸ºæŒ‰æ–‡ä»¶åæ’åºè€Œémtime
- âœ… é¿å…æ–‡ä»¶ç³»ç»Ÿæ—¶é—´æˆ³å¯¼è‡´çš„éç¡®å®šæ€§

**16. æ–°å¢E2Eæ·±åº¦éªŒè¯**
- âœ… test_mode_b_no_signals_file_and_gating_arrayï¼šBæ¨¡å¼ä¸äº§signalsæ–‡ä»¶ + gatingæ•°ç»„æ ¼å¼
- âœ… test_mode_a_b_equivalence_thresholdsï¼šA/Bæ¨¡å¼ç­‰ä»·æ€§é˜ˆå€¼æ ¡éªŒï¼ˆÎ”pnl â‰¤ 1e-8ï¼ŒÎ”trades â‰¤ 5%ï¼‰

**17. P1æ€§èƒ½ä¸ç¨³å¥æ€§ä¼˜åŒ–**
- âœ… è·¨å¹³å°Gitä¿¡æ¯é‡‡é›†ï¼šsubprocess.runæ›¿ä»£os.popenï¼Œé¿å…Linux NULæ–‡ä»¶é—®é¢˜
- âœ… featuresè¯»å–æ€§èƒ½ï¼šiterrowsâ†’itertuplesï¼Œæå‡å¤§æ–‡ä»¶å¤„ç†æ€§èƒ½
- âœ… SQLiteç¨³å¥æ€§ï¼šç¡®ä¿gatingå­—æ®µæ€»æ˜¯å­˜åœ¨ï¼Œé¿å…KeyError
- âœ… å¿ƒè·³å¯è¯»æ€§ï¼šphaseæ‹†åˆ†ä¸ºsignalsâ†’brokerï¼Œæ›´æ¸…æ™°çš„å¤„ç†é˜¶æ®µ

**18. æœ€ç»ˆP0æ”¶å£**
- âœ… Mode-Aç‰¹å¾å®Œæ•´æ€§ï¼šé»˜è®¤è¯»å–å…¨åˆ—ï¼Œé¿å…CoreAlgorithmç‰¹å¾ç¼ºå¤±
- âœ… fallbackä¿¡å·run_idä¸€è‡´æ€§ï¼šé€šè¿‡æ„é€ å‡½æ•°ä¼ é€’run_idï¼Œç¡®ä¿æº¯æºå­—æ®µç»Ÿä¸€
- âœ… configå‚æ•°æ³¨å…¥ä¿®å¤ï¼šBacktestAdapteræ„é€ å‡½æ•°æ¥æ”¶configå‚æ•°ï¼Œiter_featuresä½¿ç”¨self.config

**20. æœ€ç»ˆP1ä¼˜åŒ–**
- âœ… fee_amounté€æ˜åŒ–ï¼šBrokerSimulatorç›´æ¥å†™å…¥fee_absï¼Œä¾¿äºå®¡è®¡
- âœ… daily_statsæ¸…ç†ï¼šç§»é™¤æœªä½¿ç”¨çš„turnover/tradesé”®ï¼Œé¿å…æ··æ·†

**22. æœ€ç»ˆP0/P1æ”¶å£**
- âœ… closed_legs fee_abså˜é‡ä¿®å¤ï¼šä½¿ç”¨trade["fee_abs"]æ›¿ä»£æœªå®šä¹‰å˜é‡
- âœ… è´¹ç”¨åˆ†é…æ›´è´´è¿‘å®ç›˜ï¼šå¼€ä»“è´¹ç”¨åˆ†æ‘Šåˆ°é—­åˆè…¿ï¼Œæé«˜pnl_daily.feeså‡†ç¡®æ€§
- âœ… CoreAlgorithmå¯¼å…¥ç¨³å¥æ€§ï¼šImportErroræ—¶ä¹Ÿèµ°fallbacké€»è¾‘ï¼ˆéstrictæ¨¡å¼ï¼‰

**23. ç¨³å¥æ€§å¾®è°ƒä¼˜åŒ–**
- âœ… Mode-Bå¯é€‰é‡å‘signalsï¼šæ–°å¢--reemit-signalså‚æ•°ï¼Œä¾¿äºå¯¹è´¦/æŠ½æ£€
- âœ… SQLiteä¿¡å·å”¯ä¸€æ€§ï¼šæ·»åŠ å¤åˆå”¯ä¸€é”®(ts_ms,symbol,signal_id)ï¼Œè‡ªåŠ¨ç”Ÿæˆç¨³å®šsignal_id
- âœ… æ‰‹ç»­è´¹å£å¾„æ˜ç¡®ï¼šæ³¨é‡Šè¯´æ˜feesä¸ºå‡€é¢ï¼ˆmakerè¿”ä½£ä¸ºæ­£ï¼Œtakeræˆæœ¬ä¸ºè´Ÿï¼‰

**21. P0å¥‘çº¦çº§æ”¶å£**
- âœ… pnl_daily.turnoveræ’ä¸º0ï¼šä¿®å¤ä¸ºæŒ‰æˆäº¤æ—¶é—´åˆ‡æ—¥ç´¯è®¡turnover
- âœ… progress_pctæ¨¡å¼Aæ’ä¸º0ï¼šæ·»åŠ featuresæ–‡ä»¶æ•°Ã—10000è¿‘ä¼¼ä¼°ç®—
- âœ… progress_pctæ¨¡å¼Bä»…JSONLï¼šæ·»åŠ SQLite://è¿›åº¦é¢„ä¼°æ”¯æŒ
- âœ… CoreAlgorithmå›é€€ç ´åç­‰ä»·æ€§ï¼šæ·»åŠ --strict-coreå¼€å…³ï¼Œé»˜è®¤ä»å›é€€ä¾¿äºæ’éšœ
- âœ… manifest.effective_configæœªä½“ç°CLIï¼šä¿®å¤ä¸ºæ­£ç¡®åæ˜ CLIè¦†ç›–å€¼
- âœ… pnl_daily.trades/legsè¯­ä¹‰ä¸æ¸…ï¼šåŒºåˆ†trades=æˆäº¤ç¬”æ•°ã€legs=é—­åˆè…¿æ•°
- âœ… Gitå¿«ç…§ç¼ºå¤±ï¼šæ·»åŠ git rev-parse HEADä¸status --porcelainåˆ°manifest

### ğŸ“Š ä¿®å¤éªŒè¯ç»“æœ

**æµ‹è¯•è¦†ç›–**: 21 passed âœ…
- å•å…ƒæµ‹è¯•: 9é¡¹
- é›†æˆæµ‹è¯•: 3é¡¹
- E2Eæµ‹è¯•: 9é¡¹ï¼ˆå«5é¡¹æ·±åº¦éªŒè¯æµ‹è¯•ï¼‰

**æ–°å¢å·¥å…·**:
- âœ… ç­‰ä»·æ€§å¯¹æ¯”è„šæœ¬: scripts/compare_backtest_equivalence.py
- âœ… ç¡®å®šæ€§æ ¡éªŒè„šæœ¬: scripts/check_backtest_determinism.py

**æ ¸å¿ƒåŠŸèƒ½éªŒè¯**:
- âœ… Aæ¨¡å¼çœŸå®CoreAlgorithmè®¡ç®—ï¼ˆémockï¼‰
- âœ… pnl_dailyæ—¶åŒºæ—¥åˆ‡èšåˆï¼ˆåŸºäºé—­åˆè…¿ï¼‰
- âœ… progress_pctåŠ¨æ€è®¡ç®—ï¼ˆéæ’0ï¼‰
- âœ… ä»·æ ¼æ¥æºçº¦æŸéªŒè¯
- âœ… gatingå­—æ®µä¸ºæ•°ç»„æ ¼å¼
- âœ… Bæ¨¡å¼ä¸äº§ç”Ÿsignalsæ–‡ä»¶ï¼ˆE2EéªŒè¯ï¼‰
- âœ… A/Bæ¨¡å¼ç­‰ä»·æ€§é˜ˆå€¼æ ¡éªŒï¼ˆÎ”pnl â‰¤ 1e-8ï¼ŒÎ”trades â‰¤ 5%ï¼‰

---

**TASK-B2 P0æ·±åº¦ä¿®å¤å®Œæˆï¼** ğŸ‰

å·²é€šè¿‡æ·±åº¦å®¡æ ¸åé¦ˆä¿®å¤æ‰€æœ‰å…³é”®é—®é¢˜ï¼Œç³»ç»Ÿç°å·²è¾¾åˆ°ç”Ÿäº§çº§ç­‰ä»·æ€§ã€å¥‘çº¦åˆè§„æ€§å’Œæ€§èƒ½è¦æ±‚ã€‚