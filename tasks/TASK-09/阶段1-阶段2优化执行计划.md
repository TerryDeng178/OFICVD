# TASK-09 阶段1-阶段2优化执行计划

**创建时间**: 2025-11-10  
**版本**: v2.1

---

## 概述

本计划分为两个阶段，逐步优化策略参数，提升胜率和净收益。

---

## 阶段1：稳胜率 + 控回撤

### 目标
- **win_rate ↑**: 提升胜率
- **max_drawdown ↔/↓**: 控制或降低最大回撤
- **cost_ratio_notional ↓**: 降低成交额口径成本占比

### 搜索空间

```json
{
  "fusion.weak_signal_threshold": [0.30, 0.32, 0.35],
  "fusion.consistency.min_consistency": [0.25, 0.28, 0.30, 0.32, 0.35],
  "fusion.thresholds.active.buy": [0.8, 0.85, 0.9],
  "fusion.thresholds.active.sell": [-0.9, -0.85, -0.8],
  "fusion.adaptive_cooldown_k": [0.10, 0.12, 0.15, 0.18, 0.20],
  "fusion.flip_rearm_margin": [0.10, 0.12, 0.15, 0.18, 0.20],
  "backtest.min_hold_time_sec": [90, 120, 150]
}
```

### 约束条件

1. **min_hold_time_sec ≥ 90**: 最小持有时长硬下限 ≥90s
2. **A_H/Q_H场景更严**: 买入/卖出阈值 +1档（更严格）
   - A_H: buy [0.85, 0.9, 0.95], sell [-0.95, -0.9, -0.85]
   - Q_H: buy [0.85, 0.9, 0.95], sell [-0.95, -0.9, -0.85]

### 评分权重

```json
{
  "win_rate": 0.4,
  "max_drawdown": 0.3,
  "cost_ratio_notional": 0.3
}
```

### 执行命令

```powershell
# 阶段1优化（网格搜索）
python scripts/run_stage1_optimization.py `
  --config config/backtest.yaml `
  --search-space tasks/TASK-09/search_space_stage1.json `
  --date 2025-11-09 `
  --symbols BTCUSDT,ETHUSDT `
  --method grid `
  --max-workers 4

# 或随机搜索（更快）
python scripts/run_stage1_optimization.py `
  --config config/backtest.yaml `
  --search-space tasks/TASK-09/search_space_stage1.json `
  --date 2025-11-09 `
  --symbols BTCUSDT `
  --method random `
  --max-trials 50 `
  --max-workers 4 `
  --early-stop-rounds 10
```

### 预期结果

- 胜率提升（目标：≥15%）
- 最大回撤控制（目标：≤20%）
- 成交额口径成本占比降低（目标：≤1%）

---

## 阶段2：提收益 + 控成本

### 目标
- **net_pnl ↑**: 提升净收益
- **pnl_per_trade ↑**: 提升每笔交易收益
- **频次恢复到目标**: 每小时交易数在目标范围[0.8, 1.2]

### 搜索空间

```json
{
  "fusion.burst_coalesce_ms": [0, 100, 200, 300],
  "backtest.min_hold_time_sec": [60, 90, 120]
}
```

### 约束条件

1. **A_L/Q_L场景略松**: 买入/卖出阈值 -1档（略宽松）
   - A_L: buy [0.6, 0.65, 0.7], sell [-0.7, -0.65, -0.6]
   - Q_L: buy [0.6, 0.65, 0.7], sell [-0.7, -0.65, -0.6]
2. **trades_per_hour目标范围**: [0.8, 1.2]（需要quantile阈值校准，A.2功能）

### 评分权重

```json
{
  "net_pnl": 0.3,
  "pnl_per_trade": 0.3,
  "trades_per_hour": 0.2,
  "cost_ratio_notional": 0.2
}
```

**注意**: `trades_per_hour` 权重包含区间惩罚，超出目标范围[0.8, 1.2]时会被惩罚。

### 执行命令

```powershell
# 阶段2优化（建议使用阶段1的最佳配置作为基础）
python scripts/run_stage2_optimization.py `
  --config runtime/optimizer/stage1_*/recommended_config.yaml `
  --search-space tasks/TASK-09/search_space_stage2.json `
  --date 2025-11-09 `
  --symbols BTCUSDT,ETHUSDT `
  --method random `
  --max-trials 50 `
  --max-workers 4 `
  --early-stop-rounds 10
```

### 预期结果

- 净收益提升（目标：>0）
- 每笔交易收益提升（目标：>0）
- 交易频次在目标范围（0.8-1.2笔/小时/品种）

---

## 执行流程

### 1. 准备阶段

```powershell
# 确认数据可用
python scripts/replay_harness.py `
  --input deploy/data/ofi_cvd `
  --date 2025-11-09 `
  --symbols BTCUSDT `
  --minutes 60 `
  --config config/backtest.yaml `
  --output runtime/backtest/test

# 查看回测结果
python scripts/generate_report.py --run runtime/backtest/test
```

### 2. 阶段1优化

```powershell
# 运行阶段1优化
python scripts/run_stage1_optimization.py `
  --config config/backtest.yaml `
  --search-space tasks/TASK-09/search_space_stage1.json `
  --date 2025-11-09 `
  --symbols BTCUSDT `
  --method grid `
  --max-workers 4

# 查看阶段1结果
# CSV对比表: runtime/optimizer/stage1_*/trial_results.csv
# 推荐配置: runtime/optimizer/stage1_*/recommended_config.yaml
```

### 3. 阶段2优化

```powershell
# 使用阶段1的最佳配置作为基础
python scripts/run_stage2_optimization.py `
  --config runtime/optimizer/stage1_*/recommended_config.yaml `
  --search-space tasks/TASK-09/search_space_stage2.json `
  --date 2025-11-09 `
  --symbols BTCUSDT `
  --method random `
  --max-trials 50 `
  --max-workers 4 `
  --early-stop-rounds 10

# 查看阶段2结果
# CSV对比表: runtime/optimizer/stage2_*/trial_results.csv
# 推荐配置: runtime/optimizer/stage2_*/recommended_config.yaml
```

### 4. 验证最佳配置

```powershell
# 使用阶段2的最佳配置运行完整回测
python scripts/replay_harness.py `
  --input deploy/data/ofi_cvd `
  --date 2025-11-09 `
  --symbols BTCUSDT,ETHUSDT,SOLUSDT `
  --config runtime/optimizer/stage2_*/recommended_config.yaml `
  --output runtime/backtest/final

# 生成详细报表
python scripts/generate_report.py --run runtime/backtest/final
```

---

## 注意事项

1. **阶段1必须先完成**: 阶段2依赖阶段1的最佳配置
2. **数据一致性**: 两个阶段使用相同的数据日期和交易对
3. **并行化**: 建议使用 `--max-workers 4` 加速优化
4. **早停**: 随机搜索时使用 `--early-stop-rounds 10` 节省时间
5. **断点续跑**: 默认启用，中断后可继续运行

---

## 待实现功能（A.2）

**quantile阈值校准**: 锁住"每小时交易数"范围

当前阶段2的 `trades_per_hour` 约束需要手动调整阈值。A.2功能将自动根据fusion_score分布生成候选阈值，保证交易频次稳定在目标范围。

---

## 文件清单

- `tasks/TASK-09/search_space_stage1.json` - 阶段1搜索空间
- `tasks/TASK-09/search_space_stage2.json` - 阶段2搜索空间
- `scripts/run_stage1_optimization.py` - 阶段1优化脚本
- `scripts/run_stage2_optimization.py` - 阶段2优化脚本
- `tasks/TASK-09/阶段1-阶段2优化执行计划.md` - 本文件

---

**创建时间**: 2025-11-10

