# TASK-07B 单一真源验证报告

> **验证时间**: 2025-11-08  
> **状态**: ✅ **单一真源验证通过**

---

## 1. 验证目标

**P2工程化任务**: 消除多版本漂移（单一真源）

**目标**:
1. 确保SqliteSink/JsonlSink/CoreAlgorithm的实现是唯一的
2. 清理重复实现
3. 确保import路径唯一
4. 在模块导入时自检：PRAGMA table_info(signals) 缺列就迁移

---

## 2. 验证结果

### 2.1 类定义位置检查 ✅

**检查结果**:
- ✅ `SqliteSink`: 单一定义 (`src/alpha_core/signals/core_algo.py`)
- ✅ `JsonlSink`: 单一定义 (`src/alpha_core/signals/core_algo.py`)
- ✅ `CoreAlgorithm`: 单一定义 (`src/alpha_core/signals/core_algo.py`)
- ✅ `MultiSink`: 单一定义 (`src/alpha_core/signals/core_algo.py`)

**结论**: 所有关键类都只有一个定义，无重复实现。

### 2.2 Import路径检查 ✅

**预期路径**: `src/alpha_core/signals/core_algo.py`

**检查结果**:
- ✅ 预期路径存在
- ✅ 所有引用都通过标准import路径

**引用位置**:
- `mcp/signal_server/app.py`: 通过`from alpha_core.signals.core_algo import CoreAlgorithm, build_sink`

**结论**: Import路径唯一，无多版本漂移。

### 2.3 SQLite表结构检查 ✅

**检查结果**:
- ✅ 表存在
- ✅ 列数: 13列（符合统一版本）
- ✅ 列: `ts_ms, symbol, score, z_ofi, z_cvd, regime, div_type, signal_type, confirm, gating, guard_reason, run_id, created_at`
- ✅ 主键: `(run_id, ts_ms, symbol)`（符合统一版本）
- ✅ 有run_id列: ✅

**结论**: SQLite表结构符合统一版本，无多版本漂移。

### 2.4 模块导入自检 ✅

**实现**:
- ✅ 在`SqliteSink.__init__()`中添加了表结构自检逻辑
- ✅ 检查主键是否为`(run_id, ts_ms, symbol)`
- ✅ 检查必需列是否存在
- ✅ 如果不符合统一版本，自动触发迁移

**代码位置**:
- `src/alpha_core/signals/core_algo.py::SqliteSink.__init__()` (行207-283)
- `src/alpha_core/signals/core_algo.py::SqliteSink._migrate_schema_if_needed()` (行373-419)

**自检逻辑**:
```python
# P2: 自检表结构，确保符合统一版本
cursor = self.conn.cursor()
cursor.execute("PRAGMA table_info(signals)")
columns = {row[1]: row[2] for row in cursor.fetchall()}
# 检查主键、必需列和遗留id列
has_id_column = "id" in columns
has_pk_id_autoincrement = "AUTOINCREMENT" in ddl_upper
if not has_pk_run_ts_symbol or missing_columns or (has_id_column and has_pk_id_autoincrement):
    logger.warning(f"[SqliteSink] 表结构不符合统一版本，将触发迁移")
    self._migrate_schema_if_needed()
```

**结论**: 模块导入时自动检查表结构，确保符合统一版本。

---

## 3. 实施内容

### 3.1 类定义统一 ✅

**单一真源**: `src/alpha_core/signals/core_algo.py`

**包含的类**:
- `SignalSink` (抽象基类)
- `NullSink`
- `JsonlSink`
- `SqliteSink`
- `MultiSink`
- `CoreAlgorithm`
- `build_sink()` (工厂函数)

**结论**: 所有Sink和CoreAlgorithm实现都在单一文件中，无重复版本。

### 3.2 Import路径统一 ✅

**标准Import路径**:
```python
from alpha_core.signals.core_algo import CoreAlgorithm, build_sink
```

**使用位置**:
- `mcp/signal_server/app.py`: 唯一引用路径

**结论**: 所有引用都通过标准import路径，无多版本漂移。

### 3.3 表结构自检 ✅

**自检逻辑**:
1. 检查主键是否为`(run_id, ts_ms, symbol)`
2. 检查必需列是否存在
3. 检查是否有遗留的`id`列（AUTOINCREMENT）
4. 如果不符合统一版本，自动触发迁移
5. 验证迁移后的表结构（确保无遗留id列）

**必需列**:
- `ts_ms`, `symbol`, `score`, `signal_type`, `confirm`, `gating`, `guard_reason`, `run_id`, `created_at`

**结论**: 模块导入时自动检查表结构，确保符合统一版本。

---

## 4. 验证工具

### 4.1 创建验证脚本 ✅

**脚本**: `scripts/verify_single_source.py`

**功能**:
1. 查找类定义位置（检查是否有重复定义）
2. 检查import路径（确保使用标准路径）
3. 检查SQLite表结构（验证是否符合统一版本）

**使用方法**:
```bash
python scripts/verify_single_source.py
```

**输出**:
- 类定义位置检查
- Import路径检查
- SQLite表结构检查
- 总结（通过/失败）

---

## 5. 验收标准检查

### 5.1 DoD验收清单

- ✅ 单一SqliteSink/JsonlSink实现对外可见（无重复版本）
- ✅ 所有类定义都在`src/alpha_core/signals/core_algo.py`
- ✅ 所有引用都通过标准import路径
- ✅ 模块导入时自检表结构，确保符合统一版本
- ✅ SQLite表结构符合统一版本（(run_id, ts_ms, symbol)主键）

### 5.2 关键成果

1. ✅ **类定义统一**: 所有关键类都只有一个定义
2. ✅ **Import路径统一**: 所有引用都通过标准路径
3. ✅ **表结构统一**: SQLite表结构符合统一版本
4. ✅ **自检机制**: 模块导入时自动检查表结构

---

## 6. 代码变更

### 6.1 修改的文件

1. **src/alpha_core/signals/core_algo.py**
   - `SqliteSink.__init__()`: 添加表结构自检逻辑

2. **scripts/verify_single_source.py** (新建)
   - 单一真源验证脚本

### 6.2 关键变更

- **表结构自检**: 在`SqliteSink.__init__()`中添加自检逻辑
- **验证脚本**: 创建`verify_single_source.py`用于持续验证

---

## 7. 总结

### 7.1 验证结果

- **类定义**: ✅ 单一真源（无重复版本）
- **Import路径**: ✅ 统一路径（无多版本漂移）
- **表结构**: ✅ 统一版本（(run_id, ts_ms, symbol)主键）
- **自检机制**: ✅ 模块导入时自动检查

### 7.2 验证结论

1. ✅ **单一真源验证通过**: 所有关键类都只有一个定义
2. ✅ **Import路径统一**: 所有引用都通过标准路径
3. ✅ **表结构统一**: SQLite表结构符合统一版本
4. ✅ **自检机制完善**: 模块导入时自动检查表结构

### 7.3 下一步

1. ✅ **单一真源验证**: 已完成
2. ✅ **表结构自检**: 已实现
3. ✅ **验证脚本**: 已创建

---

**报告生成时间**: 2025-11-08  
**最后更新**: 2025-11-08  
**实施者**: Cursor AI Assistant

