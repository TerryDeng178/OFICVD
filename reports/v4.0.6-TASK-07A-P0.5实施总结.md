# P0.5 上线前"最后一跳"实施总结

**实施时间**: 2025-11-09  
**状态**: ✅ 参数提示功能已完成，待执行验证测试

---

## 一、实施内容

### 1.1 参数提示功能 ✅

#### JsonlSink启动日志
**位置**: `src/alpha_core/signals/core_algo.py:128`

**实现**:
```python
# P0.5: 启动时打印最终生效的fsync策略，便于复现与比对
logger.info(f"[JsonlSink] fsync策略: every_n={self.fsync_every_n}（每{self.fsync_every_n}次写入执行一次fsync）")
```

**效果**: 启动时打印fsync频率配置

---

#### SqliteSink启动日志
**位置**: `src/alpha_core/signals/core_algo.py:220`

**实现**:
```python
# P0.5: 启动时打印最终生效的批量参数，便于复现与比对
logger.info(f"[SqliteSink] 批量参数: batch_n={batch_n}, flush_ms={flush_ms}ms")
```

**效果**: 启动时打印批量提交参数

---

#### Reporter启动配置快照
**位置**: `orchestrator/run.py:1151-1168`

**实现**:
- 打印所有关键环境变量（V13_SINK、SQLITE_BATCH_N、SQLITE_FLUSH_MS、FSYNC_EVERY_N、TIMESERIES_*等）
- 格式化输出，便于查看和比对

**效果**: 启动时打印完整的配置快照

---

#### 时序库健康检查警告增强
**位置**: `orchestrator/run.py:1212-1227, 1093-1095`

**实现**:
- 连接失败时记录警告信息到`_timeseries_health_warning`
- 在`generate_report`中将警告添加到`warnings`字段

**效果**: 时序库连接问题会在日报中显示，便于诊断

---

## 二、创建的脚本和文档

### 2.1 上线前检查清单 ✅
**文件**: `reports/v4.0.6-TASK-07A-上线前检查清单.md`

**内容**:
- P0.5验证步骤（时序库导出、60分钟Soak Test、参数快照）
- 验收标准
- 风险与关注点

---

### 2.2 P0.5验证脚本 ✅
**文件**: `scripts/run_p0p5_verification.ps1`

**功能**:
- 支持时序库导出验证（10分钟）
- 支持60分钟Soak Test
- 自动验证数据一致性
- 检查run_manifest结果

**用法**:
```powershell
# 时序库导出验证
.\scripts\run_p0p5_verification.ps1 -TestType timeseries -TimeseriesUrl http://localhost:9091 -Minutes 10

# 60分钟Soak Test
.\scripts\run_p0p5_verification.ps1 -TestType soak -Minutes 60
```

---

### 2.3 环境变量快照脚本 ✅
**文件**: `scripts/save_env_snapshot.ps1`

**功能**:
- 收集所有关键环境变量
- 保存为JSON格式
- 与run_manifest一起归档

**用法**:
```powershell
.\scripts\save_env_snapshot.ps1 -RunId <RUN_ID>
```

---

## 三、待执行验证

### 3.1 时序库导出验证 ⏳
**状态**: 待执行

**步骤**:
1. 配置TIMESERIES_URL（Pushgateway或InfluxDB）
2. 运行10分钟测试
3. 验证`export_count` > 0且`error_count` = 0
4. 验证时序库侧数据可见

**验收标准**:
- [ ] `export_count` ≥ 确认信号量
- [ ] `error_count` = 0
- [ ] `timeseries_data`字段完整
- [ ] 时序库侧数据可见

---

### 3.2 60分钟Soak Test ⏳
**状态**: 待执行

**步骤**:
1. 运行60分钟测试
2. 监控SQLite WAL文件大小
3. 验证数据一致性（parity check）
4. 检查吞吐和丢包情况

**验收标准**:
- [ ] JSONL vs SQLite差异 < 0.25%
- [ ] SQLite WAL不无限增大
- [ ] WAL checkpoint在关闭时触发
- [ ] 无丢包（dropped = 0）
- [ ] 吞吐稳定

---

### 3.3 参数快照 ⏳
**状态**: 待执行

**步骤**:
1. 运行测试后执行快照脚本
2. 归档env_snapshot、run_manifest、source_manifest

---

## 四、代码变更清单

### 4.1 修改的文件

1. **src/alpha_core/signals/core_algo.py**
   - JsonlSink.__init__: 添加fsync策略日志
   - SqliteSink.__init__: 添加批量参数日志

2. **orchestrator/run.py**
   - Reporter.__init__: 添加`_print_startup_config()`调用
   - Reporter._print_startup_config(): 新增方法，打印配置快照
   - Reporter._check_timeseries_health(): 增强错误处理，记录警告
   - Reporter.generate_report(): 添加时序库健康检查警告到warnings

### 4.2 新增的文件

1. **reports/v4.0.6-TASK-07A-上线前检查清单.md**
2. **scripts/run_p0p5_verification.ps1**
3. **scripts/save_env_snapshot.ps1**

---

## 五、验证结果（待执行）

### 5.1 参数提示功能验证
- [ ] 启动日志包含JsonlSink fsync策略
- [ ] 启动日志包含SqliteSink批量参数
- [ ] 启动日志包含Reporter配置快照
- [ ] 时序库健康检查失败时，警告出现在日报warnings中

### 5.2 时序库导出验证
- [ ] 待执行

### 5.3 60分钟Soak Test验证
- [ ] 待执行

---

## 六、下一步行动

1. **执行时序库导出验证**
   ```powershell
   .\scripts\run_p0p5_verification.ps1 -TestType timeseries -TimeseriesUrl <URL> -Minutes 10
   ```

2. **执行60分钟Soak Test**
   ```powershell
   .\scripts\run_p0p5_verification.ps1 -TestType soak -Minutes 60
   ```

3. **保存参数快照**
   ```powershell
   .\scripts\save_env_snapshot.ps1 -RunId <RUN_ID>
   ```

4. **更新上线前检查清单**
   - 填写执行记录
   - 确认所有验收标准通过

---

**实施完成时间**: 2025-11-09  
**实施人员**: AI Assistant  
**审核状态**: 待审核

