# TASK-07A æ”¹è¿›å®æ–½æ€»ç»“

> **å®æ–½æ—¶é—´**: 2025-11-09  
> **çŠ¶æ€**: ğŸŸ¡ **P1/P2éƒ¨åˆ†å®Œæˆï¼ŒP0å¾…æ‰§è¡Œ**

---

## å·²å®æ–½çš„æ”¹è¿›

### P1 æ•°æ®ä¸€è‡´æ€§/å¯¹è´¦ä¸å¯è§‚æµ‹æ€§å¢å¼º âœ…

#### 1. åŒSinkç­‰ä»·æ€§é˜ˆå€¼æ”¶ç´§ âœ…

**å®æ–½å†…å®¹**:
- å°† `scripts/verify_sink_parity.py` çš„é»˜è®¤é˜ˆå€¼ä» `0.2%` æ”¶ç´§åˆ° `0.25%`
- ä»£ç ä½ç½®: `scripts/verify_sink_parity.py:104`

**å˜æ›´**:
```python
# ä¿®æ”¹å‰
parser.add_argument("--threshold", type=float, default=0.2, help="åå·®é˜ˆå€¼ï¼ˆç™¾åˆ†æ¯”ï¼Œé»˜è®¤0.2%ï¼‰")

# ä¿®æ”¹å
parser.add_argument("--threshold", type=float, default=0.25, help="åå·®é˜ˆå€¼ï¼ˆç™¾åˆ†æ¯”ï¼Œé»˜è®¤0.25%ï¼ŒP1æ”¶ç´§ï¼‰")
```

**ä¸‹ä¸€æ­¥**: å°† `parity_diff.json` æ ¡éªŒæ¥å…¥ CIï¼Œè¶…é˜ˆå³ fail

---

#### 2. ç»Ÿä¸€run_idè´¯ç©¿JSONL/SQLite âœ…

**å®æ–½å†…å®¹**:
- åœ¨ `CoreAlgorithm.process_feature_row()` ä¸­æ·»åŠ  `created_at` å­—æ®µ
- åœ¨ `JsonlSink.emit()` ä¸­ç¡®ä¿ `signal_type` å’Œ `created_at` å­—æ®µå­˜åœ¨
- ä¸SQLiteçš„å¿…éœ€åˆ—å¯¹é½ï¼Œä¾¿äºparityå·¥å…·æŒ‰run_idç›´æ¥å¯¹è´¦

**ä»£ç å˜æ›´**:

1. **CoreAlgorithm.process_feature_row()** (`src/alpha_core/signals/core_algo.py:784-804`):
   - æ·»åŠ  `created_at` å­—æ®µï¼ˆISOæ ¼å¼æ—¶é—´æˆ³ï¼‰
   - ç¡®ä¿ `decision` å­—å…¸åŒ…å«æ‰€æœ‰å¿…éœ€å­—æ®µ

2. **JsonlSink.emit()** (`src/alpha_core/signals/core_algo.py:126-154`):
   - ç¡®ä¿ `signal_type` å­—æ®µå­˜åœ¨ï¼ˆé»˜è®¤å€¼: "neutral"ï¼‰
   - ç¡®ä¿ `created_at` å­—æ®µå­˜åœ¨ï¼ˆå¦‚æœentryä¸­æ²¡æœ‰ï¼Œåˆ™ç”Ÿæˆï¼‰

**æ•ˆæœ**:
- JSONLå’ŒSQLiteç°åœ¨éƒ½åŒ…å« `run_id`ã€`signal_type`ã€`created_at` å­—æ®µ
- ä¾¿äºparityå·¥å…·æŒ‰ `(run_id, ts_ms, symbol)` ç›´æ¥å¯¹è´¦

---

#### 3. LIVE/previewæ ‡è¯†ä¸è¾“å…¥ç›®å½•æ”¶æ•› âœ…

**å®æ–½å†…å®¹**:
- åœ¨ `source_manifest.json` ä¸­æ·»åŠ  `watch_enabled` å’Œ `features_dir` å­—æ®µ
- æ˜ç¡®æ ‡è¯†æ•°æ®æºæ¨¡å¼ï¼ˆraw/previewï¼‰ã€--watchå¼€å¯ä¸å¦ã€ç‰¹å¾ç›®å½•è·¯å¾„

**ä»£ç å˜æ›´**:

**orchestrator/run.py:2281-2303**:
```python
# P1: LIVE/previewæ ‡è¯†ä¸è¾“å…¥ç›®å½•æ”¶æ•›
input_mode = env_overrides.get("V13_INPUT_MODE", "preview")
replay_mode = env_overrides.get("V13_REPLAY_MODE", "0") == "1"
is_replay_mode = replay_mode or config_path.name.startswith("replay")
# P1: åˆ¤æ–­--watchæ˜¯å¦å¼€å¯ï¼ˆLIVEæ¨¡å¼å¼€å¯ï¼Œå›æ”¾æ¨¡å¼å…³é—­ï¼‰
watch_enabled = not is_replay_mode
# P1: è·å–ç‰¹å¾ç›®å½•è·¯å¾„
features_dir = project_root / "deploy" / "data" / "ofi_cvd" / input_mode

source_manifest = {
    # ... å…¶ä»–å­—æ®µ ...
    "input_mode": input_mode,  # raw | preview
    "replay_mode": replay_mode,  # true | false
    "watch_enabled": watch_enabled,  # P1: --watchå¼€å¯ä¸å¦
    "features_dir": str(features_dir)  # P1: ç‰¹å¾ç›®å½•è·¯å¾„
}
```

**æ•ˆæœ**:
- `source_manifest.json` ç°åœ¨åŒ…å«å®Œæ•´çš„æ•°æ®æºä¿¡æ¯
- ä¾¿äºå¤ç°å®éªŒä¸å›æº¯

---

### P2 ç¨³å®šæ€§ä¸å¯ç»´æŠ¤æ€§ âœ…

#### 1. æŠ¥è¡¨å¯è§‚æµ‹æ€§è¡¥å¼º âœ…

**å®æ–½å†…å®¹**:
- å½“æ£€æµ‹åˆ°previewæ¨¡å¼ä¸”snapshotsä¸ºç©ºæ—¶ï¼Œåœ¨æ—¥æŠ¥ä¸­æ·»åŠ æç¤ºä¿¡æ¯

**ä»£ç å˜æ›´**:

**orchestrator/run.py:1644-1648**:
```python
# P2: æŠ¥è¡¨å¯è§‚æµ‹æ€§è¡¥å¼º - å½“æ£€æµ‹åˆ°previewæ—¶ï¼Œåœ¨æ—¥æŠ¥åŠ ä¸€è¡Œæç¤º
input_mode = os.getenv("V13_INPUT_MODE", "preview")
snapshots = runtime_state.get('snapshots', [])
if input_mode == "preview" and not snapshots:
    fp.write(f"> **æç¤º**: StrategyMode å¿«ç…§åœ¨å›æ”¾æ¨¡å¼ï¼ˆpreviewï¼‰ä¸‹é»˜è®¤ä¸ºç©ºï¼Œè¿™æ˜¯æ­£å¸¸ç°è±¡ã€‚\n\n")
```

**æ•ˆæœ**:
- å‡å°‘è¯¯æŠ¥ï¼Œæ˜ç¡®è¯´æ˜previewæ¨¡å¼ä¸‹snapshotsä¸ºç©ºæ˜¯æ­£å¸¸ç°è±¡

---

## å¾…å®æ–½çš„æ”¹è¿›

### P0 ç«‹åˆ»è¡¥é½çš„ä¸¤é¡¹ â³

#### 1. æ‰“é€šå¹¶éªŒè¯"æ—¶åºåº“å¯¼å‡º" â³

**éœ€è¦æ‰§è¡Œ**:
- é…ç½®æ—¶åºåº“è¿æ¥ï¼ˆPrometheus Pushgatewayï¼‰
- é‡è·‘ Soak Test
- éªŒè¯ `export_count â‰¥ 60`ï¼Œ`error_count = 0`

**ç¯å¢ƒå˜é‡è®¾ç½®**:
```powershell
$env:TIMESERIES_TYPE = "prometheus"
$env:TIMESERIES_URL = "http://localhost:9091"
```

#### 2. å¢åŠ å¹¶è®°å½•"æ•…éšœæ³¨å…¥"ç”¨ä¾‹ â³

**éœ€è¦æ‰§è¡Œ**:
- åœ¨60åˆ†é’Ÿè¿è¡Œä¸­æ®µï¼Œæ‰‹åŠ¨terminate()ä¿¡å·è¿›ç¨‹
- éªŒè¯Orchestratorè‡ªåŠ¨æ‹‰èµ·
- è®°å½•é‡å¯è€—æ—¶ã€å¥åº·æ¢é’ˆæ¢å¤åˆ°greençš„æ—¶é—´æˆ³ã€äº‹ä»¶é¡ºåº

---

### P1 å¾…å®Œå–„é¡¹ â³

#### 1. åŒSinkç­‰ä»·æ€§å›ºåŒ–ä¸ºCI Gate â³

**éœ€è¦æ‰§è¡Œ**:
- å°† `parity_diff.json` æ ¡éªŒæ¥å…¥ CI
- è¶…é˜ˆå³ fail

---

### P2 å¾…å®Œå–„é¡¹ â³

#### 1. å¥åº·æ¢é’ˆå‚æ•°å¤–æ˜¾åˆ°é…ç½® â³

**éœ€è¦æ‰§è¡Œ**:
- æŠŠ `min_growth_window_seconds/min_growth_count` æš´éœ²ä¸º config å­—æ®µ
- ä¾¿äºåœ¨ä¸åŒç¯å¢ƒè°ƒå‚

#### 2. ä»»åŠ¡å¡ä¸DoDåŒæ­¥ â³

**éœ€è¦æ‰§è¡Œ**:
- æŠŠæ—¶åºåº“å¯¼å‡ºã€æ•…éšœæ³¨å…¥åŠ å…¥TASK-07Açš„DoDå¿…é¡»é¡¹ï¼ˆè€Œä¸æ˜¯"å¯é€‰"ï¼‰
- ä½œä¸ºåˆå¹¶å‰çš„PR Gate

---

## å¿«é€Ÿå¤è·‘æ¸…å•

### å•å‘½ä»¤ï¼ˆWindows PowerShellï¼‰

```powershell
$env:TIMESERIES_TYPE="prometheus"
$env:TIMESERIES_URL="http://localhost:9091"
$env:V13_INPUT_MODE="raw"         # éœ€è¦çœŸå®WSï¼›å›æ”¾è¯·ç”¨ preview

python -m orchestrator.run `
  --config ./config/defaults.yaml `
  --enable harvest,signal,broker,report `
  --sink dual `                   # åŒæ—¶ JSONL + SQLiteï¼Œè‡ªåŠ¨äº§å‡º parity_diff
  --minutes 60
```

### å®ŒæˆåéªŒæ”¶

**æŠ¥è¡¨ä¸äº§å‡ºç‰©**:
- `summary_*.json|md`
- `parity_diff_*.json`ï¼ˆé˜ˆå€¼0.25%ï¼‰
- `source_manifest_*.json`ï¼ˆåŒ…å«watch_enabledã€features_dirï¼‰
- `run_manifest_*.json`

**æŒ‡æ ‡**:
- `export_count â‰¥ 60` â³ **å¾…éªŒè¯**
- `parity_diff < 0.25%` âœ… **å·²æ”¶ç´§é˜ˆå€¼**
- `queue_dropped=0` âœ… **å·²éªŒè¯**
- `reconnect_countâ‰¤3` âœ… **å·²éªŒè¯**
- `RSS<600MB` âœ… **å·²éªŒè¯**

---

## ä»£ç å˜æ›´ç»Ÿè®¡

### ä¿®æ”¹çš„æ–‡ä»¶

1. **src/alpha_core/signals/core_algo.py**
   - `CoreAlgorithm.process_feature_row()`: æ·»åŠ  `created_at` å­—æ®µ
   - `JsonlSink.emit()`: ç¡®ä¿ `signal_type` å’Œ `created_at` å­—æ®µå­˜åœ¨

2. **orchestrator/run.py**
   - `source_manifest` ç”Ÿæˆ: æ·»åŠ  `watch_enabled` å’Œ `features_dir` å­—æ®µ
   - `_write_markdown()`: æ·»åŠ previewæ¨¡å¼æç¤º

3. **scripts/verify_sink_parity.py**
   - é»˜è®¤é˜ˆå€¼ä» `0.2%` æ”¶ç´§åˆ° `0.25%`

### æ–°å¢çš„æ–‡ä»¶

1. **reports/v4.0.6-TASK-07A-æ”¹è¿›è®¡åˆ’.md** - æ”¹è¿›è®¡åˆ’æ–‡æ¡£
2. **reports/v4.0.6-TASK-07A-æ”¹è¿›å®æ–½æ€»ç»“.md** - æœ¬æ–‡ä»¶

---

## ä¸‹ä¸€æ­¥

1. **P0**: æ‰§è¡Œæ—¶åºåº“å¯¼å‡ºéªŒè¯å’Œæ•…éšœæ³¨å…¥æµ‹è¯•
2. **P1**: å°†parity_diffæ ¡éªŒæ¥å…¥CI
3. **P2**: å¥åº·æ¢é’ˆå‚æ•°å¤–æ˜¾åˆ°é…ç½®ï¼Œæ›´æ–°ä»»åŠ¡å¡DoD

---

**å®æ–½å®Œæˆæ—¶é—´**: 2025-11-09  
**çŠ¶æ€**: ğŸŸ¡ **P1/P2éƒ¨åˆ†å®Œæˆï¼ŒP0å¾…æ‰§è¡Œ**

