# TASK-08 改进建议清单

**审阅时间**: 2025-11-09  
**版本**: v4.0.6  
**优先级**: P1（8项）+ P2（3项）

---

## 一、已确认的进展

### ✅ 已完成项

1. ✅ 4个P1增强项均已完成并通过用例：CI双跑基线、PnL切日与时区、滑点/费用情境化、边界对齐回归测试
2. ✅ Aligner的return_1s时序错误已修正：先append当秒mid，再以prev_mid参与计算（并透传gap标志）
3. ✅ Feeder已把场景上下文（spread/vol/scenario/fee_tier/session）与对齐质量位附加到signal
4. ✅ TradeSim支持自定义时区与切日（ROLLOVER_TZ/ROLLOVER_HOUR）并在日志中可见
5. ✅ Metrics增加分多空持有时间与Pushgateway可选导出路径（方法已实现）
6. ✅ CI Gate双跑基线（enforce/ignore）与阈值比对脚本已就绪

---

## 二、P1优先级改进建议（8项）

### P1.1 Pushgateway"文档 vs 状态"彻底统一 + 真机打点验证

**问题描述**:  
"完成进度报告"仍标记Pushgateway为"待实现/待验证"，而P1验证报告里方法已实现且建议实际联通测试。

**改进动作**:
1. 在CI增加一个可选job，启动本地Pushgateway
2. 运行一次回测并断言11个backtest_*指标都成功上报
3. 失败则给出重试/错误日志快照
4. 将指南与状态在`docs/backtest_guide.md`彻底对齐

**预期产出**:
- CI job配置（`.github/workflows/pushgateway-test.yml`）
- 验证脚本（`scripts/test_pushgateway_integration.py`）
- 文档更新（统一状态描述）

**优先级**: 🔴 P1 - 高优先级

---

### P1.2 PnL切日回归测试补齐"跨月/跨年/周末/闰日/DST"边界

**问题描述**:  
目前已覆盖自定义切日与时区加载验证；建议新增基于合成样例的回归。

**改进动作**:
1. 跨自然月/跨自然年滚动测试
2. DST切换测试（America/New_York用例）
3. 周末只清仓不入场等策略化口径测试
4. 基于现有`_biz_date()`扩展用例

**预期产出**:
- 测试用例（`tests/test_pnl_rollover_boundaries.py`）
- 合成测试数据生成器

**优先级**: 🔴 P1 - 高优先级

---

### P1.3 Gate双跑基线：加"数据指纹 + 工件固化"提升可复现性

**问题描述**:  
现有CI已对比metrics与gate_reason分布并设阈值，但缺少数据指纹和工件固化。

**改进动作**:
1. 把输入数据集的(path,size,mtime)指纹（或Tar SHA1）写入基线报告
2. 输出`compare_gate_baseline.json`工件
3. 保证同一数据集下的差异可重放定位

**预期产出**:
- 数据指纹计算脚本
- 工件固化配置
- 基线报告格式更新

**优先级**: 🔴 P1 - 高优先级

---

### P1.4 情境化滑点/费用：完善"分场景校验 + 回归阈值"

**问题描述**:  
已在piecewise/tiered分支增加非法枚举兜底与告警，但缺少统计和阈值。

**改进动作**:
1. 把非法场景/费率出现比例做成Metrics（如`invalid_scenario_rate`）
2. 在CI设置上限阈值（例如<0.1%）

**预期产出**:
- Metrics新增字段（`invalid_scenario_rate`, `invalid_fee_tier_rate`）
- CI阈值检查配置

**优先级**: 🔴 P1 - 高优先级

---

### P1.5 Metrics维度细化：补全"情境/时段/会话"拆分

**问题描述**:  
目前scenario_breakdown预留但未真正填充，因为trades/signals未带足够标签。

**改进动作**:
1. 将scenario_2x2/session写入trade明细
2. 在MetricsAggregator里计算分场景胜率、RR、持仓时长
3. 辅助调参与实盘风控

**预期产出**:
- Trade记录增加字段（`scenario_2x2`, `session`）
- Metrics新增分场景统计（`scenario_breakdown`完整实现）

**优先级**: 🔴 P1 - 高优先级

---

### P1.6 边界对齐测试：引入property-based随机化生成

**问题描述**:  
已覆盖分钟边界、rotate原子性、gap秒检测，但缺少随机化测试。

**改进动作**:
1. 用Hypothesis生成"乱序/重复/缺失/跳秒"的秒级序列
2. 断言：
   - return_1s只用前一秒mid
   - is_gap_second统计自洽
   - 无重复row_id
   - 对齐计数与实际gap秒数一致

**预期产出**:
- Property-based测试用例（`tests/test_alignment_property.py`）
- Hypothesis配置

**优先级**: 🔴 P1 - 高优先级

---

### P1.7 Unix平台验证Job

**问题描述**:  
报告里标记"Unix平台待验证"。

**改进动作**:
1. 在CI matrix加入ubuntu-latest
2. 执行与Windows同款用例
3. 比较metrics差异（≤5%）

**预期产出**:
- CI matrix配置更新
- 跨平台差异报告

**优先级**: 🔴 P1 - 高优先级

---

### P1.8 Gate原因统计：与TradeSim/复盘联通

**问题描述**:  
CORE_ALGO已按心跳频率落盘gate快照；回测报告也显示gate breakdown文件已生成，但缺少复盘脚本联通。

**改进动作**:
1. 在复盘脚本中加载gate_reason_breakdown.json
2. 与最终胜率/交易数做皮尔森相关性输出
3. 直观看"哪类Gate最抑制策略表现"
4. 便于下一步阈值调参

**预期产出**:
- 复盘脚本增强（`scripts/analyze_gate_correlation.py`）
- 相关性分析报告格式

**优先级**: 🔴 P1 - 高优先级

---

## 三、P2优先级改进建议（3项）

### P2.1 Turnover口径细化

**问题描述**:  
已修正为进出双边名义金额之和；可继续细化maker/taker分项与费率等级分布。

**改进动作**:
1. 结合fee_tier细化maker/taker分项
2. 费率等级分布统计

**预期产出**:
- Metrics新增字段（`turnover_maker`, `turnover_taker`, `fee_tier_distribution`）

**优先级**: 🟡 P2 - 中优先级

---

### P2.2 可观测性补完：Aligner对齐完整度heatmap

**问题描述**:  
Aligner已新增gap_seconds/lag_bad_*计数；再加一个"每分钟对齐完整度heatmap"导出。

**改进动作**:
1. 每分钟对齐完整度heatmap（0–60s命中率）
2. 快速扫盘数据空洞

**预期产出**:
- Heatmap生成脚本
- 可视化输出（CSV/JSON格式）

**优先级**: 🟡 P2 - 中优先级

---

### P2.3 配置契约：Pydantic Schema

**问题描述**:  
把backtest.yaml定义成Pydantic Schema（含默认值/枚举校验），与环境变量映射一致。

**改进动作**:
1. 定义Pydantic Schema（含默认值/枚举校验）
2. 与环境变量映射（如ROLLOVER_TZ/HOUR, SLIPPAGE_MODEL, FEE_MODEL）一致

**预期产出**:
- Pydantic模型定义（`src/alpha_core/backtest/config_schema.py`）
- 配置验证逻辑

**优先级**: 🟡 P2 - 中优先级

---

## 四、实施优先级排序

### 立即实施（P1 - 本周）

1. **P1.1** Pushgateway真机打点验证（文档统一 + CI验证）
2. **P1.7** Unix平台验证Job（跨平台稳定性）
3. **P1.3** Gate双跑基线数据指纹（可复现性）

### 短期实施（P1 - 下周）

4. **P1.2** PnL切日回归测试（边界完整性）
5. **P1.4** 情境化滑点/费用校验阈值（质量保证）
6. **P1.5** Metrics维度细化（可观测性）

### 中期实施（P1 - 下两周）

7. **P1.6** Property-based测试（测试完整性）
8. **P1.8** Gate原因统计复盘联通（分析能力）

### 长期实施（P2 - 下月）

9. **P2.1** Turnover口径细化
10. **P2.2** Aligner对齐完整度heatmap
11. **P2.3** 配置契约Pydantic Schema

---

## 五、总体结论

**当前状态**:  
TASK-08的闭环已打通且关键P0/P1已修（回放→信号→PnL），核心功能稳定。

**下一步目标**:  
用上面8条P1建议将"产线可复现 + 复盘可解释 + 多平台稳态"补齐，即可进入稳定对比与参数迭代周期。

**预计工作量**:
- P1项：8项，预计2-3周完成
- P2项：3项，预计1周完成
- **总计**：3-4周完成所有改进

---

**报告生成时间**: 2025-11-09  
**状态**: 📋 待实施

