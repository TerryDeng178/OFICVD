# M2 冒烟测试复盘报告

> 测试日期：2025-11-06  
> 执行脚本：`scripts/m2_smoke_test.ps1`（PowerShell）

---

## 1. 测试环境与输入

- **代码基线**：TASK-05 之后的最新主干（FeaturePipe 已完成，CORE_ALGO 薄壳已合并）
- **脚本版本**：`scripts/m2_smoke_test.ps1`（含 Raw → Preview 自动兜底逻辑）
- **默认参数**：
  - 输入目录优先级：`deploy/data/ofi_cvd/raw` → `deploy/data/ofi_cvd/preview` → `deploy/data/ofi_cvd`
  - 交易对：`BTCUSDT ETHUSDT BNBUSDT SOLUSDT XRPUSDT DOGEUSDT`
  - 配置文件：`config/defaults.smoke.yaml`（冒烟专用，放宽参数以便产出少量 confirm：`weak_signal_threshold=0.08`、`consistency_min=0.05`、`quiet` 阈值 `±0.40`）
  - 输出目录：`./runtime`

- **数据概况**：
  - `deploy/data/ofi_cvd/raw`：按 `date=YYYY-MM-DD/hour=HH/symbol=<sym>/kind=<kind>` 布局，kind 包含 `prices/orderbook/aggtrade/...`
  - `deploy/data/ofi_cvd/preview`：同样按日期/小时/交易对分层，`kind=features/*.parquet` 存在 FeaturePipe 预览结果

---

## 2. 执行过程（最新）

| 步骤 | 操作 | 结果摘要 |
|------|------|----------|
| Step 1 | `python -m alpha_core.microstructure.feature_pipe --sink jsonl ...` | Raw 数据阶段生成 0 行；自动兜底 Preview，`runtime/runs/<RUN_ID>/features_<RUN_ID>.jsonl` 得到 **305,628** 行 FeatureRow（6 个交易对合计） |
| Step 1.5 | `python tools/prepend_warmup_features.py --warmup-minutes 3 ...` | 向前拼接 3 分钟 preview 历史数据作为预热引导，降低 warmup_blocked 比例 |
| Step 2 | `python tools/validate_features.py --features runtime/features.jsonl --limit 5` | 成功校验 FeatureRow 必需字段（`REQUIRED_FIELDS=['ts_ms','symbol','z_ofi','z_cvd','spread_bps','lag_sec','consistency','warmup']`），输出 "OK: validated 5 rows …" |
| Step 3 | `python -m mcp.signal_server.app --sink jsonl --out ./runtime/runs/<RUN_ID>` | CORE_ALGO 处理 **305,628** 行，统计：`processed=305628 emitted=0 suppressed=305628 deduped=0 warmup_blocked=31,755`；signal JSONL 写入 `runtime/runs/<RUN_ID>/ready/signal/*/signals_YYYYMMDD_HHMM.jsonl` 共 5,463 个分片；运行时输出吞吐 `~3,030 rows/sec`；默认使用 `config/defaults.smoke.yaml`（放宽 `weak_signal_threshold=0.08`、`consistency_min=0.05`、`quiet` 阈值 `±0.40`） |
| 汇总 | `python tools/summarize_signals.py --signal-dir runtime/runs/<RUN_ID>/ready/signal --summary-json runtime/runs/<RUN_ID>/smoke_summary.json` | 汇总与 processed 一致：`confirm=0 suppressed=gated=305,628`；各 symbol 行数 `BTCUSDT 53,059 / ETHUSDT 53,598 / BNBUSDT 48,107 / SOLUSDT 52,525 / XRPUSDT 51,575 / DOGEUSDT 46,764`；guard Top-2：`low_consistency 273,873`、`warmup 31,755`；按 symbol/regime 热度榜显示皆为 `quiet` 区间；regime 分布统计与首行样例记录已落盘；热力图输出按 `(symbol, regime)` 组合的 guard reason 分布；时间覆盖 `2025-11-05T22:28:16Z → 2025-11-06T17:59:09Z`；confirm-only 数据落盘 `ready/signal_confirm/`（无确认时为空） |
| SQLite 验证 | `python -m mcp.signal_server.app --sink sqlite --out ./runtime/runs/<RUN_ID>` | 验证 `signals.db` 的 WAL 模式与 `confirm=1` 计数，并检查最近一小时 confirm 数量，确保回放/看板可正常连接 |

> 说明：Bash 版本 `scripts/m2_smoke_test.sh` 与 PowerShell 版本共享相同的工具脚本（转换 / 校验 / 汇总），流程与结果保持一致。

---

## 3. 关键发现与指标

- **Raw 数据仍处于暖机**：FeaturePipe 在 Raw 输入上产出 0 行，自动启用 Preview fallback；后续可通过补充更活跃时段数据或调参（加速暖机）提升 Raw 覆盖率。
- **feature→signal 转换全链通**：Preview fallback 转化后的 FeatureRow 满足 CORE_ALGO 所需字段，signal sink 目录已经产生可回放的 JSONL 文件。
- **信号全部被 Guard 拦截**：本轮 305,628 行全部被 guard 拦截，Top-2 原因仍是 `low_consistency`（≈89.6%）与 `warmup`（≈10.4%）。`tools/summarize_signals.py` 现额外输出 symbol/regime 维度 Top-5、时间覆盖范围，并将结构化结果写入 `runtime/runs/<RUN_ID>/smoke_summary.json`，脚本在 confirm=0 时保持 exit=2。
- **统计口径统一**：新增工具 `tools/summarize_signals.py` 输出每个 symbol 的行数 & 样例文件，便于对比 guard 分布、后续分析。

---

## 4. 已落地优化

1. **工具化重构**
   - `tools/convert_preview_features.py`：统一从 `preview/kind=features/*.parquet` 生成符合 CORE_ALGO 契约的 JSONL，自动补齐关键字段并去除 NaN。
   - `tools/validate_features.py`：基于 `alpha_core.signals.core_algo.REQUIRED_FIELDS` 校验 FeatureRow。
   - `tools/summarize_signals.py`：新增 confirm / suppressed / gated 统计、guard_reason Top-K、symbol/regime 明细、regime 分布与按 symbol 拆分、时间覆盖、首行样例记录、热力图（按 `(symbol, regime)` 组合的 guard reason 分布）以及 `--summary-json` 导出；脚本据此控制退出码（confirm=0 → exit 2）并驱动后续 confirm-only 分流。
   - `tools/filter_confirm_signals.py`：将 `confirm=true` 的记录复制至 `ready/signal_confirm/`，方便回放/验收聚焦真实信号。
   - `tools/prepend_warmup_features.py`：向前拼接 2-5 分钟 preview 历史数据作为预热引导，降低 warmup_blocked 比例。

2. **脚本改造**
   - PowerShell / Bash 冒烟脚本全面改用上述工具，移除内嵌 Python Here-String，并默认开启 `RUN_ID` 隔离目录与 `V13_REPLAY_MODE=1`；FeaturePipe 输出重命名为 `features_<RUN_ID>.jsonl`，同时打印吞吐速率与 guard breakdown。
   - 默认使用 `config/defaults.smoke.yaml`（放宽 `weak_signal_threshold=0.08`、`consistency_min=0.05`、`quiet` 阈值 `±0.40`），便于产出少量 confirm 用于端到端验证。
   - 新增预热历史引导步骤（Step 1.5），在生成 features 文件后自动向前拼接 3 分钟 preview 历史数据。
   - 汇总阶段写出 `smoke_summary.json` 并自动派生 `ready/signal_confirm/`（仅 confirm=true），全量行为仍落在 `ready/signal/` 供调参参考。
   - 新增 SQLite sink 验证步骤，校验 WAL 模式与 `confirm=1` 计数，并检查最近一小时 confirm 数量，确保回放/看板可正常连接。

3. **输出对齐**
   - signal sink 目录结构（`runtime/ready/signal/<symbol>/signals_YYYYMMDD_HHMM.jsonl`）与汇总报告保持一致，为后续回放/归档提供直接路径。

---

## 5. 后续行动建议

- **数据侧**：补充更活跃时段的 Raw 样本或调整 FeaturePipe 暖机逻辑，争取在无需 fallback 的情况下产出有效 FeatureRow。
- **模型侧**：针对当前所有信号被 guard 拦截的情况，需复核 `consistency`、`warmup`、`threshold` 等配置，确认是否符合预期；`tools/summarize_signals.py` 已输出 regime 分布、按 symbol 拆分与热力图，便于诊断为何几乎全为 `quiet` 区间；`config/defaults.smoke.yaml` 已进一步放宽参数（`consistency_min=0.05`、`weak_signal_threshold=0.08`、`quiet` 阈值 `±0.40`），并新增预热历史引导，预期可产出少量 confirm 用于打通下游链路。
- **自动化验证**：将 `scripts/m2_smoke_test.(ps1|sh)` 纳入日常回归（如 CI / 定时任务），并归档 `runtime/runs/<RUN_ID>/smoke_summary.json`、`ready/signal_confirm/` 等指标与产物，作为可复现证据与调参参考。

> 当前结论：**链路可完整跑通**，Preview fallback + 新工具脚本已满足 TASK-05 冒烟 DoD；后续重点转向提升 Raw 数据可用性与 guard 配置调优。
