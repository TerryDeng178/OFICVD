# TASK-07A 改进计划

> **创建时间**: 2025-11-09  
> **状态**: 🟡 **进行中**  
> **优先级**: P0 > P1 > P2

---

## 核心结论

**端到端 Soak Test 已完成、关键功能与监控基本过关，但"时序库导出未验证"和"故障注入未跑"是唯一两处短板。**

---

## P0 立刻补齐的两项

### 1. 打通并验证"时序库导出"

**现状**:
- `export_count=0`，导出功能代码已接好但未配置连接，因此未计数
- 代码已实现，但需要配置时序库连接

**实施方案**:
- 按脚本的环境变量示例设置（Prometheus Pushgateway）
- 重跑 Soak Test（JSONL/SQLite 任一或双 Sink）

**验收标准**:
- `export_count ≥ 60`
- `error_count = 0`（每分钟≥1次）

**环境变量设置**:
```powershell
$env:TIMESERIES_TYPE = "prometheus"
$env:TIMESERIES_URL = "http://localhost:9091"
```

### 2. 增加并记录"故障注入"用例

**现状**:
- PR 勾选中"故障注入（12s 内恢复）"未执行
- 代码已实现，但需要实际测试验证

**实施方案**:
- 在 60 分钟运行中段，手动 terminate() 信号进程，验证 Orchestrator 自动拉起
- 或补一个 `scripts/test_fault_injection.py`（报告已留出引用位）

**产出要求**:
- 把"重启耗时、健康探针恢复到 green 的时间戳、事件顺序"写入 run_manifest
- 在日报中落证

---

## P1 数据一致性/对账与可观测性增强

### 1. 双 Sink 等价性再收紧 & 固化为 CI Gate

**现状**:
- 目前差异 0.35%（阈值 0.5%）已通过

**实施方案**:
- 将阈值收紧到 0.25%
- 把 `parity_diff.json` 校验接入 CI，超阈即 fail

### 2. 统一 run_id 贯穿 JSONL/SQLite

**现状**:
- Orchestrator 已把 RUN_ID 注入子进程环境
- SQLite Sink 也在 payload 中写入 run_id 并以 `(run_id, ts_ms, symbol)` 为主键建表、迁移与自检
- 但 JSONL 的 log_entry 目前未含 run_id/signal_type/created_at 等字段

**实施方案**:
- 给 JSONL 也补上 run_id/signal_type/created_at，与 SQLite 必备列对齐
- 便于 parity 工具按 run_id 直接对账

### 3. LIVE/preview 标识与输入目录收敛

**现状**:
- 本轮虽然设为 LIVE，但实际是 preview 历史窗口（335 分钟跨度）
- 功能验证 OK，但会让"runtime_state 快照为空"等表现与预期不完全一致

**实施方案**:
- 运行参数明确：`V13_INPUT_MODE=raw` 时走权威实时流，preview 仅做功能/回放
- 报告里把"数据源模式（raw/preview）、--watch 开启与否、特征目录路径"三者一起写入 source_manifest
- Orchestrator 已针对回放模式取消 --watch（避免 SQLite/JSONL 时窗不一致），保持这个分歧处理

---

## P2 稳定性与可维护性

### 1. 健康探针 & SQLite 批量写入参数外显到配置

**现状**:
- `run.py` 的 SQLite 健康探针里已经加了"表存在性检查"和"最近窗口 confirm 计数阈值"逻辑
- SQLite 批量参数默认 `batch_n=500, flush_ms=500ms` 已通过环境变量接管，区间校验也做好了

**实施方案**:
- 把 `min_growth_window_seconds/min_growth_count` 也暴露为 config 字段，便于在不同环境调参
- 保持生产建议范围 `[50, 5000]ms`（验证期允许 0）

### 2. 报表可观测性补强

**现状**:
- 日报已包含 runtime_state、Harvester SLO、告警条目等
- 由于 preview 模式，runtime_state.snapshots 为空属正常现象

**实施方案**:
- 当检测到 preview 时，在日报加一行提示"StrategyMode 快照在回放模式下默认为空"，减少误报

### 3. 任务卡与 DoD 同步

**现状**:
- TASK_INDEX/README 的任务结构清晰完整

**实施方案**:
- 把本轮两项遗留（时序库导出、故障注入）加入 TASK-07A 的 DoD 必须项（而不是"可选"），作为合并前的 PR Gate

---

## 快速复跑清单

### 单命令（Windows PowerShell）

```powershell
$env:TIMESERIES_TYPE="prometheus"
$env:TIMESERIES_URL="http://localhost:9091"
$env:V13_INPUT_MODE="raw"         # 需要真实WS；回放请用 preview

python -m orchestrator.run `
  --config ./config/defaults.yaml `
  --enable harvest,signal,broker,report `
  --sink dual `                   # 同时 JSONL + SQLite，自动产出 parity_diff
  --minutes 60
```

### 完成后验收

**报表与产出物**:
- `summary_*.json|md`
- `parity_diff_*.json`
- `source_manifest_*.json`
- `run_manifest_*.json`

**指标**:
- `export_count ≥ 60`
- `parity_diff < 0.25%`
- `queue_dropped=0`
- `reconnect_count≤3`
- `RSS<600MB`

---

## 实施优先级

1. **P0**: 时序库导出验证 + 故障注入测试
2. **P1**: 双Sink阈值收紧 + run_id统一 + LIVE/preview标识
3. **P2**: 配置外显 + 报表补强 + DoD同步

---

**下一步**: 开始实施 P0 项


