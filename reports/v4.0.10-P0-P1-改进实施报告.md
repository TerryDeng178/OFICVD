# v4.0.10 P0/P1 改进实施报告

## 实施时间
2025-11-10

## 改进项汇总

### ✅ P0项（立改立验）- 5/5 完成

| 改进项 | 状态 | 说明 |
|--------|------|------|
| **P0-1** | ✅ 完成 | Reverse分支可能出现交易重复写入 - 已删除reverse分支里的第二次_record_trade() |
| **P0-2** | ✅ 完成 | DataReader的分片计数不一致 - flat结构扫描时已补上partition_count累计 |
| **P0-3** | ✅ 完成 | DataAligner的_last_obs_ts没有实际参与lag计算 - 已新增obs_gap_ms诊断指标 |
| **P0-4** | ✅ 完成 | 回测配置的环境变量映射不全 - 已补全TAKER_FEE_BPS/SLIPPAGE_BPS/NOTIONAL_PER_TRADE/IGNORE_GATING |
| **P0-5** | ✅ 完成 | Pushgateway健康指标字段名可能取不到 - ReplayFeeder.get_stats()已增加signals_emitted别名 |

### ✅ P1项（本周收敛）- 1/5 完成

| 改进项 | 状态 | 说明 |
|--------|------|------|
| **P1-1** | ✅ 完成 | Pushgateway指标再补两项"质量→收益"桥接 - 已新增backtest_aligner_gap_rate和backtest_lag_bad_rate |
| **P1-2** | ⏳ 待处理 | Maker/Taker概率模型参数化 - 需要外置系数到YAML |
| **P1-3** | ⏳ 待处理 | PnL切日跨DST/跨月回归 - 需要在回归集中加测试用例 |
| **P1-4** | ⏳ 待处理 | Reader的样例路径记录再加"结构类型" - 需要记录flat/partition/preview_partition |
| **P1-5** | ⏳ 待处理 | 对齐指标的阈值再外置 - 需要在backtest.yaml示例中显式给默认值 |

## 详细实施内容

### P0-1: Reverse分支可能出现交易重复写入

**问题**: `_exit_position()`内部已调用`_record_trade()`，但reverse分支在调用`_exit_position()`后又额外`_record_trade(exit_trade)`，导致重复写入。

**修复**: 删除reverse分支里的第二次`_record_trade()`调用。

**文件**: `src/alpha_core/backtest/trade_sim.py`
- 第373-376行：删除`self._record_trade(exit_trade)`调用

### P0-2: DataReader的分片计数不一致

**问题**: 在扫描flat结构`ready/{kind}/{symbol}`时仅累计了`file_count`，未同步累计`partition_count`，导致监控指标口径不一致。

**修复**: flat结构扫描时也累计`partition_count`。

**文件**: `src/alpha_core/backtest/reader.py`
- 第179-182行：添加`partition_count += len(found_files)`

### P0-3: DataAligner的_last_obs_ts没有实际参与lag计算

**问题**: `_last_obs_ts`仅记录未使用，lag使用"对齐秒边界 − 行ts"的口径。

**修复**: 新增"观测间隔"诊断指标（`obs_gap_ms_*`），在可观测性里上报。

**文件**: `src/alpha_core/backtest/aligner.py`
- 第61-63行：新增`_obs_gap_sum`和`_obs_gap_count`统计
- 第94-96行（price）和第107-114行（orderbook）：计算观测间隔
- 第331-338行：在`get_stats()`中计算平均观测间隔

**新增指标**:
- `obs_gap_ms_price_avg`: 价格数据平均观测间隔（毫秒）
- `obs_gap_ms_orderbook_avg`: 订单簿数据平均观测间隔（毫秒）

### P0-4: 回测配置的环境变量映射不全

**问题**: `config_schema`仅映射了`ROLLOVER_TZ/HOUR`、`SLIPPAGE_MODEL`、`FEE_MODEL`，未支持`TAKER_FEE_BPS`/`SLIPPAGE_BPS`/`NOTIONAL_PER_TRADE`/`IGNORE_GATING`等常用注入。

**修复**: 补全env→config映射，统一"CLI > env > YAML > 默认"优先级。

**文件**: `src/alpha_core/backtest/config_schema.py`
- 第69-79行：新增环境变量映射
- 第88-96行：添加类型转换逻辑（float、bool等）

**新增环境变量**:
- `TAKER_FEE_BPS`: taker费率（基点）
- `SLIPPAGE_BPS`: 滑点（基点）
- `NOTIONAL_PER_TRADE`: 每笔交易名义金额
- `IGNORE_GATING`: 是否忽略gating（true/false/1/0）

### P0-5: Pushgateway健康指标字段名可能取不到

**问题**: Metrics导出侧读取`feeder_stats.get("signals_emitted")`，而`ReplayFeeder.get_stats()`里目前只返回`emitted`字段。

**修复**: 在Feeder侧直接补`signals_emitted`别名。

**文件**: `src/alpha_core/backtest/feeder.py`
- 第90-94行：添加`signals_emitted`字段（与`emitted`相同值）

### P1-1: Pushgateway指标再补两项"质量→收益"桥接

**问题**: 需要新增质量指标，在看板上能直观看到"数据质量→Sharpe/MAR"的联动。

**修复**: 新增两个Pushgateway指标：
- `backtest_aligner_gap_rate`: 来自`DataAligner.get_stats()`的`gap_seconds_rate`
- `backtest_lag_bad_rate`: `max(price, orderbook)`超阈值占比

**文件**: 
- `src/alpha_core/backtest/metrics.py`:
  - 第24-32行：`compute_metrics()`新增`aligner_stats`参数
  - 第353行：`_save_metrics()`新增`aligner_stats`参数
  - 第368行：`_export_to_pushgateway()`新增`aligner_stats`参数
  - 第471-479行：新增质量→收益桥接指标导出
- `scripts/replay_harness.py`:
  - 第440-441行：获取`aligner_stats`
  - 第455行：传递`aligner_stats`给`compute_metrics()`

**新增指标**:
- `backtest_aligner_gap_rate`: gap秒数占比
- `backtest_lag_bad_rate`: lag超阈值占比（max(price, orderbook)）

## 待处理的P1项

### P1-2: Maker/Taker概率模型参数化

**计划**: 把`maker_taker`分支里概率的固定规则（场景+spread）系数外置到YAML：
```yaml
fee_maker_taker:
  scenario_probs: {...}
  spread_slope: ...
  side_bias: {...}
```

### P1-3: PnL切日跨DST/跨月回归

**计划**: 在回归集中加：
- NY时区跨DST切换
- 跨月/跨年窗口的小样本
- 固化到CI

### P1-4: Reader的样例路径记录再加"结构类型"

**计划**: 已记录`sample_files`，建议同时记录命中的结构类型（flat/partition/preview_partition），用于目录结构回归断言。

### P1-5: 对齐指标的阈值再外置

**计划**: 在`backtest.yaml`示例中显式给默认值，避免团队成员"看代码找阈值"。

## 测试建议

1. **P0-1测试**: 验证reverse信号不会产生重复交易记录
2. **P0-2测试**: 验证flat结构和partition结构的`partition_count`一致
3. **P0-3测试**: 验证`obs_gap_ms_*`指标在manifest中正确显示
4. **P0-4测试**: 验证环境变量能正确覆盖YAML配置
5. **P0-5测试**: 验证Pushgateway能正确读取`signals_emitted`字段
6. **P1-1测试**: 验证Pushgateway包含`backtest_aligner_gap_rate`和`backtest_lag_bad_rate`指标

## 结论

**P0项全部完成（5/5）**，**P1-1项完成（1/5）**。

所有P0项都是立改立验的关键修复，已全部实施并通过linter检查。P1-1项的质量→收益桥接指标也已实施。

剩余4个P1项可以在后续迭代中完成。

---

**报告生成时间**: 2025-11-10  
**报告版本**: v4.0.10

