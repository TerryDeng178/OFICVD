# TASK-A1 ä¸Šçº¿å‰æœ€åä¸€è½®åŠ¨ä½œæ¸…å•

**ç”Ÿæˆæ—¶é—´**ï¼š2025-11-12  
**é€‚ç”¨ä»»åŠ¡**ï¼šTASK-A1 æœåŠ¡ç²¾ç®€è½åœ°ï¼ˆåˆå¹¶é£æ§ï¼‰Â·ä¼˜åŒ–ç‰ˆ  
**çŠ¶æ€**ï¼šâœ… å·²å®Œæˆä¿®æ­£ï¼Œå¾…æ‰§è¡Œä¸Šçº¿åŠ¨ä½œ

---

## âœ… å·²ä¿®æ­£çš„ä¸ä¸€è‡´

### 1. READMEå¯åŠ¨ç¤ºä¾‹ä¿®æ­£

**é—®é¢˜**ï¼šLinux/macOSç¤ºä¾‹å‘½ä»¤ç¼ºå°‘`strategy`æœåŠ¡

**ä¿®æ­£**ï¼š
- âœ… å·²æ›´æ–° `README.md` ç¬¬502è¡Œ
- âœ… Linux/macOSç¤ºä¾‹ç°åœ¨åŒ…å«ï¼š`--enable harvest,signal,strategy,broker,report`
- âœ… ä¸Windows PowerShellç¤ºä¾‹ä¿æŒä¸€è‡´ï¼ˆ5ä¸ªæ ¸å¿ƒæœåŠ¡ï¼‰

### 2. æ–‡æ¡£ç‰ˆæœ¬æ··ç”¨ä¿®æ­£

**é—®é¢˜**ï¼šæŠ¥å‘Šä¸­å­˜åœ¨"62/62 passed"çš„æ—§ç»Ÿè®¡

**ä¿®æ­£**ï¼š
- âœ… å·²æ›´æ–° `reports/TASK-A1å®Œæ•´å®ŒæˆæŠ¥å‘Š.md`
- âœ… ç»Ÿä¸€ä¸º"89/89 passed"ï¼ˆæœ€ç»ˆè®¡æ•°ï¼‰
- âœ… ä»»åŠ¡å¡å·²ç»Ÿä¸€ä¸º89/89ï¼ˆåŒ…å«Schemaæ ¡éªŒã€P1/P2ä¼˜åŒ–æµ‹è¯•ï¼‰

---

## ğŸ“‹ ä¸Šçº¿å‰åŠ¨ä½œæ¸…å•

### D-0ï¼ˆç°åœ¨ï¼‰ï¼šç«‹å³æ‰§è¡Œ

#### 1. âœ… ç›‘æ§è§„åˆ™è½åœ°

**æ–‡ä»¶**ï¼š`docs/alerting_rules.md`ï¼ˆå·²åˆ›å»ºï¼‰

**å‘Šè­¦è§„åˆ™**ï¼š
- `risk_check_latency_seconds`ï¼šp95 â‰¤ 5msï¼›è¿ç»­5åˆ†é’Ÿ > 5msè§¦å‘WARNã€>8msè§¦å‘CRIT
- `risk_shadow_parity_ratio`ï¼šä½äº99%è¿ç»­10åˆ†é’Ÿå‘Šè­¦ï¼ˆWARNï¼‰ï¼›ä½äº98% 5åˆ†é’Ÿï¼ˆCRITï¼‰
- `risk_precheck_total{result,reason}`ï¼šDeny rateè¾¹ç•Œï¼ˆåŸºçº¿Â±5%å›å½’é˜ˆå€¼ï¼‰

**åŠ¨ä½œ**ï¼š
- [ ] å°†å‘Šè­¦è§„åˆ™éƒ¨ç½²åˆ°Prometheus
- [ ] é…ç½®AlertManagerè·¯ç”±
- [ ] æµ‹è¯•å‘Šè­¦è§¦å‘

#### 2. âœ… æŒ‡æ ‡å£å¾„"åªç•™seconds"è·¯çº¿å›¾

**æ–‡ä»¶**ï¼š`docs/alerting_rules.md`ï¼ˆå·²åŒ…å«ï¼‰

**è®¡åˆ’**ï¼š
- **T+7å¤©**ï¼šDashboardå…¨éƒ¨åˆ‡æ¢åˆ°`risk_check_latency_seconds`
- **T+14å¤©**ï¼šåœæ­¢å¯¼å‡º`risk_check_latency_ms`ï¼Œä»…ä¿ç•™`risk_check_latency_seconds`

**åŠ¨ä½œ**ï¼š
- [ ] åˆ›å»ºDashboardè¿ç§»è®¡åˆ’
- [ ] é€šçŸ¥å›¢é˜ŸæŒ‡æ ‡å£å¾„å˜æ›´

#### 3. âœ… å¥‘çº¦å†»ç»“ä¸æšä¸¾çº¦æŸ

**æ–‡ä»¶**ï¼š`mcp/strategy_server/risk/lint_rules.py`ï¼ˆå·²åˆ›å»ºï¼‰

**Lintè§„åˆ™**ï¼š
- æ£€æŸ¥`reason_codes`æ˜¯å¦ä¸ºæšä¸¾å€¼
- é˜»æ–­è‡ªç”±æ–‡æœ¬ï¼Œé˜²æ­¢é«˜åŸºæ•°

**åŠ¨ä½œ**ï¼š
- [ ] é›†æˆåˆ°CI/CDæµç¨‹
- [ ] è¿è¡Œlintæ£€æŸ¥ï¼š`python -m mcp.strategy_server.risk.lint_rules`
- [ ] ä¿®å¤ç°æœ‰ä»£ç ä¸­çš„è‡ªç”±æ–‡æœ¬reason_codes

#### 4. âœ… ç°åº¦ä¸å›æ»šRunbook

**æ–‡ä»¶**ï¼š`docs/gray_release_runbook.md`ï¼ˆå·²åˆ›å»ºï¼‰

**å†…å®¹**ï¼š
- 50/50ç°åº¦ç­–ç•¥
- è‡ªåŠ¨å›å½’è„šæœ¬ï¼ˆÂ±5%é˜ˆå€¼ï¼‰
- è‡ªåŠ¨å›æ»šè§¦å‘æ¡ä»¶
- Shadow 24hè¿ç»­è§‚æµ‹

**åŠ¨ä½œ**ï¼š
- [ ] å‡†å¤‡å›å½’æµ‹è¯•æ•°æ®
- [ ] è¿è¡ŒåŸºçº¿æµ‹è¯•ï¼ˆLegacyæ¨¡å¼ï¼‰
- [ ] éªŒè¯ç›‘æ§å’Œå‘Šè­¦

#### 5. âœ… å¥åº·æ¢æ´»ä¸é™æµå¯¹æ¥ç½‘å…³

**æ–‡ä»¶**ï¼š`mcp/strategy_server/risk/metrics_endpoint.py`ï¼ˆå·²å®ç°ï¼‰

**ç«¯ç‚¹**ï¼š
- `/healthz`ï¼šè½»é‡æœ¬åœ°æ¢æ´»
- `/readyz`ï¼šä¾èµ–å°±ç»ªæ£€æŸ¥
- `/metrics`ï¼šPrometheusæ ¼å¼ï¼ˆæ”¯æŒgzipå‹ç¼©ï¼‰
- è¯·æ±‚é™æµï¼šæ»‘åŠ¨çª—å£ï¼Œ100è¯·æ±‚/60ç§’

**åŠ¨ä½œ**ï¼š
- [ ] é…ç½®Ingress/ServiceMesh
- [ ] å¯ç”¨gzipå‹ç¼©
- [ ] é…ç½®é™æµè§„åˆ™

#### 6. âœ… Shadowå¯¹æ¯”24hè¿ç»­è§‚æµ‹

**æ–‡ä»¶**ï¼š`scripts/shadow_24h_monitor.py`ï¼ˆå·²åˆ›å»ºï¼‰

**åŠŸèƒ½**ï¼š
- 24å°æ—¶è¿ç»­è§‚æµ‹
- åˆ†æ—¶æ®µæ£€æŸ¥ï¼ˆäºšç›˜/æ¬§ç›˜/ç¾ç›˜ï¼‰
- è‡ªåŠ¨ç”ŸæˆæŠ¥å‘Š

**åŠ¨ä½œ**ï¼š
- [ ] è®¾ç½®æ—¥å¸¸ä»»åŠ¡ï¼ˆcron/scheduled taskï¼‰
- [ ] è¿è¡Œ24hè§‚æµ‹è„šæœ¬
- [ ] åˆ†æåˆ†æ—¶æ®µparityæ¯”ç‡

#### 7. âœ… äº¤æ˜“æ‰€çº¦æŸçš„ç”¨ä¾‹åŠ å›º

**æ–‡ä»¶**ï¼š`tests/test_exchange_filters_edge_cases.py`ï¼ˆå·²åˆ›å»ºï¼‰

**æµ‹è¯•ç”¨ä¾‹**ï¼š
- æœ€å°åä¹‰é¢è¾¹ç•Œ
- æ•°é‡æ­¥é•¿æº¢å‡º
- ä»·æ ¼æ­¥é•¿æº¢å‡º
- æ‰€æœ‰Filterçº¦æŸåŒæ—¶è¿å

**åŠ¨ä½œ**ï¼š
- [ ] è¿è¡Œè¾¹ç•Œç”¨ä¾‹æµ‹è¯•ï¼š`pytest tests/test_exchange_filters_edge_cases.py -v`
- [ ] éªŒè¯è°ƒæ•´å»ºè®®çš„æ­£ç¡®æ€§

#### 8. âœ… å›æ”¾æ•°æ®æ ¼å¼åŒé€šé“

**æ–‡ä»¶**ï¼š`tests/test_parquet_replay.py`ï¼ˆå·²åˆ›å»ºï¼‰

**æµ‹è¯•**ï¼š
- JSONL vs Parquetä¸€è‡´æ€§ï¼ˆâ‰¥99%ï¼‰
- ç›¸åŒæ ·æœ¬é›†ï¼Œä¸€è‡´ç‡éªŒè¯

**åŠ¨ä½œ**ï¼š
- [ ] è¿è¡ŒParquetå›æ”¾æµ‹è¯•ï¼š`pytest tests/test_parquet_replay.py -v`
- [ ] éªŒè¯ä¸€è‡´ç‡â‰¥99%

#### 9. âœ… æ—¥å¿—ç­–ç•¥"æŠ½æ ·+å…³é”®å…¨é‡"å›ºåŒ–åˆ°é…ç½®

**æ–‡ä»¶**ï¼š`config/defaults.yaml`ï¼ˆå·²æ›´æ–°ï¼‰

**é…ç½®**ï¼š
```yaml
components:
  strategy:
    risk:
      logging:
        sampling_rate: 0.01       # é€šè¿‡å•æŠ½æ ·ç‡ï¼ˆ1%ï¼‰
        log_passed: true          # æ˜¯å¦è®°å½•é€šè¿‡å•ï¼ˆæŠ½æ ·ï¼‰
        log_denied: true          # æ˜¯å¦è®°å½•æ‹’ç»å•ï¼ˆ100%ï¼‰
        log_schema_failed: true   # æ˜¯å¦è®°å½•Schemaæ ¡éªŒå¤±è´¥ï¼ˆ100%ï¼‰
        log_shadow_alert: true    # æ˜¯å¦è®°å½•Shadowå‘Šè­¦ï¼ˆ100%ï¼‰
```

**åŠ¨ä½œ**ï¼š
- [ ] æ›´æ–°`logging_config.py`ä»¥è¯»å–é…ç½®
- [ ] éªŒè¯æ—¥å¿—æŠ½æ ·ç­–ç•¥

#### 10. âœ… Dashboardæœ€å°ç‰ˆ

**æ–‡ä»¶**ï¼š`docs/dashboard_minimal.md`ï¼ˆå·²åˆ›å»ºï¼‰

**4ä¸ªé¢æ¿**ï¼š
1. Latencyï¼ˆp50/p95/p99ï¼‰
2. Deny/Pass Rateï¼ˆå«reasonç»´åº¦ï¼‰
3. Shadow Parity & Alert
4. Throughputï¼ˆChecks/secï¼‰

**åŠ¨ä½œ**ï¼š
- [ ] å¯¼å…¥Grafana Dashboard JSON
- [ ] é…ç½®Prometheusæ•°æ®æº
- [ ] è®¾ç½®åˆ·æ–°é—´éš”ï¼ˆ30ç§’ï¼‰

---

### D-1ï¼ˆæ˜å¤©ï¼‰ï¼šç°åº¦å‘å¸ƒ

#### 1. å¯åŠ¨10%ç°åº¦

**æ­¥éª¤**ï¼š
```bash
$env:RISK_INLINE_ENABLED = "true"
$env:RISK_GRAY_RATIO = "0.1"
python -m mcp.strategy_server.app --config ./config/defaults.yaml
```

**ç›‘æ§**ï¼š
- [ ] `risk_shadow_parity_ratio` â‰¥ 99%
- [ ] `risk_check_latency_seconds` p95 â‰¤ 5ms
- [ ] `risk_precheck_total{result="deny"}` æ‹’å•ç‡åœ¨åŸºçº¿Â±5%å†…

#### 2. è§‚å¯Ÿ30åˆ†é’Ÿ

**æ£€æŸ¥**ï¼š
- [ ] å‘Šè­¦æ˜¯å¦è§¦å‘
- [ ] æ—¥å¿—æ˜¯å¦æœ‰å¼‚å¸¸
- [ ] Shadowæ¯”å¯¹ç»“æœ

#### 3. æå‡åˆ°50%ç°åº¦

**æ­¥éª¤**ï¼š
```bash
$env:RISK_GRAY_RATIO = "0.5"
# é‡å¯strategy_server
```

**è¿è¡Œå›å½’æµ‹è¯•**ï¼š
```bash
python scripts/regression_test_risk.py --test-data ./runtime/test_signals.jsonl --threshold 0.05
```

---

### D+1ï¼ˆå‘å¸ƒåä¸€å¤©ï¼‰

#### 1. æå‡åˆ°100%

**æ­¥éª¤**ï¼š
```bash
$env:RISK_INLINE_ENABLED = "true"
$env:RISK_GRAY_RATIO = "1.0"
# é‡å¯strategy_server
```

#### 2. æŒç»­ç›‘æ§24å°æ—¶

**æ£€æŸ¥**ï¼š
- [ ] Shadowæ¯”å¯¹è¿ç»­è§‚æµ‹
- [ ] åˆ†æ—¶æ®µæ£€æŸ¥ï¼ˆäºšç›˜/æ¬§ç›˜/ç¾ç›˜ï¼‰
- [ ] è¿è¡Œå›å½’æµ‹è¯•è„šæœ¬

---

### D+7ï¼ˆä¸‹å‘¨ï¼‰

#### 1. æ€»ç»“Shadow 24hæŠ¥å‘Š

**åŠ¨ä½œ**ï¼š
- [ ] åˆ†æ24hè§‚æµ‹æ•°æ®
- [ ] æ£€æŸ¥åˆ†æ—¶æ®µparityæ¯”ç‡
- [ ] ç”Ÿæˆæ€»ç»“æŠ¥å‘Š

#### 2. å…¨é¢åˆ‡æ¢åˆ°_secondsæŒ‡æ ‡

**åŠ¨ä½œ**ï¼š
- [ ] Dashboardå…¨éƒ¨åˆ‡æ¢åˆ°`risk_check_latency_seconds`
- [ ] é€šçŸ¥å›¢é˜ŸæŒ‡æ ‡å£å¾„å˜æ›´

#### 3. è®¡åˆ’ä¸‹çº¿_msæŒ‡æ ‡

**åŠ¨ä½œ**ï¼š
- [ ] åœæ­¢å¯¼å‡º`risk_check_latency_ms`
- [ ] æ›´æ–°æ–‡æ¡£å’Œä»£ç æ³¨é‡Š

---

## ğŸ“Š æ£€æŸ¥æ¸…å•

### å‘å¸ƒå‰æ£€æŸ¥

- [x] READMEå¯åŠ¨ç¤ºä¾‹å·²ä¿®æ­£ï¼ˆåŒ…å«strategyï¼‰
- [x] æ–‡æ¡£ç‰ˆæœ¬å·²ç»Ÿä¸€ï¼ˆ89/89 passedï¼‰
- [x] å‘Šè­¦è§„åˆ™å·²åˆ›å»º
- [x] ç°åº¦Runbookå·²åˆ›å»º
- [x] Shadow 24hç›‘æ§è„šæœ¬å·²åˆ›å»º
- [x] äº¤æ˜“æ‰€çº¦æŸè¾¹ç•Œç”¨ä¾‹å·²åˆ›å»º
- [x] Parquetå›æ”¾æµ‹è¯•å·²åˆ›å»º
- [x] æ—¥å¿—æŠ½æ ·é…ç½®å·²æ·»åŠ 
- [x] Dashboardæœ€å°ç‰ˆå·²åˆ›å»º
- [x] Lintè§„åˆ™å·²åˆ›å»º

### å‘å¸ƒä¸­æ£€æŸ¥

- [ ] å…³é”®æŒ‡æ ‡æ­£å¸¸ï¼ˆparity â‰¥ 99%, latency p95 â‰¤ 5msï¼‰
- [ ] å‘Šè­¦æœªè§¦å‘
- [ ] æ—¥å¿—æ— å¼‚å¸¸
- [ ] Shadowæ¯”å¯¹ç»“æœæ­£å¸¸

### å‘å¸ƒåæ£€æŸ¥

- [ ] 24å°æ—¶è¿ç»­è§‚æµ‹å®Œæˆ
- [ ] åˆ†æ—¶æ®µparityæ£€æŸ¥é€šè¿‡
- [ ] å›å½’æµ‹è¯•é€šè¿‡ï¼ˆÂ±5%é˜ˆå€¼ï¼‰
- [ ] æ— å¼‚å¸¸å‘Šè­¦

---

## ğŸ“ ç›¸å…³æ–‡æ¡£

- **å‘Šè­¦è§„åˆ™**ï¼š`docs/alerting_rules.md`
- **ç°åº¦Runbook**ï¼š`docs/gray_release_runbook.md`
- **Dashboardæœ€å°ç‰ˆ**ï¼š`docs/dashboard_minimal.md`
- **Shadow 24hç›‘æ§è„šæœ¬**ï¼š`scripts/shadow_24h_monitor.py`
- **äº¤æ˜“æ‰€çº¦æŸè¾¹ç•Œç”¨ä¾‹**ï¼š`tests/test_exchange_filters_edge_cases.py`
- **Parquetå›æ”¾æµ‹è¯•**ï¼š`tests/test_parquet_replay.py`
- **Lintè§„åˆ™**ï¼š`mcp/strategy_server/risk/lint_rules.py`

---

**ç»´æŠ¤è€…**ï¼šOFI+CVDå¼€å‘å›¢é˜Ÿ  
**ç‰ˆæœ¬**ï¼šv1.0

