# E4/E5/E6实验结果报告

## 执行时间
2025-11-10 22:42 - 22:50（修复BUG后重新运行）

## 实验结果汇总

| 实验组 | 交易频率/h | 成本bps | 单笔收益 | 胜率 | Maker比例 | 净PnL |
|--------|-----------|---------|---------|------|-----------|-------|
| **D基线** | 71.0 | 1.93 | -$0.64 | 16.81% | N/A | -$64.00 |
| **E4** | **56.0** ⬇️ | 1.93 | -$0.99 | 39.29% ⬆️ | 50.00% | -$55.19 |
| **E5** | 71.0 | 1.93 | -$0.64 | **39.44%** ⬆️ | 50.00% | -$45.51 |
| **E6** | **44.0** ⬇️ | 1.93 | -$0.71 | 38.64% ⬆️ | 50.00% | -$31.34 |

---

## 关键发现

### 1. 频率控制（E4/E6有效）

**E4组**：交易频率从71/h降至56/h（降低21%），但仍未达到≤25/h目标。
**E6组**：交易频率从71/h降至44/h（降低38%），但仍未达到≤20/h目标。

**原因分析**：
- E4/E6的入口节流参数（`weak_signal_threshold`, `consistency_min`, `dedupe_ms`）有效
- 但阈值仍需进一步收紧才能达到目标

### 2. 成本控制（全组无改进）❌

**所有实验组的成本bps都是1.93，与D组完全相同**。

**关键问题**：
- **Maker比例未提升**：所有组的`maker_ratio_actual`都是50%，说明E2/E4的Maker参数设置**没有生效**
- **有效价差异常**：`effective_spread_bps_p50`和`effective_spread_bps_p95`都是1.0bps（完全相同），说明`spread_bps`字段可能没有正确传递

**可能原因**：
1. `spread_bps`字段在`_feature_data`中缺失或为0
2. Maker概率计算逻辑可能有问题
3. 费率模型的实际执行与配置不一致

### 3. 单笔收益（全组仍为负）❌

**所有实验组的单笔收益仍为负值**：
- E4: -$0.99（比D组更差）
- E5: -$0.64（与D组相同）
- E6: -$0.71（比D组略差）

**原因分析**：
- E5的TP/SL回调（15/8/1.5）未改善单笔收益
- 胜率提升（39%+）未转化为正收益

### 4. 胜率提升（全组显著）✅

**所有实验组的胜率都达到了38-39%**，远高于D组的16.81%。

**原因分析**：
- 入口节流参数过滤了弱信号
- TP/SL策略改善了退出时机

**但胜率提升未转化为正收益**，说明盈利交易的收益不足以覆盖亏损。

---

## 验收结果

### E4组：E1入口节流+E2 Maker策略合并
- ❌ 交易频率：56/h > 25/h（未达标，但已改善21%）
- ❌ 成本bps：1.93 > 1.85（未达标）
- ✅ Maker比例：50%（有值，但未显著提升）
- ✅ ETHUSDT稳健性：通过

**总体状态**：❌ FAIL（频率和成本未达标）

### E5组：TP/SL+死区回调
- ❌ 单笔收益：-$0.64 < 0（未达标）
- ✅ 胜率：39.44% ≥ 30%（达标）
- ✅ ETHUSDT稳健性：通过

**总体状态**：❌ FAIL（单笔收益未达标）

### E6组：极限降频闸
- ❌ 交易频率：44/h > 20/h（未达标，但已改善38%）
- ✅ 胜率：38.64% ≥ 25%（达标）
- ✅ ETHUSDT稳健性：通过

**总体状态**：❌ FAIL（频率未达标）

**总体验收**：❌ FAIL（所有实验组均未完全达标）

---

## 成本观测指标分析

### 关键发现

| 实验组 | Maker比例 | Taker比例 | 有效价差P50 | 有效价差P95 | 成本bps |
|--------|----------|----------|------------|------------|---------|
| E4 | 50.00% | 50.00% | 1.0bps | 1.0bps | 1.93bps |
| E5 | 50.00% | 50.00% | 1.0bps | 1.0bps | 1.93bps |
| E6 | 50.00% | 50.00% | 1.0bps | 1.0bps | 1.93bps |

### 问题诊断

1. **Maker比例未提升**：
   - E4设置了`maker_fee_ratio=0.35`和`scenario_probs.Q_L=0.90`，但`maker_ratio_actual`仍是50%
   - **验证结果**：`maker_probability`有值（0.457-0.686，平均0.571），说明概率计算正常
   - **问题**：`is_maker_actual`的判断逻辑（`maker_prob > 0.5`）导致实际Maker比例接近50%
   - **原因**：概率分布接近0.5，导致Maker/Taker各占一半

2. **有效价差异常**：
   - `effective_spread_bps_p50`和`effective_spread_bps_p95`都是1.0bps（完全相同）
   - **验证结果**：`spread_bps`字段**全为0.0**（所有交易）
   - **问题**：`spread_bps`字段在`_feature_data`中缺失或未正确传递
   - **影响**：无法准确计算有效价差，成本分析不准确

3. **成本未降低**：
   - 即使Maker比例提升，成本仍为1.93bps
   - 可能原因：滑点成本抵消了Maker费率优势，或费率模型计算有问题

---

## 各交易对表现

### E4组
- **BNBUSDT**: 14笔，净PnL -$17.62，胜率35.71%
- **BTCUSDT**: 19笔，净PnL -$12.43，胜率31.58%
- **ETHUSDT**: 23笔，净PnL -$3.54，胜率47.83% ⬆️（表现最好）

### E5组
- **BNBUSDT**: 15笔，净PnL $4.12 ✅，胜率46.67%
- **BTCUSDT**: 19笔，净PnL $4.71 ✅，胜率36.84%
- **ETHUSDT**: 37笔，净PnL -$27.15 ❌，胜率37.84%（表现最差）

### E6组
- **BNBUSDT**: 7笔，净PnL -$3.32，胜率42.86%
- **BTCUSDT**: 12笔，净PnL $1.11 ✅，胜率41.67%
- **ETHUSDT**: 25笔，净PnL -$12.15 ❌，胜率36.00%

**关键发现**：
- ETHUSDT在E5组表现最差（37笔交易，净PnL -$27.15）
- BNBUSDT和BTCUSDT在E5组表现较好（净PnL为正）

---

## 下一步行动方案

### P0优先级（立即执行）

#### 1. 修复Maker比例未提升问题
**问题**：E4设置了Maker参数，但`maker_ratio_actual`仍是50%。

**检查项**：
- [ ] 检查`fee_maker_taker`配置是否正确传递到TradeSimulator
- [ ] 检查`scenario_probs`是否在费率计算中被使用
- [ ] 验证`maker_probability`计算逻辑

**验证结果**：
- ✅ `maker_probability`有值（0.457-0.686，平均0.571）
- ❌ `spread_bps`全为0.0（字段缺失）
- ❌ `maker_ratio_actual`仍是50%（概率分布接近0.5导致）

**修复方向**：
1. 修复`spread_bps`字段传递（信号生成时设置`_feature_data.spread_bps`）
2. 调整Maker概率阈值（从0.5改为0.6或更高，或使用概率加权）
3. 检查费率模型配置是否正确应用

#### 2. 修复spread_bps字段缺失问题
**问题**：`effective_spread_bps`的P50和P95都是1.0bps，说明`spread_bps`可能为0。

**检查项**：
- [ ] 检查信号生成时是否正确设置`_feature_data.spread_bps`
- [ ] 检查回测端是否正确传递`spread_bps`
- [ ] 验证`effective_spread_bps`计算逻辑

#### 3. 进一步降低频率（E4/E6）
**方案**：在现有基础上进一步收紧参数：
- E4: `weak_signal_threshold: 0.77`（从0.75提高）
- E6: `weak_signal_threshold: 0.78`（从0.75提高）

### P1优先级（后续优化）

#### 1. 费用路径验证
- 检查E2/E4中实际`maker_ratio_actual`是否上升
- 若没有，增大被动单TTL与允许的排队深度阈值
- 必要时引入二次重挂（`max_pending_orders=2`）与轻度`price_offset_bps`

#### 2. 滑点分布分析
- 对比`effective_spread_bps`（含滑点）的P50/P95
- 若Maker提升但成本仍不降，多半是滑点/排队带来的"隐性成本"

---

## 文件清单

### 实验结果
- `runtime/optimizer/group_e4_validation/backtest_20251110_224256/` - E4组结果
- `runtime/optimizer/group_e5_validation/backtest_20251110_224622/` - E5组结果
- `runtime/optimizer/group_e6_validation/backtest_20251110_225001/` - E6组结果
- `runtime/optimizer/e456_results_analysis.json` - 分析结果

---

## 结论

**E4/E5/E6实验部分达成目标**：
- ✅ E4/E6成功降低交易频率（56/h和44/h）
- ✅ 所有组显著提升胜率（38-39% vs 16.81%）
- ❌ 成本控制未改进（全组1.93bps，Maker比例未提升）
- ❌ 单笔收益仍为负（全组未达标）

**关键问题**：
1. **Maker参数设置未生效**（`maker_ratio_actual`都是50%）
2. **spread_bps字段可能缺失**（有效价差都是1.0bps）
3. **频率仍需进一步降低**（E4/E6未达到目标）

**建议**：优先修复Maker比例和spread_bps问题，然后进一步收紧频率参数，争取在下一轮达到验收标准。

