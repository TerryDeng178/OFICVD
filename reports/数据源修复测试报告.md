# 数据源修复测试报告

> **测试日期**: 2025-11-07  
> **测试时长**: 1 分钟  
> **修复内容**: Parquet 支持 + 字段映射

## 修复内容总结

### 1. Orchestrator 输入目录修正 ✅
- **修改**: `preview/features/` → `preview/`
- **效果**: 支持递归扫描分区文件

### 2. Signal Server Parquet 支持 ✅
- **添加**: pandas 导入（可选）
- **添加**: Parquet 文件读取逻辑
- **添加**: 字段名映射

### 3. 字段映射 ✅
- **`ofi_z` → `z_ofi`**: Parquet 字段名映射
- **`cvd_z` → `z_cvd`**: Parquet 字段名映射
- **`lag_ms_*` → `lag_sec`**: 毫秒转秒
- **`consistency`**: 默认值 1.0
- **`warmup`**: 默认值 False

## 测试结果

### 数据源检查
- ✅ Parquet 文件：12,743 个特征文件
- ✅ 路径配置：`preview/` 根目录
- ✅ 文件可读：pandas 成功读取
- ✅ 字段映射：`ofi_z`/`cvd_z` → `z_ofi`/`z_cvd`

### 信号生成
- ✅ Signal Server 成功启动
- ✅ 处理了 Parquet 文件
- ⚠️ 字段映射已应用
- ⚠️ 需要验证最终信号数量

## 已知问题

### 字段缺失警告
日志显示仍有字段缺失警告，但这是预期的：
- Parquet 文件缺少 `consistency` 和 `warmup`
- 已通过字段映射添加默认值
- CoreAlgorithm 会使用默认值处理

### 健康检查
- Signal 健康检查失败（因为时间窗口检查）
- 这是预期的（静态文件不满足时间窗口要求）

## 下一步

1. **验证信号生成**: 检查是否有 `confirm=true` 的信号
2. **优化 consistency 计算**: 考虑从其他字段计算 consistency
3. **完善字段映射**: 确保所有必需字段都有映射

## 代码变更

### `orchestrator/run.py`
```python
# 修复前
features_dir = project_root / "deploy" / "data" / "ofi_cvd" / "preview" / "features"

# 修复后
features_dir = project_root / "deploy" / "data" / "ofi_cvd" / "preview"
```

### `mcp/signal_server/app.py`
- 添加 pandas 导入
- 添加 Parquet 文件读取
- 添加字段映射逻辑
- 更新 watch 模式支持 Parquet

## 验证清单

- [x] Parquet 文件可读
- [x] 字段映射正确
- [x] Signal Server 启动成功
- [ ] 信号生成正常（待验证）
- [ ] 无字段缺失警告（部分解决）

