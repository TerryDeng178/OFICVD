# TASK-07A P0/P1修复测试计划

> **测试日期**: 2025-11-09  
> **测试目标**: 验证所有P0/P1修复效果  
> **测试状态**: 📋 **待执行**

---

## 测试目标

验证以下修复的正确性和有效性：

### P0修复验证
1. ✅ MultiSink循环内copy（数据一致性）
2. ✅ JSONL尾批fsync（数据安全）
3. ✅ SQLite关闭日志（可观测性）
4. ✅ InfluxDB v2导出（功能正确性）

### P1优化验证
1. ✅ 重试机制（稳定性）
2. ✅ 健康检查（可观测性）

---

## 测试环境准备

### 1. 基础环境
```powershell
# 确保在项目根目录
cd F:\OFICVD

# 设置基础环境变量
$env:V13_REPLAY_MODE = "0"
$env:V13_SINK = "dual"
$env:REPORT_TZ = "Asia/Tokyo"
```

### 2. 时序库环境（可选）

**Prometheus Pushgateway**:
```powershell
# 启动Pushgateway（如果未运行）
docker run -d -p 9091:9091 prom/pushgateway

# 设置环境变量
$env:TIMESERIES_ENABLED = "1"
$env:TIMESERIES_TYPE = "prometheus"
$env:TIMESERIES_URL = "http://localhost:9091"
```

**InfluxDB v2**（可选）:
```powershell
# 设置InfluxDB v2环境变量
$env:INFLUX_URL = "http://localhost:8086"
$env:INFLUX_ORG = "myorg"
$env:INFLUX_BUCKET = "mybucket"
$env:INFLUX_TOKEN = "your-token-here"
$env:TIMESERIES_ENABLED = "1"
$env:TIMESERIES_TYPE = "influxdb"
```

---

## 测试步骤

### 测试1: 3分钟冒烟测试（综合验证）

**目的**: 验证所有修复的整体效果

**执行**:
```powershell
# 方式1: 使用自动化脚本
.\scripts\run_p0p1_verification_test.ps1

# 方式2: 手动执行
python -m orchestrator.run `
  --config ./config/defaults.yaml `
  --enable harvest,signal,broker,report `
  --sink dual `
  --minutes 3
```

**验证项**:
1. ✅ 进程正常启动和关闭
2. ✅ SQLite关闭日志包含flush数和关闭顺序
3. ✅ 健康检查日志（如果启用了时序库）
4. ✅ run_manifest生成且包含完整信息
5. ✅ 无错误或异常退出

**预期结果**:
- 退出码: 0
- 日志包含: `[SqliteSink] 关闭完成：已刷新剩余批次X条数据`
- 日志包含: `[timeseries.health] Pushgateway可达`（如果启用了时序库）

---

### 测试2: MultiSink数据一致性验证

**目的**: 验证MultiSink循环内copy修复，确保JSONL和SQLite字段独立

**执行**:
```powershell
# 运行parity检查
python scripts/verify_sink_parity.py --run-id <RUN_ID>
```

**验证项**:
1. ✅ JSONL和SQLite的字段应该独立
2. ✅ 检查`created_at`、`_writer`等字段是否独立
3. ✅ 差异应该 < 0.25%

**预期结果**:
- Parity差异 < 0.25%
- JSONL和SQLite的字段值独立（不会互相影响）

**检查方法**:
```python
# 检查JSONL和SQLite的created_at字段是否独立
# 如果MultiSink修复正确，两个Sink的created_at应该可能不同
```

---

### 测试3: JSONL尾批fsync验证

**目的**: 验证JSONL在minute切换时（rotate）是否正确fsync

**执行**:
```powershell
# 运行测试，在minute切换边界检查
python -m orchestrator.run `
  --config ./config/defaults.yaml `
  --enable harvest,signal `
  --sink jsonl `
  --minutes 3
```

**验证项**:
1. ✅ 检查JSONL文件是否完整（无截断）
2. ✅ 在minute切换时验证文件完整性
3. ✅ 检查日志中是否有fsync相关错误

**检查方法**:
```powershell
# 检查JSONL文件完整性
Get-ChildItem -Path "runtime\ready\signal\*\signals_*.jsonl" | 
  ForEach-Object {
    $lines = Get-Content $_.FullName -Encoding UTF-8
    $lastLine = $lines[-1]
    try {
      $json = $lastLine | ConvertFrom-Json
      Write-Host "$($_.Name): ✅ 完整" -ForegroundColor Green
    } catch {
      Write-Host "$($_.Name): ❌ 可能截断" -ForegroundColor Red
    }
  }
```

**预期结果**:
- 所有JSONL文件完整（最后一行是有效的JSON）
- 无文件截断或损坏

---

### 测试4: SQLite关闭日志验证

**目的**: 验证SQLite关闭路径日志输出

**执行**:
```powershell
# 运行测试后检查日志
Get-Content "logs\signal\signal_stderr.log" -Tail 50 -Encoding UTF-8 | 
  Select-String "关闭|flush|checkpoint"
```

**验证项**:
1. ✅ 日志包含: `[SqliteSink] 关闭时刷新剩余批次: X条数据`
2. ✅ 日志包含: `[SqliteSink] 关闭完成：已刷新剩余批次X条数据，WAL检查点已执行`
3. ✅ 关闭顺序正确: 刷新批次 → WAL检查点 → 关闭连接

**预期结果**:
- 日志清晰显示关闭顺序和flush数
- 便于Soak Test验证

---

### 测试5: InfluxDB v2导出验证

**目的**: 验证InfluxDB v2标准写入（Line Protocol + API v2）

**前置条件**:
- InfluxDB v2服务运行
- 配置了INFLUX_URL、INFLUX_ORG、INFLUX_BUCKET、INFLUX_TOKEN

**执行**:
```powershell
# 设置环境变量
$env:INFLUX_URL = "http://localhost:8086"
$env:INFLUX_ORG = "myorg"
$env:INFLUX_BUCKET = "mybucket"
$env:INFLUX_TOKEN = "your-token"
$env:TIMESERIES_ENABLED = "1"
$env:TIMESERIES_TYPE = "influxdb"

# 运行测试
python scripts/test_timeseries_export_task07a.py
```

**验证项**:
1. ✅ 导出使用Line Protocol格式
2. ✅ API端点正确: `/api/v2/write?org=...&bucket=...&precision=ns`
3. ✅ 认证头正确: `Authorization: Token ...`
4. ✅ 数据成功写入InfluxDB

**检查方法**:
```powershell
# 检查日志中的导出信息
Get-Content "logs\orchestrator\orchestrator.log" -Tail 100 -Encoding UTF-8 | 
  Select-String "InfluxDB|timeseries"
```

**预期结果**:
- `export_count >= 5`（5分钟测试）
- `error_count = 0`
- InfluxDB中能看到数据

---

### 测试6: 重试机制验证

**目的**: 验证Prometheus/InfluxDB导出的重试机制

**执行**:
```powershell
# 方式1: 停止Pushgateway，运行测试，观察重试日志
docker stop <pushgateway-container>

# 运行测试
python -m orchestrator.run `
  --config ./config/defaults.yaml `
  --enable harvest,signal,broker,report `
  --sink dual `
  --minutes 1

# 检查日志
Get-Content "logs\orchestrator\orchestrator.log" -Tail 100 -Encoding UTF-8 | 
  Select-String "重试|retry|Prometheus|InfluxDB"
```

**验证项**:
1. ✅ 重试3次（如果失败）
2. ✅ 退避时间: 0.5s, 1s, 2s
3. ✅ 重试日志清晰

**预期结果**:
- 日志包含: `[timeseries] Prometheus导出失败（第1次尝试）...，0.5秒后重试`
- 日志包含: `[timeseries] Prometheus导出失败（第2次尝试）...，1秒后重试`
- 日志包含: `[timeseries] Prometheus导出失败（已重试3次）`

---

### 测试7: 健康检查验证

**目的**: 验证启动期健康检查功能

**执行**:
```powershell
# 启用时序库导出
$env:TIMESERIES_ENABLED = "1"
$env:TIMESERIES_TYPE = "prometheus"
$env:TIMESERIES_URL = "http://localhost:9091"

# 运行测试
python -m orchestrator.run `
  --config ./config/defaults.yaml `
  --enable harvest,signal,broker,report `
  --sink dual `
  --minutes 1

# 检查启动日志
Get-Content "logs\orchestrator\orchestrator.log" -Head 50 -Encoding UTF-8 | 
  Select-String "timeseries.health"
```

**验证项**:
1. ✅ 启动时执行健康检查
2. ✅ 连接成功时输出: `[timeseries.health] Pushgateway可达`
3. ✅ 连接失败时输出诊断信息（域名解析/连通性/认证缺失）

**预期结果**:
- 启动日志包含健康检查信息
- 连接失败时有明确的诊断信息

---

## 测试检查清单

### 日志检查
- [ ] SQLite关闭日志包含flush数和关闭顺序
- [ ] 健康检查日志（如果启用了时序库）
- [ ] 重试日志（如果导出失败）
- [ ] 无错误或异常日志

### 数据检查
- [ ] JSONL文件完整（无截断）
- [ ] SQLite数据库完整
- [ ] JSONL和SQLite字段独立（MultiSink修复）
- [ ] Parity差异 < 0.25%

### 功能检查
- [ ] 时序库导出成功（如果配置了）
- [ ] 重试机制工作正常
- [ ] 健康检查工作正常

---

## 快速测试命令

### 一键运行所有验证
```powershell
# 运行自动化验证脚本
.\scripts\run_p0p1_verification_test.ps1

# 运行parity检查
python scripts/verify_sink_parity.py --run-id <RUN_ID>

# 检查日志
Get-Content "logs\signal\signal_stderr.log" -Tail 50 -Encoding UTF-8 | Select-String "关闭"
Get-Content "logs\orchestrator\orchestrator.log" -Tail 100 -Encoding UTF-8 | Select-String "timeseries"
```

---

## 预期测试结果

### 成功标准
1. ✅ 所有测试通过（退出码0）
2. ✅ 日志输出符合预期
3. ✅ 数据一致性验证通过
4. ✅ 功能正常工作

### 失败处理
- 如果测试失败，检查日志文件定位问题
- 参考修复实施总结文档排查问题
- 必要时回滚修复

---

## 测试报告模板

测试完成后，请填写以下信息：

```
测试日期: YYYY-MM-DD
测试人员: XXX
测试环境: Windows/Linux/macOS

测试结果:
- 测试1 (3分钟冒烟): ✅/❌
- 测试2 (MultiSink一致性): ✅/❌
- 测试3 (JSONL fsync): ✅/❌
- 测试4 (SQLite关闭日志): ✅/❌
- 测试5 (InfluxDB v2): ✅/❌/跳过
- 测试6 (重试机制): ✅/❌
- 测试7 (健康检查): ✅/❌/跳过

问题记录:
- 问题1: ...
- 问题2: ...

结论:
- 所有修复验证通过/部分通过/失败
```

---

**测试计划创建时间**: 2025-11-09  
**测试状态**: 📋 待执行

