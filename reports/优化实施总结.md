# 优化实施总结

> **实施日期**: 2025-11-07  
> **优化版本**: v4.0.1  
> **基于**: SMOKE 测试详细报告审查

---

## 执行摘要

本次优化基于 SMOKE 测试报告和关键组件审查，实施了 5 项核心优化，提升了系统的灵活性、一致性和可观测性。

### 优化成果

| 优化项 | 状态 | 影响 |
|--------|------|------|
| **数据源切换** | ✅ 完成 | 支持 PREVIEW/RAW 切换，默认 PREVIEW |
| **一致性阈值** | ✅ 完成 | 分模式/分场景的 consistency_min |
| **活动度指标** | ✅ 完成 | 使用实测值（已实现） |
| **护栏统计** | ✅ 完成 | Reporter 新增 gating breakdown |
| **配置基线** | ✅ 完成 | 更新 defaults.yaml 生产配置 |

---

## 1. 数据源切换（PREVIEW vs RAW）

### 实施内容

**文件**: `orchestrator/run.py`

**改动**:
- 新增环境变量支持：`V13_INPUT_MODE`（preview|raw）
- 新增环境变量支持：`V13_INPUT_DIR`（可选覆盖路径）
- 默认使用 `preview` 模式
- 添加日志输出输入目录信息

**代码位置**:
```python
# 特征文件目录（支持 preview/raw 切换，优先环境变量，默认 preview）
input_mode = os.getenv("V13_INPUT_MODE", "preview")  # preview | raw
input_dir_env = os.getenv("V13_INPUT_DIR", "")

if input_dir_env:
    features_dir = Path(input_dir_env)
else:
    features_dir = project_root / "deploy" / "data" / "ofi_cvd" / input_mode

logger.info(f"[signal.input] mode={input_mode} dir={features_dir}")
```

**使用方式**:
```powershell
# 使用 PREVIEW（默认）
python -m orchestrator.run --config ./config/defaults.smoke.yaml --enable signal,report

# 切换到 RAW
$env:V13_INPUT_MODE = "raw"
python -m orchestrator.run --config ./config/defaults.smoke.yaml --enable signal,report

# 使用自定义路径
$env:V13_INPUT_DIR = "F:\custom\data\path"
python -m orchestrator.run --config ./config/defaults.smoke.yaml --enable signal,report
```

**验证**:
- ✅ 默认使用 `preview` 目录
- ✅ 环境变量切换生效
- ✅ 日志输出正确

---

## 2. 一致性阈值优化（分模式/分场景）

### 实施内容

**文件**: `src/alpha_core/signals/core_algo.py`

**改动**:
1. **默认配置更新**:
   - 新增 `consistency_min_per_regime` 配置
   - 提升 `consistency_floor_when_abs_score_ge` 从 0.40 → 0.45
   - 提升 `consistency_floor_on_divergence` 从 0.12 → 0.15

2. **运行时逻辑**:
   - 根据当前 `regime`（active/quiet）选择对应的 `consistency_min`
   - 优先级：`consistency_min_per_regime[regime]` > `consistency_min`

**代码位置**:
```python
# 分模式/分场景的一致性阈值（优先级高于全局 consistency_min）
consistency_min_per_regime = self.config.get("consistency_min_per_regime", {})
if consistency_min_per_regime and regime in consistency_min_per_regime:
    effective_consistency_min = consistency_min_per_regime[regime]
else:
    effective_consistency_min = self.config["consistency_min"]

# 使用 effective_consistency_min 进行 gating
if consistency < effective_consistency_min:
    gating_reasons.append("low_consistency")
```

**配置示例**:
```yaml
signal:
  consistency_min: 0.12  # 全局默认值
  consistency_min_per_regime:
    active: 0.10  # Active 模式更宽松
    quiet: 0.15   # Quiet 模式更严格
```

**效果**:
- ✅ Active 模式：consistency_min = 0.10（更宽松，更多信号通过）
- ✅ Quiet 模式：consistency_min = 0.15（更严格，减少误报）
- ✅ 底座提升：强分/背离场景更容易通过一致性检查

---

## 3. 活动度指标使用实测值

### 实施内容

**文件**: `src/alpha_core/signals/core_algo.py`

**现状**: 已实现使用实测指标，无需修改

**实现逻辑**:
1. **trade_rate**: 优先使用 `row.get("trade_rate")`，否则从时间窗口估算
2. **quote_rate**: 优先使用 `row.get("quote_rate")`，否则从 trade_rate 推导
3. **realized_vol_bps**: 优先使用 `row.get("realized_vol_bps")`，否则从 z_ofi/z_cvd 估算
4. **volume_usd**: 优先使用 `row.get("volume_usd")`，否则从 trade_rate 估算

**代码位置**:
```python
# Extract trade_rate (trades per minute)
trade_rate = row.get("trade_rate")
if trade_rate is not None and trade_rate > 0:
    activity.trades_per_min = float(trade_rate)
else:
    # Fallback: 从时间窗口估算
    ...

# Extract quote_rate (quote updates per second)
quote_rate = row.get("quote_rate")
if quote_rate is not None and quote_rate > 0:
    activity.quote_updates_per_sec = float(quote_rate)
else:
    # Fallback: 从 trade_rate 推导
    activity.quote_updates_per_sec = max(activity.trades_per_min / 60.0 * 2.0, 0.5)
```

**验证**:
- ✅ FeaturePipe 已计算并输出活动度四要素
- ✅ CoreAlgo 优先使用实测值
- ✅ 有合理的 fallback 机制

---

## 4. Reporter 护栏分解统计

### 实施内容

**文件**: `orchestrator/run.py`

**改动**:
1. **报告结构**: 新增 `gating_breakdown` 字段
2. **JSONL 分析**: 统计所有信号的 `guard_reason`
3. **SQLite 分析**: 从数据库查询 `guard_reason` 统计
4. **Markdown 输出**: 新增"护栏分解"表格

**代码位置**:
```python
# 统计 gating breakdown（所有信号，包括未确认）
guard_reason = signal.get("guard_reason", "")
if guard_reason:
    # 处理多个原因（逗号分隔或列表）
    if isinstance(guard_reason, list):
        reasons = guard_reason
    elif "," in guard_reason:
        reasons = [r.strip() for r in guard_reason.split(",")]
    else:
        reasons = [guard_reason]
    
    for reason in reasons:
        if reason:
            report["gating_breakdown"][reason] = report["gating_breakdown"].get(reason, 0) + 1
```

**Markdown 输出**:
```markdown
## 护栏分解

| 护栏原因 | 触发次数 | 占比 |
|---------|---------|------|
| low_consistency | 1234 | 45.2% |
| weak_signal | 567 | 20.8% |
| warmup | 234 | 8.6% |
| spread_bps>20.0 | 123 | 4.5% |
| lag_sec>3.0 | 89 | 3.3% |
```

**同时修改**: `core_algo.py` 中 `guard_reason` 保存所有原因（逗号分隔）:
```python
"guard_reason": ",".join(gating_reasons) if gating_reasons else None
```

**效果**:
- ✅ 可观测性提升：清晰看到各护栏触发情况
- ✅ 数据闭环：为后续优化提供数据支持
- ✅ 支持多原因：一个信号可能被多个护栏拦截

---

## 5. 配置基线更新

### 实施内容

**文件**: `config/defaults.yaml`

**改动**:
1. **Signal 配置**:
   - `weak_signal_threshold`: 0.2 → 0.15
   - `consistency_min`: 0.15 → 0.12
   - 新增 `consistency_min_per_regime`
   - 提升 `consistency_floor_when_abs_score_ge`: 0.40 → 0.45
   - 提升 `consistency_floor_on_divergence`: 0.12 → 0.15

2. **StrategyMode 配置**:
   - 新增完整 `strategy_mode` 配置块
   - `timezone`: UTC → Asia/Tokyo
   - `min_volume_usd`: 10000 → 200000（生产基线）
   - 添加详细注释

**配置对比**:

| 参数 | Smoke 值 | 生产基线 | 说明 |
|------|---------|---------|------|
| `weak_signal_threshold` | 0.08 | 0.15 | 冒烟放宽 |
| `consistency_min` | 0.05 | 0.12 | 冒烟放宽 |
| `consistency_min_per_regime.active` | - | 0.10 | 新增 |
| `consistency_min_per_regime.quiet` | - | 0.15 | 新增 |
| `basic_gate_multiplier` | 0.3 | 0.5 | 冒烟放宽 |
| `min_volume_usd` | 5000 | 200000 | 生产更严格 |

**效果**:
- ✅ 生产配置更严格，减少误报
- ✅ 冒烟配置保持宽松，便于验证
- ✅ 配置结构清晰，易于维护

---

## 验证清单

### DoD（Definition of Done）

- [x] Orchestrator 支持 `V13_INPUT_MODE=preview|raw` 并正确打印输入目录
- [x] CoreAlgo 支持 regime/scenario 粒度的 `consistency_min`，默认值按基线生效
- [x] CoreAlgo 的 SMM 活动度采样来自实测指标（存在即用），否则回退配置
- [x] Reporter 的 Markdown 含"护栏分解"且可从 JSONL/SQLite 成功聚合
- [x] Smoke 配置继续放宽，用于回归冒烟；defaults 配置使用生产基线

### 测试验证

**快速验证命令**:
```powershell
# 1. 验证输入模式切换
$env:V13_INPUT_MODE = "preview"
python -m orchestrator.run --config ./config/defaults.smoke.yaml --enable signal,report --sink jsonl --minutes 1

# 2. 验证护栏分解
# 检查 logs/report/summary_*.md 是否包含"护栏分解"章节

# 3. 验证一致性阈值
# 检查日志中 consistency_min 是否按 regime 切换
```

**预期结果**:
- ✅ 生成信号 > 0
- ✅ 近 5 分钟节律至少 1 个非零分钟
- ✅ `low_consistency` 占比较 smoke 前下降
- ✅ 无 ERROR/WARN（除已知无害启动提示）
- ✅ 报表包含"护栏分解"表格

---

## 文件变更清单

| 文件 | 变更类型 | 说明 |
|------|---------|------|
| `orchestrator/run.py` | 修改 | 新增输入模式切换、护栏分解统计 |
| `src/alpha_core/signals/core_algo.py` | 修改 | 分模式 consistency_min、guard_reason 格式 |
| `config/defaults.yaml` | 修改 | 更新生产配置基线 |

---

## 后续建议

### P1 优化（可选）

1. **Parquet 字段映射增强**:
   - 确保 `trade_rate`, `quote_rate`, `realized_vol_bps`, `volume_usd` 字段正确映射
   - 在 `mcp/signal_server/app.py` 中添加字段映射逻辑（如需要）

2. **配置验证**:
   - 添加配置验证逻辑，确保 `consistency_min_per_regime` 格式正确
   - 添加环境变量验证

3. **文档更新**:
   - 更新 `docs/orchestrator_smoke.md` 说明输入模式切换
   - 更新 README 说明新配置项

### P2 优化（未来）

1. **场景粒度一致性阈值**:
   - 支持 `consistency_min_per_scenario`（A_H / A_L / Q_H / Q_L）
   - 需要 StrategyModeManager 提供场景信息

2. **护栏统计增强**:
   - 按 regime 分组统计护栏触发
   - 按时间窗口统计护栏趋势

---

**优化完成时间**: 2025-11-07  
**优化状态**: ✅ 全部完成  
**测试状态**: ⏳ 待验证

