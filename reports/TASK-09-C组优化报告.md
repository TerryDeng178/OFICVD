# TASK-09 C组优化报告

**组别**: C组（Maker-first成本压降）  
**目标**: cost_bps_on_turnover ≤1.75bps，各场景Maker比例达到目标区间  
**报告时间**: 2025-11-10

---

## 一、组别定位与策略

### 1.1 核心策略
C组专注于**Maker-first成本压降**，通过以下手段降低交易成本：
- **Maker-first费率模型**: 启用`fee_model: maker_taker`，优先使用Maker费率
- **场景化Maker概率**: 针对不同场景（Q_L, A_L, A_H, Q_H）设置不同的Maker概率
- **Scenario标准化**: 统一scenario格式（如`A_H_unknown` → `A_H`），确保正确匹配
- **滑点模型优化**: 使用`piecewise`滑点模型，降低滑点成本
- **场景化滑点倍数**: 针对不同场景设置不同的滑点倍数

### 1.2 关键配置参数

```yaml
backtest:
  fee_model: maker_taker              # Maker-first费率模型
  fee_maker_taker:
    maker_fee_ratio: 0.4              # Maker费率比例（从0.5降到0.4）
    scenario_probs:                    # 场景化Maker概率
      Q_L: 0.85                        # 低量安静期：85%（从0.80提高到0.85）
      A_L: 0.75                        # 低量活跃期：75%（从0.70提高到0.75）
      A_H: 0.50                        # 高量活跃期：50%（维持）
      Q_H: 0.40                        # 高量安静期：40%（从0.35提高到0.40）
      default: 0.50                    # 默认：50%（兜底）

  slippage_model: piecewise           # 分段滑点模型
  slippage_piecewise:
    spread_base_multiplier: 0.7       # 基础滑点倍数（从0.8降到0.7）
    scenario_multipliers:             # 场景化滑点倍数
      Q_L: 0.6                         # 低量安静期：0.6
      A_L: 0.8                         # 低量活跃期：0.8
      A_H: 1.0                         # 高量活跃期：1.0
      Q_H: 1.2                         # 高量安静期：1.2
```

---

## 二、历史测试数据

### 2.1 基线数据（深层修复验证前）

| 指标 | 基线值 |
|------|--------|
| **交易频率** | 934.0笔/小时 |
| **平均持仓** | 164.0秒 |
| **成本bps** | 1.93bps |
| **单笔收益** | -$0.82 |
| **胜率** | 16.81% |
| **总交易数** | 934笔 |
| **Maker比例** | 57.15% |

### 2.2 历史测试记录

#### 测试1: group_c_validation (2025-11-10 12:21, 12:47)
| 指标 | 结果 | 相对基线变化 |
|------|------|--------------|
| **交易频率** | 934.0笔/小时 | 0.0% |
| **平均持仓** | 164.0秒 | 0.0% |
| **成本bps** | 1.93bps | 0.0% |
| **单笔收益** | -$0.82 | 0.0% |
| **胜率** | 16.81% | 0.0% |
| **总交易数** | 934笔 |
| **Maker比例** | 57.15% |
| **综合评分** | 8.57 |

**问题**: 配置未生效，结果与基线完全相同

#### 测试2: group_c_fixed_validation (2025-11-10 14:06) - 修复后
| 指标 | 结果 | 相对基线变化 |
|------|------|--------------|
| **交易频率** | 934.0笔/小时 | 0.0% |
| **平均持仓** | 164.0秒 | 0.0% |
| **成本bps** | 1.93bps | +0.1% |
| **单笔收益** | -$0.82 | 0.0% |
| **胜率** | 16.81% | 0.0% |
| **总交易数** | 934笔 |
| **Maker比例** | 57.15% |
| **综合评分** | 8.57 |

**修复效果**: 
- ✅ Scenario标准化已生效（100%命中）
- ✅ 所有scenario都能正确匹配（0个miss）
- ⚠️ 成本bps未下降（可能因为交易频率未下降）
- ⚠️ Maker比例57.15%，但目标区间未完全达到

#### 测试3: group_c_optimized_validation (2025-11-10 15:21) - 优化后
| 指标 | 结果 | 相对基线变化 |
|------|------|--------------|
| **交易频率** | 934.0笔/小时 | 0.0% |
| **平均持仓** | 202.3秒 | +23.4% |
| **成本bps** | 1.93bps | +0.1% |
| **单笔收益** | -$0.82 | 0.0% |
| **胜率** | 16.81% | 0.0% |
| **总交易数** | 934笔 |
| **Maker比例** | 57.14% |
| **综合评分** | 10.91 |

**优化效果**: 
- ✅ Scenario标准化已生效（100%命中）
- ⚠️ 成本bps未下降（仍为1.93bps）
- ⚠️ Maker比例57.14%，但目标区间未完全达到
- ⚠️ 交易频率未下降，可能抵消了Maker费率优势

---

## 三、最优配置分析

### 3.1 最优测试结果

**最优配置**: `group_c_optimized_validation` (2025-11-10 15:21)

| 指标 | 最优值 | 目标 | 状态 |
|------|--------|------|------|
| **交易频率** | 934.0笔/小时 | - | ⚠️ 未下降 |
| **平均持仓** | 202.3秒 | - | ⚠️ 略有提升 |
| **成本bps** | 1.93bps | ≤1.75bps | ❌ 未达标 |
| **单笔收益** | -$0.82 | ≥0 | ❌ 未达标 |
| **胜率** | 16.81% | - | ⚠️ 持平 |
| **Maker比例** | 57.14% | 目标区间 | ⚠️ 部分达标 |

### 3.2 最优配置参数

基于最优测试结果，推荐配置：

```yaml
backtest:
  fee_model: maker_taker              # Maker-first费率模型
  fee_maker_taker:
    maker_fee_ratio: 0.4              # Maker费率比例
    scenario_probs:                    # 场景化Maker概率
      Q_L: 0.85                        # 低量安静期：85%
      A_L: 0.75                        # 低量活跃期：75%
      A_H: 0.50                        # 高量活跃期：50%
      Q_H: 0.40                        # 高量安静期：40%
      default: 0.50                    # 默认：50%

  slippage_model: piecewise           # 分段滑点模型
  slippage_piecewise:
    spread_base_multiplier: 0.7       # 基础滑点倍数
    scenario_multipliers:             # 场景化滑点倍数
      Q_L: 0.6                         # 低量安静期：0.6
      A_L: 0.8                         # 低量活跃期：0.8
      A_H: 1.0                         # 高量活跃期：1.0
      Q_H: 1.2                         # 高量安静期：1.2
```

---

## 四、优化方向

### 4.1 当前问题

1. **成本bps未改善**: 1.93bps vs 目标≤1.75bps
   - 原因：交易频率未下降（934笔/小时），抵消了Maker费率优势
   - 建议：需要结合A组的严门控策略，降低交易频率

2. **Maker比例未完全达标**: 57.14% vs 目标区间
   - 原因：大部分交易是A_H场景（934笔），A_H的配置目标是0.5，实际可能略高
   - 建议：检查A_H场景的maker概率计算逻辑

3. **交易频率未下降**: 934笔/小时（与基线持平）
   - 原因：C组专注于成本优化，未涉及交易频率控制
   - 建议：结合A组的严门控策略

### 4.2 优化建议

#### 方向1: 结合A组严门控策略
- **提高`weak_signal_threshold`**: 0.35 → 0.7
- **提高`consistency_min`**: 0.25 → 0.40
- **增加`dedupe_ms`**: 默认 → 4000ms或5000ms
- **启用`ignore_gating_in_backtest: false`**: 确保门控生效

**预期效果**: 交易频率下降至200-400笔/小时，成本bps下降至1.75bps以下

#### 方向2: 优化Maker概率配置
- **提高`scenario_probs.Q_L`**: 0.85 → 0.90
- **提高`scenario_probs.A_L`**: 0.75 → 0.80
- **检查A_H场景**: 验证maker概率计算逻辑
- **优化`maker_fee_ratio`**: 0.4 → 0.35或0.3

**预期效果**: Maker比例提升至60-70%，成本bps下降

#### 方向3: 优化滑点模型
- **降低`spread_base_multiplier`**: 0.7 → 0.6或0.5
- **优化`scenario_multipliers`**: 进一步降低Q_L和A_L场景的滑点
- **添加post-only近似**: 当spread_bps ≤ 1.0时允许负滑点

**预期效果**: 滑点成本下降，总成本bps下降

#### 方向4: 场景分布优化
- **分析场景分布**: 了解各场景的实际交易占比
- **针对性优化**: 针对高频场景（如A_H）进一步优化
- **动态调整**: 根据市场状态动态调整Maker概率

**预期效果**: 成本bps下降至1.75bps以下

---

## 五、下一步行动

### 5.1 立即行动

1. **结合A组严门控策略**:
   - 提高`weak_signal_threshold`到0.7
   - 提高`consistency_min`到0.40
   - 增加`dedupe_ms`到4000ms

2. **优化Maker概率配置**:
   - 检查A_H场景的maker概率计算逻辑
   - 提高Q_L和A_L场景的Maker概率

3. **优化滑点模型**:
   - 降低`spread_base_multiplier`到0.6
   - 优化`scenario_multipliers`配置

### 5.2 后续优化

1. **参数微调**: 根据验证结果进一步调整参数
2. **长时间验证**: 对最优配置运行4小时稳定性验证
3. **组合优化**: 尝试组合C+A或C+B，结合成本优化和严门控/冷却

---

## 六、关键指标总结

| 指标 | 基线 | 最优 | 变化 | 目标 | 状态 |
|------|------|------|------|------|------|
| **交易频率** | 934.0 | 934.0 | 0.0% | - | ⚠️ 未下降 |
| **平均持仓** | 164.0 | 202.3 | +23.4% | - | ⚠️ 略有提升 |
| **成本bps** | 1.93 | 1.93 | 0.0% | ≤1.75 | ❌ 未达标 |
| **单笔收益** | -$0.82 | -$0.82 | 0.0% | ≥0 | ❌ 未达标 |
| **胜率** | 16.81% | 16.81% | 0.0% | - | ⚠️ 持平 |
| **Maker比例** | 57.15% | 57.14% | -0.0% | 目标区间 | ⚠️ 部分达标 |

---

## 七、Scenario标准化效果

### 7.1 Scenario标准化统计

- **标准化命中率**: 100%（所有scenario都能正确匹配）
- **Scenario分布**: 
  - A_H_unknown: 934笔（标准化为A_H）
  - 其他场景: 0笔

### 7.2 Scenario标准化实现

```python
# trade_sim.py
def _normalize_scenario(s: str) -> str:
    if not s:
        return "unknown"
    parts = s.split("_")
    if len(parts) >= 2:
        return f"{parts[0]}_{parts[1]}"  # A_H_unknown -> A_H
    return s
```

**效果**: 确保所有scenario都能正确匹配到配置的Maker概率

---

**报告生成时间**: 2025-11-10  
**报告版本**: v1.0

