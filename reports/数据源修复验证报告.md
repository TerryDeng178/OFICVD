# 数据源修复验证报告

> **修复日期**: 2025-11-07  
> **修复方案**: 方案 1 + 方案 2

## 修复内容

### A) 修正 Orchestrator 输入目录 ✅

**修改文件**: `orchestrator/run.py`

**变更**:
```python
# 修复前
features_dir = project_root / "deploy" / "data" / "ofi_cvd" / "preview" / "features"

# 修复后
features_dir = project_root / "deploy" / "data" / "ofi_cvd" / "preview"
```

**效果**:
- ✅ 输入目录改为 `preview/` 根目录
- ✅ Signal Server 可以递归扫描分区文件（`date/hour/symbol/kind=features/`）

### B) Signal Server 支持 Parquet + JSONL ✅

**修改文件**: `mcp/signal_server/app.py`

**变更**:
1. **导入 pandas**:
   ```python
   try:
       import pandas as pd
       PANDAS_AVAILABLE = True
   except ImportError:
       PANDAS_AVAILABLE = False
   ```

2. **更新 `iter_feature_rows` 函数**:
   - 同时查找 `*.jsonl` 和 `*.parquet` 文件
   - Parquet 文件使用 `pandas.read_parquet()` 读取
   - 处理 NaN 值转换为 None
   - 保持 JSONL 文件原有逻辑

3. **更新 watch 模式**:
   - 监听模式同时扫描 JSONL 和 Parquet 文件
   - 按文件后缀分派处理逻辑

**效果**:
- ✅ 支持 Parquet 文件读取
- ✅ 保持 JSONL 文件兼容性
- ✅ 自动处理 NaN 值
- ✅ 错误处理完善

## 验证结果

### 数据源检查

```
=== Data Source Check ===

1. Preview directory exists: True
2. File types:
   JSONL files: 0
   Parquet files: 60,669
3. Feature files:
   Parquet (kind=features): 12,743
   JSONL (features): 0
4. Latest file: part-1762520100000-1762520157000-56-c81a9fc9.parquet
   Modified: 2025-11-07 20:56:00
   Size: 17,054 bytes
5. Recent files (last 10 min): 120
```

### 格式支持验证

- ✅ **Parquet 文件**: 12,743 个特征文件
- ✅ **pandas 可用**: 版本 2.2.2
- ✅ **路径配置**: `preview/` 根目录
- ✅ **递归扫描**: 支持分区结构

### 代码检查

- ✅ **无语法错误**: Linter 通过
- ✅ **导入检查**: pandas 可选导入
- ✅ **错误处理**: 完善的异常处理
- ✅ **向后兼容**: JSONL 文件仍支持

## 验收要点

### ✅ 1. 数据源可发现

- [x] `check_data_source.py` 能在 PREVIEW 下发现 Parquet 文件
- [x] 文件数量：12,743 个特征文件
- [x] 路径结构：`preview/date=.../hour=.../symbol=.../kind=features/`

### ✅ 2. Signal Server 可消费

- [x] 支持 Parquet 文件读取
- [x] 支持 JSONL 文件读取（向后兼容）
- [x] 递归扫描分区文件
- [x] 处理 NaN 值

### ✅ 3. Orchestrator 配置正确

- [x] 输入目录改为 `preview/` 根
- [x] 不再依赖固定 `preview/features/` 路径
- [x] 支持分区结构扫描

### ⏳ 4. 端到端验证（待运行）

- [ ] 运行 orchestrator 测试
- [ ] 验证 `total > 0`（不再出现 QUIET_RUN）
- [ ] 验证信号生成正常

## 下一步

运行端到端测试验证修复效果：

```powershell
python -m orchestrator.run --config ./config/defaults.smoke.yaml --enable harvest,signal,broker,report --sink jsonl --minutes 2
```

**预期结果**:
- Signal Server 能读取 Parquet 文件
- 生成信号（`total > 0`）
- 不再出现 `QUIET_RUN` 警告（如果有数据）

## 技术细节

### Parquet 读取实现

```python
df = pd.read_parquet(file_path)
for _, row in df.iterrows():
    record = row.to_dict()
    # 处理 NaN 值
    record = {k: (None if pd.isna(v) else v) for k, v in record.items()}
    yield record
```

### 文件扫描逻辑

```python
# 递归查找 JSONL 和 Parquet 文件
jsonl_files = sorted(path.rglob("*.jsonl"))
parquet_files = sorted(path.rglob("*.parquet")) if PANDAS_AVAILABLE else []
candidates = jsonl_files + parquet_files
```

### 错误处理

- pandas 未安装时跳过 Parquet 文件
- 文件读取失败时记录错误并继续
- JSON 解析错误时跳过该行

## 总结

✅ **修复完成**

- Orchestrator 输入目录已修正
- Signal Server 已支持 Parquet 格式
- 数据流保持"特征→信号→Sink"不变
- 向后兼容 JSONL 格式

**最小变更原则**:
- 只修改必要的代码
- 保持向后兼容
- 添加完善的错误处理
- 不影响现有功能

