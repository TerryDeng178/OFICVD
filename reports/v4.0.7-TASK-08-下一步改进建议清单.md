# TASK-08 下一步改进建议清单（v4.0.7）

**报告时间**: 2025-11-10  
**版本**: v4.0.7  
**优先级**: P1（4项）+ 代码层改进（6项）+ CI/测试（2项）

---

## 一、总览结论

✅ **当前状态**: 回放/回测 Harness 的关键风险点基本被"对齐 & 回归测试"覆盖，当前框架可作为后续 CI 的稳定基线。

✅ **已具备能力**:
- Feeder 已将对齐质量位与场景上下文附加到 signal（_feature_data）
- 融合与闸门已经支持一致性阈值与弱信号节流的分场景控制
- Gate 统计双跑基线能力已具备

---

## 二、P1优先级改进（4项）

### P1.1 Gate统计双跑基线（加到CI）

**问题描述**:  
同一数据窗口，跑两遍（ignore_gating_in_backtest = true/false），收集 CoreAlgo 的 gate_reason 计数与"passed"差值，若超阈值（如 >3%）则 CI 失败。

**实施要点**:
1. 从 JSONL/SQLite 信号产物或统计心跳里拉 gate 快照（CoreAlgo 每 ~10s 记录一次）
2. 把对比脚本纳入 `.github/workflows/gate-baseline.yml`，阈值、窗口、标的作为矩阵参数
3. 依据场景/模式做分桶（quiet/active），避免场景偏移误判

**依据**: CoreAlgo 内置 gate 计数（weak_signal_throttle / low_consistency / passed）完备，满足对比需要。

**优先级**: 🔴 P1 - 高优先级

---

### P1.2 PnL切日与时区回归测试（补充样例）

**问题描述**:  
报告显示切日边界已通过，但建议加入跨时区对照（如 Asia/Tokyo 与 UTC 双样例），验证结转到下一日的"last bar close → next day open"一致性。

**实施要点**:
1. 加入跨时区对照（Asia/Tokyo vs UTC）
2. 验证结转到下一日的"last bar close → next day open"一致性
3. 兼容策略模式时间表：策略管理器默认含亚洲时区/加密日历配置，回测时区应与之匹配或显式覆盖

**优先级**: 🔴 P1 - 高优先级

---

### P1.3 滑点/费用"情境化"落地（先MVP，再迭代）

**问题描述**:  
Feeder 已把场景上下文下沉到每条 signal，TradeSim 只需读取 _feature_data 实现分场景滑点/费率曲线。

**实施要点**:
1. 先做两层 piecewise：
   - scenario_2x2 ∈ {紧/宽 × 静/动} → 对应不同滑点bps曲线
   - fee_tier（如 TM/TK）→ 对应Maker/Taker费率表
2. 代码锚点：ReplayFeeder 已写入 _feature_data 字段，TradeSim 读取后即可按场景套用模型
3. 先用静态 YAML 曲线，后续再学习式标定

**优先级**: 🔴 P1 - 高优先级

---

### P1.4 边界对齐回归（扩充分层用例）

**问题描述**:  
已通过的关键用例：return_1s 遇 gap-second、lag 标记、秒级去重等；建议把这些用例分层到：符号×数据源×时间窗，作为小样本多组合的回归集合。

**实施要点**:
1. 用例分层到：符号×数据源×时间窗
2. 补高缺报率和极端跳价的构造样例
3. 绑定 CI

**优先级**: 🔴 P1 - 高优先级

---

## 三、代码层改进（6项）

### 代码.1 Metrics推送规范化（Pushgateway）

**问题描述**:  
现在按毫秒时间戳写入样本；Prometheus 通常使用秒时间戳或无时间戳（由采集端打时标）。建议改为秒或去掉时间戳，降低乱序/抖动风险。

**实施要点**:
1. 改为秒时间戳或去掉时间戳
2. 增加 instance 标签（主机/IP）便于多机并行回测聚合

**优先级**: 🟡 中优先级

---

### 代码.2 Sharpe/Sortino的"收益率"归一

**问题描述**:  
目前按日合计净 PnL计算风险指标，缺少对"资金规模"的归一，跨样本不具可比性。

**实施要点**:
1. 增加 initial_equity 或 notional_per_trade
2. 将 pnl_series 规范成日收益率再做 Sharpe/Sortino/MAR
3. 避免"单位不一"的偏差

**优先级**: 🟡 中优先级

---

### 代码.3 Reader去重集_seen_keys的内存界

**问题描述**:  
现用 Set[(symbol, second_ts)] 跨文件累积；建议按分钟桶维护/定期清窗（如处理完每个文件后清理过期桶），避免长窗口内存占用增长。

**实施要点**:
1. 按分钟桶维护/定期清窗
2. 处理完每个文件后清理过期桶
3. 避免长窗口内存占用增长（特别是 Parquet 多分区时）

**优先级**: 🟡 中优先级

---

### 代码.4 Aligner的门限外置到配置

**问题描述**:  
如 lag_threshold_ms=5000 / spread_threshold / volatility_threshold 建议进入 config_schema（含默认值与环境变量覆盖），便于在策略场景切换时联动阈值调参。

**实施要点**:
1. lag_threshold_ms, spread_threshold, volatility_threshold 进入 config_schema
2. 含默认值与环境变量覆盖
3. 便于策略场景切换时联动阈值调参

**优先级**: 🟡 中优先级

---

### 代码.5 TradeSim收盘清仓时间戳

**问题描述**:  
建议以最后一条市场数据 ts作为"日末平仓"时间，而非 now()，避免切日 PnL 被当前机器时间影响（尤其跨时区实验）。

**实施要点**:
1. 以最后一条市场数据 ts作为"日末平仓"时间
2. 在 _feature_data.session 辅助判断收盘边界
3. 避免切日 PnL 被当前机器时间影响

**优先级**: 🟡 中优先级

---

### 代码.6 Maker/Taker费用模型

**问题描述**:  
现有费率模型更偏静态，建议基于 _feature_data.spread_bps/scenario_2x2 决定成交落点概率（maker vs taker），例如"宽&动"场景提高 taker 概率。

**实施要点**:
1. 基于 spread_bps/scenario_2x2 决定成交落点概率
2. "宽&动"场景提高 taker 概率
3. 进而拉高费用与滑点，形成场景化 PnL

**优先级**: 🟡 中优先级

---

## 四、测试与CI建议（2项）

### CI.1 新增CI作业

**实施要点**:
1. **gate-baseline.yml**：双跑对比（见 P1.1），以 资产×日期×时区 为矩阵（小样本）
2. **pnl-rollover-tz.yml**：时区回归（UTC/Tokyo），断言日界点 PnL 连续与模式判定一致

**优先级**: 🔴 P1 - 高优先级

---

### CI.2 扩展用例

**实施要点**:
1. **极端场景**：高丢包（gap-second 连续命中）、价差骤宽 + 高波动（scenario_2x2 连续跳档），检验 return_1s 与 lag 标记稳定性
2. **Reader 源优先级**：preview + ready 混合分区时，以 source_priority 验证"同秒唯一路径"去重正确性（已有基础用例，扩到多 symbol）

**优先级**: 🟡 中优先级

---

## 五、实施优先级排序

### 立即实施（P1 - 本周）

1. **P1.1** Gate统计双跑基线（CI集成）
2. **P1.2** PnL切日与时区回归测试（补充样例）
3. **P1.3** 滑点/费用"情境化"落地（MVP）
4. **P1.4** 边界对齐回归（扩充分层用例）

### 短期实施（代码层 - 下周）

5. **代码.1** Metrics推送规范化
6. **代码.2** Sharpe/Sortino收益率归一
7. **代码.3** Reader去重集内存优化
8. **代码.4** Aligner门限外置到配置

### 中期实施（代码层 - 下两周）

9. **代码.5** TradeSim收盘清仓时间戳
10. **代码.6** Maker/Taker费用模型

### 长期实施（CI/测试 - 下月）

11. **CI.1** 新增CI作业
12. **CI.2** 扩展用例

---

## 六、总体结论

**当前状态**:  
回放/回测 Harness 的关键风险点基本被"对齐 & 回归测试"覆盖，当前框架可作为后续 CI 的稳定基线。

**下一步目标**:  
用上面12项改进将"Gate双跑基线 + 时区一致性 + 情境化成本 + 内存优化 + CI覆盖"补齐，即可进入稳定对比与参数迭代周期。

**预计工作量**:
- P1项：4项，预计1周完成
- 代码层改进：6项，预计2周完成
- CI/测试：2项，预计1周完成
- **总计**：4周完成所有改进

---

**报告生成时间**: 2025-11-10  
**状态**: 📋 待实施


