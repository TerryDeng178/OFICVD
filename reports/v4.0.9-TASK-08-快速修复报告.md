# v4.0.9 TASK-08 快速修复报告

## 概述

基于v4.0.8验证结果报告的进一步快速修复，解决4个P0项（立改立验）和4个P1项（本周收敛）的小回归和增强点。

**实施时间**: 2025-11-09  
**版本**: v4.0.9  
**状态**: ✅ 全部完成（8/8）

---

## 完成项清单

### P0项（立改立验）- 4/4 ✅

#### P0-1: 保留YAML其它分区（避免被Pydantic覆盖）

**问题**: `load_config()`成功走Pydantic时，只返回`{"backtest": ...}`，导致后续`paths/signal/aligner`等顶层配置被丢弃。

**修改文件**: `scripts/replay_harness.py`

**修改内容**:
- 重写`load_config()`函数，保留原始YAML的所有顶层键
- 只校验`backtest`小节，其它小节原样保留

**代码位置**:
```97:110:scripts/replay_harness.py
def load_config(config_path: Path) -> Dict[str, Any]:
    """P0-1: 加载配置（保留YAML其它分区，避免被Pydantic覆盖）
    
    只校验backtest小节，其它小节（paths/signal/aligner等）原样保留
    """
    raw = {}
    with config_path.open("r", encoding="utf-8") as f:
        raw = yaml.safe_load(f) or {}
    
    # 只校验backtest小节，其它小节原样保留
    validated_backtest = load_backtest_config(config_path=config_path)
    
    # 合并：保留原始YAML的所有顶层键，仅把backtest小节替换为校验后的字典
    return {**raw, "backtest": validated_backtest}
```

**验证**: ✅ paths/signal/aligner等配置不再丢失

---

#### P0-2: Pushgateway指标被推送两次（去重）

**问题**: `MetricsAggregator._save_metrics()`里已经会调用`_export_to_pushgateway(metrics)`，Harness里又手动调用了一次（第二次带reader/feeder stats）。

**修改文件**: 
- `src/alpha_core/backtest/metrics.py`
- `scripts/replay_harness.py`

**修改内容**:
1. `compute_metrics()`增加`reader_stats`和`feeder_stats`参数
2. `_save_metrics()`增加`reader_stats`和`feeder_stats`参数，统一调用`_export_to_pushgateway()`
3. 删除harness中的二次调用

**代码位置**:
```24:32:src/alpha_core/backtest/metrics.py
def compute_metrics(
    self,
    trades: List[Dict[str, Any]],
    pnl_daily: List[Dict[str, Any]],
    trade_sim_stats: Optional[Dict[str, Any]] = None,
    initial_equity: Optional[float] = None,
    reader_stats: Optional[Dict[str, Any]] = None,
    feeder_stats: Optional[Dict[str, Any]] = None,
) -> Dict[str, Any]:
```

```307:325:src/alpha_core/backtest/metrics.py
# Save metrics
# P0-2: 统一在_save_metrics中调用_export_to_pushgateway，避免重复推送
self._save_metrics(metrics, reader_stats=reader_stats, feeder_stats=feeder_stats)

return metrics

def _save_metrics(self, metrics: Dict[str, Any], reader_stats: Optional[Dict[str, Any]] = None, feeder_stats: Optional[Dict[str, Any]] = None) -> None:
    """Save metrics to JSON file
    
    P0-2: 统一在这里调用_export_to_pushgateway，避免重复推送
    """
    ...
    # P0-2: 统一在这里推送Pushgateway指标（包含健康度指标）
    self._export_to_pushgateway(metrics, reader_stats=reader_stats, feeder_stats=feeder_stats)
```

**验证**: ✅ Pushgateway指标只推送一次

---

#### P0-3: vol_bps实值缺失（线性滑点模型退化）

**问题**: Aligner产出的特征里只有`return_1s`，并未生成`vol_bps`；TradeSim的linear/piecewise模型会去读`_feature_data.vol_bps`，结果拿到None，导致线性项退化。

**修改文件**: 
- `src/alpha_core/backtest/aligner.py`
- `src/alpha_core/backtest/trade_sim.py`

**修改内容**:
1. 在Aligner的`_compute_features`中组装feature_row时添加`vol_bps = abs(return_1s)`
2. 在TradeSim的linear模型中添加vol_bps兜底逻辑（如果缺失，使用abs(return_1s)）

**代码位置**:
```258:272:src/alpha_core/backtest/aligner.py
# P0-3: 添加vol_bps = abs(return_1s)，供线性/分段滑点模型读取
vol_bps = abs(return_1s)

feature_row = {
    ...
    "return_1s": return_1s,  # 已计算
    "vol_bps": vol_bps,  # P0-3: 新增vol_bps字段，供滑点模型读取
    ...
}
```

```145:154:src/alpha_core/backtest/trade_sim.py
if self.slippage_model == "linear":
    # P1增强: 线性模型: spread + volatility
    # P0-3: vol_bps兜底（如果缺失，使用abs(return_1s)）
    vol_bps = fd.get("vol_bps")
    if vol_bps is None:
        return_1s = fd.get("return_1s", 0.0)
        vol_bps = abs(float(return_1s))
    else:
        vol_bps = float(vol_bps)
    return max(self.slippage_bps, 0.5 * spread + 0.3 * vol_bps)
```

**验证**: ✅ 线性/分段滑点模型正常生效

---

#### P0-4: Feeder指标字段名与Pushgateway期望不一致

**问题**: Feeder的`get_stats()`返回`{"processed","emitted","suppressed","deduplicated"}`，而`_export_to_pushgateway()`读取的是`feeder_stats.get("signals_emitted")`，结果一直是0。

**修改文件**: `src/alpha_core/backtest/metrics.py`

**修改内容**:
- 在`_export_to_pushgateway()`中支持`emitted`和`signals_emitted`别名

**代码位置**:
```423:424:src/alpha_core/backtest/metrics.py
# P0-4: 对齐Feeder指标字段名（支持emitted和signals_emitted别名）
signal_count = feeder_stats.get("signals_emitted") or feeder_stats.get("emitted", 0)
```

**验证**: ✅ Feeder信号计数指标不再为0

---

### P1项（本周收敛）- 4/4 ✅

#### P1-1: DataReader保留时长支持config

**问题**: `_cleanup_old_buckets()`里有`hasattr(self, "config")`的读取逻辑，但DataReader并未保存config。

**修改文件**: 
- `src/alpha_core/backtest/reader.py`
- `scripts/replay_harness.py`

**修改内容**:
1. `DataReader.__init__()`增加`config`参数并保存
2. `replay_harness.py`中传递config给DataReader

**代码位置**:
```33:58:src/alpha_core/backtest/reader.py
def __init__(
    ...
    config: Optional[Dict[str, Any]] = None,
):
    ...
    # P1-1: 保存config，便于_cleanup_old_buckets读取reader.dedup_keep_hours
    self.config = config or {}
```

```214:225:scripts/replay_harness.py
# P1-1: 传递config给DataReader，便于读取reader.dedup_keep_hours
reader = DataReader(
    ...
    config=config,  # P1-1: 传递config
)
```

**验证**: ✅ Reader去重桶保留时长可在YAML中统一管理

---

#### P1-2: manifest时间字段更语义化

**问题**: 现在`run_manifest.json`的`started_at`是在任务末尾填的，语义上更像`finished_at`。

**修改文件**: `scripts/replay_harness.py`

**修改内容**:
- 进程开头记录`started_at`
- 末尾补`finished_at`

**代码位置**:
```113:116:scripts/replay_harness.py
def main():
    """Main entry point"""
    # P1-2: 记录开始时间（用于manifest的started_at）
    started_at = datetime.now(timezone.utc)
```

```464:471:scripts/replay_harness.py
# P1-2: 记录结束时间（用于manifest的finished_at）
finished_at = datetime.now(timezone.utc)

# Generate run manifest
manifest = {
    "run_id": run_id,
    "started_at": started_at.isoformat(),  # P1-2: 使用进程开始时间
    "finished_at": finished_at.isoformat(),  # P1-2: 新增finished_at字段
```

**验证**: ✅ manifest时间字段语义清晰

---

#### P1-3: Pushgateway job命名避免重复前缀

**问题**: 当前job用`f"backtest_{run_id}"`，而run_id自身已是`backtest_YYYY...`，轻微重复。

**修改文件**: `src/alpha_core/backtest/metrics.py`

**修改内容**:
- 统一为`job = run_id`

**代码位置**:
```429:433:src/alpha_core/backtest/metrics.py
# Push to Pushgateway
metrics_payload = "\n".join(metrics_text) + "\n"
# P1-3: job命名避免重复前缀（run_id自身已是backtest_YYYY...）
push_url = f"{timeseries_url}/metrics/job/{run_id}"
```

**验证**: ✅ job命名不再重复前缀

---

#### P1-4: 统一波动字段命名

**问题**: 既然将`vol_bps`固化，建议把`return_1s`也在报表端呈现为`ret1s_bps`，减少歧义。

**修改文件**: `src/alpha_core/backtest/metrics.py`

**修改内容**:
- 在metrics中添加`avg_ret1s_bps`作为质量监控指标
- 保留`return_1s`字段向后兼容

**代码位置**:
```280:290:src/alpha_core/backtest/metrics.py
# P1-4: 计算平均波动指标（avg_ret1s_bps）作为质量监控指标
# 从trades中提取return_1s（如果有）或从feature_data中获取
ret1s_values = []
for trade in trades:
    # 尝试从trade的feature_data中获取return_1s
    feature_data = trade.get("_feature_data", {})
    ret1s = feature_data.get("return_1s")
    if ret1s is not None:
        ret1s_values.append(abs(float(ret1s)))
avg_ret1s_bps = sum(ret1s_values) / len(ret1s_values) if ret1s_values else 0.0
```

```304:305:src/alpha_core/backtest/metrics.py
# P1-4: 统一波动字段命名（avg_ret1s_bps作为质量监控指标）
"avg_ret1s_bps": avg_ret1s_bps,
```

**验证**: ✅ metrics包含avg_ret1s_bps指标

---

## 总结

### 完成情况

- **P0项**: 4/4 ✅
- **P1项**: 4/4 ✅

**总计**: 8/8项完成

### 关键修复点

1. **配置完整性**: 保留YAML所有分区，避免Pydantic覆盖
2. **指标推送去重**: 统一在`_save_metrics`中推送，避免重复
3. **vol_bps字段**: 在Aligner中生成，TradeSim中兜底，确保线性模型生效
4. **字段名对齐**: Feeder指标字段名支持别名，避免读取失败
5. **配置传递**: DataReader支持config参数，便于统一管理
6. **时间语义**: manifest时间字段更清晰（started_at/finished_at）
7. **命名优化**: Pushgateway job命名避免重复前缀
8. **波动指标**: 统一波动字段命名，添加avg_ret1s_bps

### 修改文件清单

1. `scripts/replay_harness.py` - 配置加载、时间记录、config传递
2. `src/alpha_core/backtest/metrics.py` - 指标推送去重、字段名对齐、job命名、波动指标
3. `src/alpha_core/backtest/aligner.py` - vol_bps字段生成
4. `src/alpha_core/backtest/trade_sim.py` - vol_bps兜底逻辑
5. `src/alpha_core/backtest/reader.py` - config参数支持

---

**报告生成时间**: 2025-11-09  
**报告版本**: v4.0.9

