# 体检优化实施总结

> **实施日期**: 2025-11-07  
> **优化版本**: v4.0.4  
> **基于**: 快速体检与"立刻可执行"的优化建议

---

## 执行摘要

本次优化基于快速体检结论，实施了 6 项优化（P0 必做 4 项 + P1 建议 2 项），进一步完善了 CI 回归、环境配置、文档规范和可观测性。

### 优化成果

| 优先级 | 优化项 | 状态 | 影响 |
|--------|--------|------|------|
| **P0** | 双 Sink 结果对齐纳入 CI 回归 | ✅ 完成 | CI 自动化验证 |
| **P0** | 健康/就绪探针基线分环境配置 | ✅ 完成 | 回放场景友好化 |
| **P0** | 文档明确信号→订单链路一致口径 | ✅ 完成 | DoD 明确化 |
| **P0** | 输入模式 PREVIEW 为默认 | ✅ 完成 | 路径简化 |
| **P1** | 扩充双 Sink 对齐核对维度 | ✅ 完成 | 护栏分解+分钟节律一致性 |
| **P1** | run_manifest 做发布证据 | ✅ 完成 | CI 自动上传 |

---

## P0 必做项实施

### P0: 双 Sink 结果对齐纳入 CI 回归

**实施内容**:

**文件**: `.github/workflows/ci.yml`

**改动**:
- 新增 `sink-parity` 任务，运行双 Sink 结果对齐回归测试
- 支持 Ubuntu 和 Windows 双平台
- 自动上传运行清单和报表作为发布证据

**代码位置**:
```yaml
jobs:
  sink-parity:
    name: 双 Sink 结果对齐回归
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]
        python-version: ['3.11']
    
    steps:
    - name: 双 Sink 结果对齐回归测试
      shell: bash
      run: |
        if [ "${{ runner.os }}" == "Windows" ]; then
          powershell -File ./scripts/verify_sink_parity.ps1 -Config ./config/defaults.smoke.yaml -Minutes 2
        else
          chmod +x ./scripts/verify_sink_parity.sh
          ./scripts/verify_sink_parity.sh ./config/defaults.smoke.yaml 2
        fi
    
    - name: 上传运行清单（发布证据）
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: run-manifests-${{ matrix.os }}-${{ github.run_number }}
        path: |
          deploy/artifacts/ofi_cvd/run_logs/*.json
          logs/report/*.json
          logs/report/*.md
        retention-days: 30
```

**效果**:
- ✅ CI 自动验证双 Sink 统计口径一致性
- ✅ 自动上传运行清单和报表作为发布证据

---

### P0: 健康/就绪探针基线分环境配置

**实施内容**:

**文件**: `orchestrator/run.py`, `config/defaults.replay.yaml`

**改动**:
1. **Orchestrator**: 根据环境变量或配置文件名称自动切换探针配置
2. **回放配置**: 创建 `defaults.replay.yaml` 用于回放场景

**代码位置**:
```python
# P0: 健康/就绪探针基线分环境配置
# 实时场景：保持现有时间窗口检查
# SMOKE/回放场景：min_new_last_seconds=0（历史数据友好化）
is_replay_mode = os.getenv("V13_REPLAY_MODE", "0") == "1" or config_path.name.startswith("replay")
min_new_last_seconds = 0 if is_replay_mode else 120

signal_health_args = (
    {
        "pattern": str(output_dir_rel / "ready" / "signal" / "**" / "*.jsonl"),
        "min_count": 1,
        "min_new_last_seconds": min_new_last_seconds,  # P0: 回放场景设为 0
        "min_new_count": 1,
        "max_idle_seconds": 60 if not is_replay_mode else None  # P0: 回放场景不检查最大空闲时间
    } if sink_kind == "jsonl"
    else {...}
)
```

**使用方式**:
```powershell
# 回放模式（自动应用历史数据友好化配置）
$env:V13_REPLAY_MODE = "1"
python -m orchestrator.run --config ./config/defaults.replay.yaml ...

# 实时模式（默认）
python -m orchestrator.run --config ./config/defaults.yaml ...
```

**效果**:
- ✅ 回放场景自动跳过时间窗口检查
- ✅ 实时场景保持严格的时间窗口要求

---

### P0: 文档明确信号→订单链路一致口径

**实施内容**:

**文件**: `README.md`, `docs/data_quality.md`

**改动**:
1. **README.md**: 在信号输出示例后添加 DoD 约定说明
2. **docs/data_quality.md**: 创建数据质量文档，详细说明一致口径

**代码位置**:
```markdown
> **重要约定（DoD）**: 信号→订单链路的一致口径
> - **Reporter 统计**: 仅统计 `confirm=true` 的信号（`total`, `buy_count`, `sell_count`, `strong_ratio` 等）
> - **Broker 下单**: 仅处理 `confirm=true` 的信号（强信号必下单，普通信号按 `sample_rate` 抽样）
> - **统计口径一致性**: JSONL 和 SQLite 两种 Sink 的统计口径完全一致，确保可对比性
> - 统一以 **JSON Lines**（一行一条）落地，便于回放与离线分析。
```

**效果**:
- ✅ DoD 明确化，避免统计口径不一致
- ✅ 便于新成员理解和遵循

---

### P0: 输入模式 PREVIEW 为默认

**实施内容**:

**文件**: `orchestrator/run.py`

**改动**:
- 默认 `V13_INPUT_MODE=preview`
- 支持通过 `V13_INPUT_DIR` 指定回放窗口根目录

**代码位置**:
```python
# 特征文件目录（支持 preview/raw 切换，优先环境变量，默认 preview）
input_mode = os.getenv("V13_INPUT_MODE", "preview")  # preview | raw
input_dir_env = os.getenv("V13_INPUT_DIR", "")

if input_dir_env:
    features_dir = Path(input_dir_env)
else:
    features_dir = project_root / "deploy" / "data" / "ofi_cvd" / input_mode
```

**效果**:
- ✅ 路径简化，默认使用 PREVIEW 数据
- ✅ 必要时可通过环境变量切换

---

## P1 建议项实施

### P1: 扩充双 Sink 对齐核对维度

**实施内容**:

**文件**: `scripts/verify_sink_parity.sh`, `scripts/verify_sink_parity.ps1`

**改动**:
- 新增护栏分解一致性对比
- 新增分钟节律一致性对比

**代码位置**:
```python
# P1: 扩充"双 Sink 对齐"核对维度 - 护栏分解一致性
jsonl_gating = jsonl_data.get("gating_breakdown", {})
sqlite_gating = sqlite_data.get("gating_breakdown", {})

if jsonl_gating and sqlite_gating:
    all_reasons = set(jsonl_gating.keys()) | set(sqlite_gating.keys())
    for reason in all_reasons:
        jsonl_val = jsonl_gating.get(reason, 0)
        sqlite_val = sqlite_gating.get(reason, 0)
        diff_pct = abs(jsonl_val - sqlite_val) / jsonl_val * 100 if jsonl_val > 0 else 0.0
        # 对比并报告...

# P1: 扩充"双 Sink 对齐"核对维度 - 分钟节律一致性
jsonl_per_minute = jsonl_data.get("per_minute", [])
sqlite_per_minute = sqlite_data.get("per_minute", [])

if jsonl_per_minute and sqlite_per_minute:
    min_count = min(len(jsonl_per_minute), len(sqlite_per_minute))
    for i in range(min_count):
        jsonl_count = jsonl_per_minute[i].get("count", 0)
        sqlite_count = sqlite_per_minute[i].get("count", 0)
        # 对比并报告...
```

**效果**:
- ✅ 更全面的统计口径一致性验证
- ✅ 护栏分解和分钟节律的一致性检查

---

### P1: run_manifest 做发布证据

**实施内容**:

**文件**: `.github/workflows/ci.yml`

**改动**:
- CI 自动上传运行清单和报表作为发布证据
- 保留 30 天，便于追溯和复现

**代码位置**:
```yaml
- name: 上传运行清单（发布证据）
  if: always()
  uses: actions/upload-artifact@v4
  with:
    name: run-manifests-${{ matrix.os }}-${{ github.run_number }}
    path: |
      deploy/artifacts/ofi_cvd/run_logs/*.json
      logs/report/*.json
      logs/report/*.md
    retention-days: 30
```

**效果**:
- ✅ 每次 CI 运行自动保存证据包
- ✅ 便于问题追溯和复现

---

## 文件变更清单

| 文件 | 变更类型 | 说明 |
|------|---------|------|
| `.github/workflows/ci.yml` | 新增 | P0: CI 回归 + P1: 发布证据 |
| `orchestrator/run.py` | 修改 | P0: 健康探针分环境配置 |
| `config/defaults.replay.yaml` | 新增 | P0: 回放场景配置 |
| `scripts/verify_sink_parity.sh` | 修改 | P1: 扩充核对维度 |
| `scripts/verify_sink_parity.ps1` | 修改 | P1: 扩充核对维度 |
| `README.md` | 修改 | P0: DoD 约定说明 |
| `docs/data_quality.md` | 新增 | P0: 数据质量文档 |

---

## 验证清单

### P0 项验证

- [x] **CI 回归**: ✅ 双 Sink 结果对齐已纳入 CI
- [x] **健康探针配置**: ✅ 回放场景自动应用历史数据友好化配置
- [x] **DoD 文档**: ✅ 信号→订单链路一致口径已明确
- [x] **输入模式**: ✅ PREVIEW 为默认，支持环境变量切换

### P1 项验证

- [x] **双 Sink 对齐维度**: ✅ 护栏分解+分钟节律一致性对比
- [x] **发布证据**: ✅ CI 自动上传运行清单和报表

---

## 测试建议

### 快速验证

```powershell
# 1. 验证 CI 回归（本地运行）
.\scripts\verify_sink_parity.ps1 -Config ./config/defaults.smoke.yaml -Minutes 2

# 2. 验证回放场景健康探针
$env:V13_REPLAY_MODE = "1"
python -m orchestrator.run `
  --config ./config/defaults.replay.yaml `
  --enable signal,report `
  --sink jsonl `
  --minutes 1

# 3. 验证 DoD 约定（检查报表）
# 检查报表中 total/buy_count/sell_count 是否仅统计 confirm=true 的信号
```

---

## 配置建议

### CI 回归

- **双 Sink 结果对齐**: 每次 PR 和 Push 自动运行
- **SMOKE 快速回归**: 每次 PR 和 Push 自动运行
- **发布证据**: 自动上传运行清单和报表（保留 30 天）

### 环境配置

- **实时场景**: 使用 `defaults.yaml`，严格时间窗口检查
- **SMOKE 场景**: 使用 `defaults.smoke.yaml`，放宽阈值
- **回放场景**: 使用 `defaults.replay.yaml`，历史数据友好化

### 输入模式

- **默认**: `V13_INPUT_MODE=preview`（PREVIEW 数据）
- **切换**: 通过 `V13_INPUT_DIR` 指定回放窗口根目录

---

**优化完成时间**: 2025-11-07  
**优化状态**: ✅ P0 全部完成，P1 全部完成  
**测试状态**: ⏳ 待 CI 验证

