# v4.0.6 P1-1: Reporterâ†’æ—¶åºåº“å¯¼å‡º + å‘Šè­¦å®ç°æŠ¥å‘Š

> **å®ç°æ—¥æœŸ**: 2025-11-08  
> **ç‰ˆæœ¬**: v4.0.6  
> **åŠŸèƒ½**: æ—¶åºåº“å¯¼å‡ºå’Œå‘Šè­¦è§„åˆ™

---

## æ‰§è¡Œæ‘˜è¦

âœ… **æ—¶åºåº“å¯¼å‡º**: **å·²å®ç°**  
âœ… **å‘Šè­¦è§„åˆ™**: **å·²å®ç°**  
â³ **å®é™…éªŒè¯**: **å¾…é…ç½®æ—¶åºåº“åéªŒè¯**

---

## å®ç°å†…å®¹

### 1. æ—¶åºåº“å¯¼å‡ºåŠŸèƒ½

#### 1.1 æ•°æ®å‡†å¤‡

åœ¨ `generate_report()` æ–¹æ³•ä¸­ï¼Œæ·»åŠ äº† `timeseries_data` å­—æ®µï¼š

```python
report["timeseries_data"] = {
    "total": 0,
    "gating_breakdown": {},
    "strong_ratio": 0.0,
    "per_minute": []
}
```

#### 1.2 å¯¼å‡ºæ–¹æ³•

æ–°å¢ `_export_to_timeseries()` æ–¹æ³•ï¼Œæ”¯æŒä¸¤ç§æ—¶åºåº“ï¼š

1. **Prometheus Pushgateway**
   - ç¯å¢ƒå˜é‡: `TIMESERIES_TYPE=prometheus`
   - ç¯å¢ƒå˜é‡: `TIMESERIES_URL=<pushgateway_url>`
   - å¯¼å‡ºæŒ‡æ ‡:
     - `signal_total`: æ€»ä¿¡å·æ•°
     - `signal_strong_ratio`: å¼ºä¿¡å·æ¯”ä¾‹
     - `signal_gating_breakdown{reason="..."}`: æŠ¤æ åˆ†è§£ç»Ÿè®¡
     - `signal_per_minute_total{minute="..."}`: æ¯åˆ†é’Ÿæ€»é‡

2. **InfluxDB**
   - ç¯å¢ƒå˜é‡: `TIMESERIES_TYPE=influxdb`
   - ç¯å¢ƒå˜é‡: `TIMESERIES_URL=<influxdb_url>`
   - å¯¼å‡ºæ•°æ®ç‚¹:
     - `signal_total`: æ€»ä¿¡å·æ•°
     - `signal_strong_ratio`: å¼ºä¿¡å·æ¯”ä¾‹
     - `signal_gating_breakdown`: æŠ¤æ åˆ†è§£ç»Ÿè®¡ï¼ˆå¸¦ reason æ ‡ç­¾ï¼‰

#### 1.3 é…ç½®æ–¹å¼

```powershell
# å¯ç”¨æ—¶åºåº“å¯¼å‡º
$env:TIMESERIES_ENABLED = "1"
$env:TIMESERIES_TYPE = "prometheus"  # æˆ– "influxdb"
$env:TIMESERIES_URL = "http://localhost:9091"  # Pushgateway URL
```

### 2. å‘Šè­¦è§„åˆ™

#### 2.1 å‘Šè­¦è§„åˆ™å®ç°

æ–°å¢ `_check_alerts()` æ–¹æ³•ï¼Œå®ç° 3 ç±»å‘Šè­¦è§„åˆ™ï¼š

1. **è¿ç»­ 2 åˆ†é’Ÿ total == 0**
   - çº§åˆ«: `critical`
   - è§„åˆ™: `total_zero_2min`
   - æ£€æŸ¥: æœ€è¿‘ 2 åˆ†é’Ÿçš„ `total` éƒ½ä¸º 0

2. **low_consistency å æ¯”å•åˆ†é’Ÿ > 80%**
   - çº§åˆ«: `warning`
   - è§„åˆ™: `low_consistency_high`
   - æ£€æŸ¥: æ¯åˆ†é’Ÿçš„ `low_consistency` å æ¯”

3. **strong_ratio çŸ­æ—¶å´©å¡Œï¼ˆè¾ƒ 7 æ—¥ç§»åŠ¨ä¸­ä½æ•°åå·® > 3Ïƒï¼‰**
   - çº§åˆ«: `warning`
   - è§„åˆ™: `strong_ratio_collapse`
   - æ£€æŸ¥: å½“å‰ `strong_ratio` å¼‚å¸¸ä½ï¼ˆç¤ºä¾‹é˜ˆå€¼: < 1%ï¼‰
   - æ³¨æ„: å®Œæ•´å®ç°éœ€è¦ä»æ—¶åºåº“æŸ¥è¯¢ 7 æ—¥ç§»åŠ¨ä¸­ä½æ•°å’Œæ ‡å‡†å·®

#### 2.2 å‘Šè­¦è¾“å‡º

å‘Šè­¦ä¼šåœ¨æ—¥å¿—ä¸­è¾“å‡ºï¼Œå¹¶æ·»åŠ åˆ°æŠ¥è¡¨ä¸­ï¼š

```python
report["alerts"] = [
    {
        "level": "critical",
        "rule": "total_zero_2min",
        "message": "è¿ç»­ 2 åˆ†é’Ÿä¿¡å·æ€»é‡ä¸º 0",
        "details": {...}
    },
    ...
]
```

---

## ä½¿ç”¨æ–¹æ³•

### å¯ç”¨æ—¶åºåº“å¯¼å‡º

```powershell
# è®¾ç½®ç¯å¢ƒå˜é‡
$env:TIMESERIES_ENABLED = "1"
$env:TIMESERIES_TYPE = "prometheus"
$env:TIMESERIES_URL = "http://localhost:9091"

# è¿è¡Œ Orchestrator
python -m orchestrator.run --config config/defaults.yaml --enable harvest,signal,broker,report --sink jsonl --minutes 30
```

### æŸ¥çœ‹å‘Šè­¦

å‘Šè­¦ä¼šè‡ªåŠ¨è¾“å‡ºåˆ°æ—¥å¿—ï¼Œå¹¶åŒ…å«åœ¨æŠ¥è¡¨çš„ `alerts` å­—æ®µä¸­ã€‚

---

## ä»£ç å˜æ›´

### æ–°å¢æ–¹æ³•

1. `_export_to_timeseries()`: æ—¶åºåº“å¯¼å‡ºå…¥å£
2. `_export_to_prometheus()`: Prometheus å¯¼å‡ºå®ç°
3. `_export_to_influxdb()`: InfluxDB å¯¼å‡ºå®ç°
4. `_check_alerts()`: å‘Šè­¦è§„åˆ™æ£€æŸ¥

### ä¿®æ”¹æ–¹æ³•

1. `generate_report()`: æ·»åŠ  `timeseries_data` å­—æ®µ
2. `main()`: æ·»åŠ å‘Šè­¦æ£€æŸ¥è°ƒç”¨

---

## å¾…å®Œå–„åŠŸèƒ½

### 1. strong_ratio å‘Šè­¦è§„åˆ™

å½“å‰å®ç°ä»…åšç¤ºä¾‹ï¼Œå®Œæ•´å®ç°éœ€è¦ï¼š

```python
# TODO: ä»æ—¶åºåº“è¯»å– 7 æ—¥ç§»åŠ¨ä¸­ä½æ•°å’Œæ ‡å‡†å·®
# è®¡ç®—å½“å‰å€¼æ˜¯å¦åç¦» 3Ïƒ
```

å»ºè®®å®ç°ï¼š
- ä»æ—¶åºåº“æŸ¥è¯¢æœ€è¿‘ 7 å¤©çš„ `signal_strong_ratio` æ•°æ®
- è®¡ç®—ç§»åŠ¨ä¸­ä½æ•°å’Œæ ‡å‡†å·®
- åˆ¤æ–­å½“å‰å€¼æ˜¯å¦åç¦» 3Ïƒ

### 2. å‘Šè­¦é€šçŸ¥

å½“å‰å‘Šè­¦ä»…è¾“å‡ºåˆ°æ—¥å¿—ï¼Œå»ºè®®æ·»åŠ ï¼š

- é‚®ä»¶é€šçŸ¥
- ä¼ä¸šå¾®ä¿¡/é’‰é’‰é€šçŸ¥
- PagerDuty/OpsGenie é›†æˆ

### 3. å‘Šè­¦å†å²

å»ºè®®æ·»åŠ å‘Šè­¦å†å²è®°å½•ï¼Œé¿å…é‡å¤å‘Šè­¦ã€‚

---

## æµ‹è¯•å»ºè®®

### 1. æ—¶åºåº“å¯¼å‡ºæµ‹è¯•

```powershell
# å¯åŠ¨ Prometheus Pushgatewayï¼ˆDockerï¼‰
docker run -d -p 9091:9091 prom/pushgateway

# è¿è¡Œæµ‹è¯•
$env:TIMESERIES_ENABLED = "1"
$env:TIMESERIES_TYPE = "prometheus"
$env:TIMESERIES_URL = "http://localhost:9091"
python -m orchestrator.run --config config/defaults.smoke.yaml --enable signal,report --sink jsonl --minutes 1

# æ£€æŸ¥æŒ‡æ ‡
curl http://localhost:9091/metrics | Select-String "signal_"
```

### 2. å‘Šè­¦è§„åˆ™æµ‹è¯•

- æ¨¡æ‹Ÿè¿ç»­ 2 åˆ†é’Ÿæ— ä¿¡å·åœºæ™¯
- æ¨¡æ‹Ÿ high low_consistency åœºæ™¯
- æ¨¡æ‹Ÿ strong_ratio å´©å¡Œåœºæ™¯

---

## ç»“è®º

âœ… **åŠŸèƒ½å®ç°å®Œæˆ**: æ—¶åºåº“å¯¼å‡ºå’Œå‘Šè­¦è§„åˆ™å·²å®ç°  
â³ **å¾…éªŒè¯**: éœ€è¦é…ç½®æ—¶åºåº“åè¿›è¡Œå®é™…éªŒè¯  
ğŸ“ **å¾…å®Œå–„**: strong_ratio å‘Šè­¦è§„åˆ™éœ€è¦ä»æ—¶åºåº“æŸ¥è¯¢å†å²æ•°æ®

---

**å®ç°å®Œæˆæ—¶é—´**: 2025-11-08  
**åŠŸèƒ½çŠ¶æ€**: âœ… **ä»£ç å®ç°å®Œæˆ**  
**å»ºè®®**: é…ç½®æ—¶åºåº“åè¿›è¡Œå®Œæ•´éªŒè¯

