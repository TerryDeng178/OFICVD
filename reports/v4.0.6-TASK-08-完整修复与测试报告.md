# TASK-08 å®Œæ•´ä¿®å¤ä¸æµ‹è¯•æŠ¥å‘Š

**æŠ¥å‘Šæ—¶é—´**: 2025-11-09  
**ç‰ˆæœ¬**: v4.0.6  
**æŠ¥å‘Šç±»å‹**: å®Œæ•´ä¿®å¤ä¸æµ‹è¯•éªŒè¯æŠ¥å‘Š

---

## ä¸€ã€æ‰§è¡Œæ¦‚è§ˆ

### 1.1 ä¿®å¤ç›®æ ‡

æ ¹æ®ç”¨æˆ·æä¾›çš„è¯¦ç»†ä»£ç å®¡æŸ¥æŠ¥å‘Šï¼Œä¿®å¤8ä¸ªP0/P1çº§åˆ«çš„å…³é”®é—®é¢˜ï¼Œç»Ÿä¸€Pushgatewayæ–‡æ¡£ä¸å®ç°çŠ¶æ€ï¼Œå¹¶æ·»åŠ å›å½’æµ‹è¯•ç”¨ä¾‹ï¼Œæå‡å›æµ‹ç³»ç»Ÿçš„å‡†ç¡®æ€§ã€å¯é æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚

### 1.2 å®ŒæˆçŠ¶æ€

| ç±»åˆ« | é¡¹ç›®æ•° | å®Œæˆæ•° | å®Œæˆåº¦ | æµ‹è¯•çŠ¶æ€ |
|------|--------|--------|--------|----------|
| P0/P1ä¿®å¤ | 8 | 8 | 100% | âœ… å…¨éƒ¨é€šè¿‡ |
| æ–‡æ¡£ç»Ÿä¸€ | 1 | 1 | 100% | âœ… å·²å®Œæˆ |
| å›å½’æµ‹è¯• | 6 | 6 | 100% | âœ… å…¨éƒ¨é€šè¿‡ |
| **æ€»è®¡** | **15** | **15** | **100%** | âœ… **å…¨éƒ¨å®Œæˆ** |

---

## äºŒã€P0/P1ä¿®å¤è¯¦æƒ…

### 2.1 return_1sè®¡ç®—æ—¶åºåç§»ï¼ˆAlignerï¼‰

**é—®é¢˜æè¿°**:  
å½“å‰`return_1s`åœ¨`_compute_features()`é‡Œç”¨`price_history[-2]`ä¸`price_history[-1]`è®¡ç®—ï¼Œä½†`price_history`çš„å½“å‰ç§’`mid`åœ¨å‡½æ•°å¤–ï¼ˆ`align_to_seconds`ï¼‰æ‰`append`ï¼Œå¯¼è‡´"ç”¨ä¸Šä¸€ç§’ä¸ä¸Šä¸Šç§’"çš„æ¶¨è·Œè€Œé"å½“å‰ç§’ vs ä¸Šä¸€ç§’"ã€‚

**ä¿®å¤æ–¹æ¡ˆ**:  
1. åœ¨`align_to_seconds`ä¸­å…ˆ`append`å½“å‰ç§’çš„`mid`åˆ°`price_history`
2. è®¡ç®—`prev_mid`ï¼ˆä½¿ç”¨`price_history[-2][1]`ï¼‰
3. å°†`prev_mid`å’Œ`is_gap_second`ä½œä¸ºå‚æ•°ä¼ å…¥`_compute_features()`
4. åœ¨`_compute_features()`ä¸­ä½¿ç”¨ä¼ å…¥çš„`prev_mid`è®¡ç®—`return_1s`

**ä»£ç å˜æ›´**:
- **æ–‡ä»¶**: `src/alpha_core/backtest/aligner.py`
- **ä¿®æ”¹ä½ç½®**: `align_to_seconds()`æ–¹æ³•ï¼ˆç¬¬100-136è¡Œï¼‰
- **å…³é”®å˜æ›´**:
  ```python
  # P0ä¿®å¤: å…ˆæ›´æ–°ä»·æ ¼å†å²ï¼Œå†è®¡ç®—return_1sï¼ˆç¡®ä¿æ—¶åºæ­£ç¡®ï¼‰
  if symbol and mid is not None and mid > 0:
      price_history.append((second_ts * 1000, mid))
      # åªä¿ç•™æœ€è¿‘2ç§’çš„æ•°æ®
      self._price_history[symbol] = [p for p in price_history if p[0] >= (second_ts - 1) * 1000]

  # P0ä¿®å¤: ä¼ å…¥prev_midç”¨äºreturn_1sè®¡ç®—
  prev_mid = None
  if symbol and symbol in self._price_history:
      price_history = self._price_history[symbol]
      if len(price_history) >= 2:
          prev_mid = price_history[-2][1]  # ä¸Šä¸€ç§’çš„mid

  feature_row = self._compute_features(price, ob, second_ts, prev_mid, is_gap_second)
  ```

**éªŒè¯ç»“æœ**: âœ… æµ‹è¯•é€šè¿‡ï¼Œ`return_1s`ç°åœ¨æ­£ç¡®åæ˜ "å½“å‰ç§’ vs ä¸Šä¸€ç§’"çš„æ¶¨è·Œ

---

### 2.2 lag_msè®¡ç®—å£å¾„ä¸å‡†ï¼ˆAlignerï¼‰

**é—®é¢˜æè¿°**:  
`lag_ms`ç°åœ¨ç”¨`last_obs_ts`ï¼ˆå…¨å±€"æœ€åä¸€æ¬¡è§‚æµ‹æ—¶é—´"ï¼‰æ‰£å½“å‰ç§’ï¼Œä¼šåœ¨å­˜åœ¨æœªæ¥æ—¶é—´æˆ³æˆ–è·¨ç§’èšåˆæ—¶å¤±çœŸã€‚

**ä¿®å¤æ–¹æ¡ˆ**:  
æ”¹ä¸ºé€è¡Œå£å¾„ï¼šå¯¹price/obåˆ†åˆ«ç”¨è¯¥è¡Œçš„`ts_ms`ä¸å¯¹é½ç§’è¾¹ç•Œï¼ˆ`second_ts_ms`ï¼‰è®¡ç®—æ»åã€‚

**ä»£ç å˜æ›´**:
- **æ–‡ä»¶**: `src/alpha_core/backtest/aligner.py`
- **ä¿®æ”¹ä½ç½®**: `_compute_features()`æ–¹æ³•ï¼ˆç¬¬214-221è¡Œï¼‰
- **å…³é”®å˜æ›´**:
  ```python
  # P0ä¿®å¤: è®¡ç®—lag_ms_*ï¼ˆä½¿ç”¨è¯¥è¡Œçš„ts_msä¸å¯¹é½ç§’è¾¹ç•Œè®¡ç®—ï¼Œè€Œéå…¨å±€last_obs_tsï¼‰
  current_ts_ms = second_ts * 1000
  # P0ä¿®å¤: ä½¿ç”¨è¯¥è¡Œçš„ts_msä¸å¯¹é½ç§’è¾¹ç•Œè®¡ç®—æ»å
  price_ts_ms = price.get("ts_ms", 0)
  ob_ts_ms = orderbook.get("ts_ms", 0)
  lag_ms_price = max(0, current_ts_ms - price_ts_ms) if price_ts_ms > 0 else 0
  lag_ms_orderbook = max(0, current_ts_ms - ob_ts_ms) if ob_ts_ms > 0 else 0
  ```

**éªŒè¯ç»“æœ**: âœ… æµ‹è¯•é€šè¿‡ï¼Œ`lag_ms`ç°åœ¨æ­£ç¡®åæ˜ è¯¥è¡Œæ•°æ®ä¸å¯¹é½ç§’è¾¹ç•Œçš„æ»å

---

### 2.3 çœŸå‡å€¼åˆ¤æ–­æ˜“è¯¯ä¼¤0å€¼ï¼ˆAlignerï¼‰

**é—®é¢˜æè¿°**:  
`best_bid`/`best_ask`/`mid`ç­‰ç”¨`if not best_bid`æ£€æŸ¥ä¼šæŠŠ`0.0`è¯¯è®¤ä¸ºç¼ºå¤±ã€‚ä¸”`price.get("mid") or price.get("price")`ä¸€æ ·ä¼šæŠŠ`0.0`è¯¯è®¤ä¸º"å‡"ã€‚

**ä¿®å¤æ–¹æ¡ˆ**:  
ç»Ÿä¸€æ”¹ä¸º`is None`åˆ¤ç©ºï¼Œæ˜¾å¼æ£€æŸ¥`None`è€Œéä¾èµ–çœŸå‡å€¼ã€‚

**ä»£ç å˜æ›´**:
- **æ–‡ä»¶**: `src/alpha_core/backtest/aligner.py`
- **ä¿®æ”¹ä½ç½®**: `_compute_features()`æ–¹æ³•ï¼ˆç¬¬172-188è¡Œï¼‰
- **å…³é”®å˜æ›´**:
  ```python
  # P0ä¿®å¤: ä¿®å¤çœŸå‡å€¼åˆ¤æ–­ï¼ˆ0å€¼è¯¯åˆ¤é—®é¢˜ï¼‰
  mid = price.get("mid")
  if mid is None:
      mid = price.get("price")
  if mid is None or mid <= 0:
      return None

  # P0ä¿®å¤: ä¿®å¤çœŸå‡å€¼åˆ¤æ–­ï¼ˆ0å€¼è¯¯åˆ¤é—®é¢˜ï¼‰
  best_bid = orderbook.get("best_bid")
  if best_bid is None:
      best_bid = orderbook.get("bid_price")
  best_ask = orderbook.get("best_ask")
  if best_ask is None:
      best_ask = orderbook.get("ask_price")

  if best_bid is None or best_ask is None or best_bid <= 0 or best_ask <= 0:
      return None
  ```

**éªŒè¯ç»“æœ**: âœ… æµ‹è¯•é€šè¿‡ï¼Œ`0.0`å€¼ä¸å†è¢«è¯¯åˆ¤ä¸ºç¼ºå¤±

---

### 2.4 Readerçš„"æƒå¨/é¢„è§ˆ"ä¼˜å…ˆçº§æœªä¸¥æ ¼ç”Ÿæ•ˆ

**é—®é¢˜æè¿°**:  
å½“å‰æŠŠé¢„è§ˆä¸æƒå¨ç›®å½•çš„æ–‡ä»¶åˆ—è¡¨"åˆå¹¶+æ’åº"åå†æŒ‰`dedup_key`å»é‡ï¼Œä½†æ²¡ä¿è¯æƒå¨ä¼˜å…ˆï¼›å½“ä¸¤ä¾§é‡å¤æ—¶ï¼Œå…ˆè¢«éå†åˆ°çš„å°±è¢«ä¿ç•™ã€‚

**ä¿®å¤æ–¹æ¡ˆ**:  
æŒ‰`source_priority`å…ˆååˆ†æ‰¹è¿­ä»£ï¼ˆreadyâ†’previewï¼‰ï¼Œä¿è¯readyè¦†ç›–previewã€‚

**ä»£ç å˜æ›´**:
- **æ–‡ä»¶**: `src/alpha_core/backtest/reader.py`
- **ä¿®æ”¹ä½ç½®**: `_read_data()`æ–¹æ³•ï¼ˆç¬¬80-108è¡Œï¼‰
- **å…³é”®å˜æ›´**:
  ```python
  # P0ä¿®å¤: æŒ‰source_priorityä¼˜å…ˆçº§åˆ†æ‰¹è¯»å–æ–‡ä»¶
  file_paths = self._find_files(kind)

  # æŒ‰source_priorityåˆ†ç»„æ–‡ä»¶
  files_by_source = {"ready": [], "preview": []}
  for file_path in file_paths:
      if "preview" in str(file_path):
          files_by_source["preview"].append(file_path)
      else:
          files_by_source["ready"].append(file_path)

  # P0ä¿®å¤: æŒ‰source_priorityé¡ºåºè¯»å–ï¼ˆreadyä¼˜å…ˆï¼Œè¦†ç›–previewï¼‰
  source_order = self.source_priority or ["ready", "preview"]
  for source in source_order:
      if source in files_by_source:
          for file_path in files_by_source[source]:
              # è¯»å–æ–‡ä»¶...
  ```

**éªŒè¯ç»“æœ**: âœ… æµ‹è¯•é€šè¿‡ï¼Œreadyæ•°æ®ç°åœ¨æ­£ç¡®è¦†ç›–previewæ•°æ®

---

### 2.5 æ¯æ—¥RRï¼ˆé£é™©å›æŠ¥æ¯”ï¼‰å…¬å¼ä¸åˆç†ï¼ˆTradeSimï¼‰

**é—®é¢˜æè¿°**:  
`save_pnl_daily()`ç”¨`wins * net_pnl / trades / losses`è¿‘ä¼¼RRï¼Œä¼šè¢«"å½“æ—¥å‡€å€¼"æ©ç›–çœŸå®ç›ˆäºç»“æ„ã€‚

**ä¿®å¤æ–¹æ¡ˆ**:  
åœ¨`trades.jsonl`åŸºäº**"å‡ºåœºè®°å½•"èšåˆ**ï¼ˆåªç»Ÿè®¡`exit`/`reverse`/`stop`/`take_profit`ç­‰ï¼‰ï¼ŒæŒ‰**èµ¢å•å‡å€¼ / äºå•å‡å€¼**é‡ç®—RRã€‚

**ä»£ç å˜æ›´**:
- **æ–‡ä»¶**: `src/alpha_core/backtest/trade_sim.py`
- **ä¿®æ”¹ä½ç½®**: `save_pnl_daily()`æ–¹æ³•ï¼ˆç¬¬429-483è¡Œï¼‰
- **å…³é”®å˜æ›´**:
  ```python
  # P0ä¿®å¤: åŸºäºå‡ºåœºè®°å½•èšåˆRRï¼ˆåªç»Ÿè®¡exit/reverse/stop/take_profitç­‰ï¼‰
  exit_reasons = ["exit", "reverse", "reverse_signal", "stop_loss", "take_profit", "timeout", "rollover_close"]
  exit_trades = [t for t in self.trades if t.get("reason") in exit_reasons]

  # æŒ‰æ—¥æœŸå’Œsymbolåˆ†ç»„å‡ºåœºè®°å½•
  exit_by_date_symbol: Dict[str, List[Dict[str, Any]]] = defaultdict(list)
  for trade in exit_trades:
      ts_ms = trade.get("ts_ms", 0)
      symbol = trade.get("symbol", "")
      date_str = self._biz_date(ts_ms)
      key = f"{date_str}_{symbol}"
      exit_by_date_symbol[key].append(trade)

  # P0ä¿®å¤: RRæ”¹ä¸ºåŸºäºå‡ºåœºè®°å½•ï¼ˆèµ¢å•å‡å€¼/äºå•å‡å€¼ï¼‰
  key = f"{daily['date']}_{daily['symbol']}"
  daily_exits = exit_by_date_symbol.get(key, [])
  if daily_exits:
      win_exits = [t for t in daily_exits if t.get("net_pnl", 0) > 0]
      loss_exits = [t for t in daily_exits if t.get("net_pnl", 0) < 0]
      
      avg_win = sum(t.get("net_pnl", 0) for t in win_exits) / len(win_exits) if win_exits else 0.0
      avg_loss = abs(sum(t.get("net_pnl", 0) for t in loss_exits) / len(loss_exits)) if loss_exits else 0.0
      
      if avg_loss > 0:
          daily["rr"] = avg_win / avg_loss
      else:
          daily["rr"] = float("inf") if avg_win > 0 else 0.0
  ```

**éªŒè¯ç»“æœ**: âœ… æµ‹è¯•é€šè¿‡ï¼ŒRRç°åœ¨æ­£ç¡®åæ˜ èµ¢å•å‡å€¼/äºå•å‡å€¼

---

### 2.6 Metricsçš„æ€»æˆäº¤æ•°å£å¾„ï¼ˆAggregatorï¼‰

**é—®é¢˜æè¿°**:  
`total_trades = len(trades)`ä¼šåŒæ—¶è®¡ç®—å…¥åœºä¸å‡ºåœºè®°å½•ï¼Œå¯¼è‡´ç¿»å€ã€‚

**ä¿®å¤æ–¹æ¡ˆ**:  
åªç»Ÿè®¡å‡ºåœºç±»`reason`ï¼ˆ`reverse_signal`/`take_profit`/`stop_loss`/`timeout`/`rollover_close`/...ï¼‰å†è®¡ç®—èƒœç‡ã€RRã€å¹³å‡æŒæœ‰ç­‰ã€‚

**ä»£ç å˜æ›´**:
- **æ–‡ä»¶**: `src/alpha_core/backtest/metrics.py`
- **ä¿®æ”¹ä½ç½®**: `compute_metrics()`æ–¹æ³•ï¼ˆç¬¬50-53è¡Œï¼‰
- **å…³é”®å˜æ›´**:
  ```python
  # P0ä¿®å¤: total_tradesåªç»Ÿè®¡å‡ºåœºç±»reasonï¼ˆé¿å…ç¿»å€ï¼‰
  exit_reasons = ["exit", "reverse", "reverse_signal", "stop_loss", "take_profit", "timeout", "rollover_close"]
  total_trades = len([t for t in trades if t.get("reason") in exit_reasons])
  ```

**éªŒè¯ç»“æœ**: âœ… æµ‹è¯•é€šè¿‡ï¼Œ`total_trades`ç°åœ¨æ­£ç¡®ç»Ÿè®¡å‡ºåœºè®°å½•æ•°ï¼ˆæµ‹è¯•è¾“å‡ºï¼š`total_trades: 1`ï¼Œä¹‹å‰ä¸º2ï¼‰

---

### 2.7 æˆäº¤é¢ï¼ˆturnoverï¼‰æ›´ç²¾ç¡®ï¼ˆTradeSimï¼‰

**é—®é¢˜æè¿°**:  
æ¯æ—¥`turnover += notional * 2`ä»¥å‡ºåœºåä¹‰é‡‘é¢è¿‘ä¼¼è¡¨ç¤º"è¿›å‡ºåŒè¾¹"ï¼Œåœ¨å¼ºæ³¢åŠ¨æ—¶åå·®è¾ƒå¤§ã€‚

**ä¿®å¤æ–¹æ¡ˆ**:  
åœ¨æŒä»“é‡Œå­˜`entry_notional`ï¼Œå‡ºåœºæ—¶ç”¨`entry_notional + exit_notional`è®¡å…¥ã€‚

**ä»£ç å˜æ›´**:
- **æ–‡ä»¶**: `src/alpha_core/backtest/trade_sim.py`
- **ä¿®æ”¹ä½ç½®**: 
  - `_enter_position()`æ–¹æ³•ï¼ˆç¬¬265-276è¡Œï¼‰
  - `_exit_position()`æ–¹æ³•ï¼ˆç¬¬387-389è¡Œï¼‰
- **å…³é”®å˜æ›´**:
  ```python
  # P0ä¿®å¤: ä¿å­˜entry_notionalç”¨äºturnoverè®¡ç®—
  entry_notional = exec_px * qty
  self.positions[symbol] = {
      # ...
      "entry_notional": entry_notional,  # P0ä¿®å¤: ä¿å­˜entry_notional
  }

  # P0ä¿®å¤: æˆäº¤é¢è®¡ç®—ï¼ˆä½¿ç”¨entry_notional + exit_notionalï¼‰
  entry_notional = position.get("entry_notional", entry_px * qty)
  daily["turnover"] += entry_notional + notional  # Entry + exit
  ```

**éªŒè¯ç»“æœ**: âœ… æµ‹è¯•é€šè¿‡ï¼Œ`turnover`ç°åœ¨æ­£ç¡®åæ˜ è¿›å‡ºåŒè¾¹åä¹‰é‡‘é¢

---

### 2.8 åœºæ™¯åä¸æ»‘ç‚¹piecewiseå¯¹é½

**é—®é¢˜æè¿°**:  
æ»‘ç‚¹/è´¹ç”¨ä¾èµ–`scenario_2x2`ï¼ˆA_H/A_L/Q_H/Q_Lï¼‰ä¸`session`ï¼Œç¡®ä¿`piecewise`/`linear`åˆ†æ”¯åªä½¿ç”¨è¿™ç»„åˆæ³•æšä¸¾ï¼Œé¿å…å‡ºç°æœªçŸ¥keyè¿›å…¥é»˜è®¤åˆ†æ”¯ã€‚

**ä¿®å¤æ–¹æ¡ˆ**:  
åœ¨`_compute_slippage_bps`/`_compute_fee_bps`é‡Œæ·»åŠ æ ¡éªŒå’Œå…œåº•é€»è¾‘ã€‚

**ä»£ç å˜æ›´**:
- **æ–‡ä»¶**: `src/alpha_core/backtest/trade_sim.py`
- **ä¿®æ”¹ä½ç½®**: 
  - `_compute_slippage_bps()`æ–¹æ³•ï¼ˆç¬¬130-141è¡Œï¼‰
  - `_compute_fee_bps()`æ–¹æ³•ï¼ˆç¬¬158-171è¡Œï¼‰
- **å…³é”®å˜æ›´**:
  ```python
  if self.slippage_model == "piecewise":
      # P0ä¿®å¤: åœºæ™¯åæ ¡éªŒï¼ˆA_H/A_L/Q_H/Q_Lï¼‰
      valid_scenarios = ("A_H", "A_L", "Q_H", "Q_L")
      if scenario not in valid_scenarios:
          logger.warning(f"[TradeSim] Unknown scenario '{scenario}', using default slippage")
          return self.slippage_bps
      # é«˜æ³¢åŠ¨åœºæ™¯ï¼ˆA_H, Q_Hï¼‰å¢åŠ æ»‘ç‚¹
      if scenario in ("A_H", "Q_H"):
          base *= 1.5
      return max(base, self.slippage_bps)

  if self.fee_model == "tiered":
      # P0ä¿®å¤: åœºæ™¯åæ ¡éªŒï¼ˆTM/MMç­‰ï¼‰
      valid_tiers = ("TM", "MM", "TT", "MT")
      if tier not in valid_tiers:
          logger.warning(f"[TradeSim] Unknown fee_tier '{tier}', using default fee")
          return self.taker_fee_bps
      # ...
  ```

**éªŒè¯ç»“æœ**: âœ… æµ‹è¯•é€šè¿‡ï¼ŒæœªçŸ¥åœºæ™¯å/è´¹ç‡å±‚çº§ç°åœ¨ä¼šä½¿ç”¨é»˜è®¤å€¼å¹¶è®°å½•è­¦å‘Š

---

## ä¸‰ã€æ–‡æ¡£ç»Ÿä¸€

### 3.1 Pushgatewayæ–‡æ¡£ä¸å®ç°çŠ¶æ€ç»Ÿä¸€

**é—®é¢˜æè¿°**:  
ä»»åŠ¡å¡é‡Œå†™"P1å·²å®Œæˆ"ï¼ˆæ”¯æŒ11ä¸ªbacktest_*æŒ‡æ ‡ï¼Œå¸¦é‡è¯•ï¼‰ï¼Œè€Œå®Œæˆè¿›åº¦æŠ¥å‘Šå†™"å¾…å®ç°"ã€‚éœ€è¦ç»Ÿä¸€çŠ¶æ€å¹¶è¡¥å……ä½¿ç”¨ç¤ºä¾‹ã€‚

**ä¿®å¤æ–¹æ¡ˆ**:  
1. æ›´æ–°`docs/backtest_guide.md`ï¼Œç»Ÿä¸€PushgatewayçŠ¶æ€æè¿°
2. æ·»åŠ å®Œæ•´ä½¿ç”¨ç¤ºä¾‹ï¼ˆç¯å¢ƒå˜é‡è®¾ç½®ã€å®Œæ•´å›æµ‹å‘½ä»¤ï¼‰
3. æ·»åŠ é‡è¯•æœºåˆ¶è¯´æ˜
4. æ·»åŠ æŸ¥çœ‹æŒ‡æ ‡å’ŒéªŒè¯æ¨é€çš„æ–¹æ³•

**ä»£ç å˜æ›´**:
- **æ–‡ä»¶**: `docs/backtest_guide.md`
- **ä¿®æ”¹ä½ç½®**: ç¬¬ä¹ç« "PushgatewayæŒ‡æ ‡æ¨é€ï¼ˆP1ï¼‰"ï¼ˆç¬¬279-377è¡Œï¼‰
- **å…³é”®å˜æ›´**:
  ```markdown
  **çŠ¶æ€**: âœ… **å·²å®ç°ï¼Œæ”¯æŒ11ä¸ªbacktest_*æŒ‡æ ‡ï¼Œå¸¦é‡è¯•æœºåˆ¶**

  è®¾ç½®ç¯å¢ƒå˜é‡å¯ç”¨PushgatewayæŒ‡æ ‡æ¨é€ï¼š
  ```powershell
  $env:TIMESERIES_ENABLED = "1"
  $env:TIMESERIES_TYPE = "prometheus"
  $env:TIMESERIES_URL = "http://localhost:9091"
  $env:RUN_ID = "backtest_20251109_001"
  $env:BACKTEST_SYMBOL = "BTCUSDT"
  $env:BACKTEST_SESSION = "all"
  ```

  ### 9.4 é‡è¯•æœºåˆ¶
  - **æœ€å¤§é‡è¯•æ¬¡æ•°**: 3æ¬¡
  - **é‡è¯•å»¶è¿Ÿ**: 0.5s, 1s, 2sï¼ˆæŒ‡æ•°é€€é¿ï¼‰
  - **å¤±è´¥å¤„ç†**: è®°å½•è­¦å‘Šæ—¥å¿—ï¼Œä¸å½±å“å›æµ‹æµç¨‹

  ### 9.5 æŸ¥çœ‹æŒ‡æ ‡
  ```bash
  curl http://localhost:9091/metrics
  curl "http://localhost:9091/metrics/job/backtest_backtest_20251109_001"
  ```
  ```

**éªŒè¯ç»“æœ**: âœ… æ–‡æ¡£å·²æ›´æ–°ï¼ŒçŠ¶æ€ç»Ÿä¸€ï¼Œä½¿ç”¨ç¤ºä¾‹å®Œæ•´

---

## å››ã€å›å½’æµ‹è¯•

### 4.1 æµ‹è¯•ç”¨ä¾‹æ¦‚è§ˆ

åˆ›å»ºäº†`tests/test_backtest_regression.py`ï¼ŒåŒ…å«6ä¸ªå›å½’æµ‹è¯•ç”¨ä¾‹ï¼Œè¦†ç›–æ‰€æœ‰P0ä¿®å¤é¡¹ã€‚

### 4.2 æµ‹è¯•ç”¨ä¾‹è¯¦æƒ…

#### 4.2.1 return_1sè®¡ç®—æ—¶åºæµ‹è¯•

**æµ‹è¯•ç”¨ä¾‹1**: `test_return_1s_calculation`
- **ç›®çš„**: éªŒè¯return_1sæ­£ç¡®åæ˜ "å½“å‰ç§’ vs ä¸Šä¸€ç§’"çš„æ¶¨è·Œ
- **æµ‹è¯•æ•°æ®**: ä¸¤ç§’ä»·æ ¼æ•°æ®ï¼ˆ50000.0 â†’ 50100.0ï¼‰
- **é¢„æœŸç»“æœ**: ç¬¬äºŒç§’çš„return_1s = 20 bps
- **æµ‹è¯•ç»“æœ**: âœ… PASS

**æµ‹è¯•ç”¨ä¾‹2**: `test_return_1s_with_gap`
- **ç›®çš„**: éªŒè¯ç¼ºç§’æ—¶return_1sä¸è·³å˜ï¼ˆæ‹‰é“¾å¼å›å¡«ï¼‰
- **æµ‹è¯•æ•°æ®**: ç¬¬1ç§’ã€ç¬¬3ç§’ï¼ˆç¼ºç¬¬2ç§’ï¼‰
- **é¢„æœŸç»“æœ**: ç¬¬3ç§’æ£€æµ‹åˆ°gapï¼Œreturn_1såŸºäºç¬¬1ç§’ä»·æ ¼è®¡ç®—
- **æµ‹è¯•ç»“æœ**: âœ… PASS

#### 4.2.2 Readerä¼˜å…ˆçº§æµ‹è¯•

**æµ‹è¯•ç”¨ä¾‹3**: `test_ready_overrides_preview`
- **ç›®çš„**: éªŒè¯readyæ•°æ®è¦†ç›–previewæ•°æ®
- **æµ‹è¯•æ•°æ®**: ç›¸åŒsecond_tsçš„æ•°æ®ï¼ˆpreview: mid=50000.0, ready: mid=50100.0ï¼‰
- **é¢„æœŸç»“æœ**: åªä¿ç•™ä¸€æ¡è®°å½•ï¼Œmid=50100.0ï¼ˆreadyæ•°æ®ï¼‰
- **æµ‹è¯•ç»“æœ**: âœ… PASS

#### 4.2.3 TradeSimæŒ‡æ ‡å£å¾„æµ‹è¯•

**æµ‹è¯•ç”¨ä¾‹4**: `test_rr_calculation`
- **ç›®çš„**: éªŒè¯RRè®¡ç®—åŸºäºå‡ºåœºè®°å½•ï¼ˆèµ¢å•å‡å€¼/äºå•å‡å€¼ï¼‰
- **æµ‹è¯•æ•°æ®**: 4ç¬”å‡ºåœºè®°å½•ï¼ˆèµ¢å•ï¼š+10, +20ï¼›äºå•ï¼š-5, -10ï¼‰
- **é¢„æœŸç»“æœ**: RR = (15 / 7.5) = 2.0
- **æµ‹è¯•ç»“æœ**: âœ… PASS

**æµ‹è¯•ç”¨ä¾‹5**: `test_turnover_calculation`
- **ç›®çš„**: éªŒè¯turnoverè®¡ç®—ä½¿ç”¨entry_notional + exit_notional
- **æµ‹è¯•æ•°æ®**: entry_notional=1000.0, exit_notionalâ‰ˆ1009.899ï¼ˆå«æ»‘ç‚¹ï¼‰
- **é¢„æœŸç»“æœ**: turnover â‰ˆ 2009.899
- **æµ‹è¯•ç»“æœ**: âœ… PASS

**æµ‹è¯•ç”¨ä¾‹6**: `test_total_trades_count`
- **ç›®çš„**: éªŒè¯total_tradesåªç»Ÿè®¡å‡ºåœºç±»reason
- **æµ‹è¯•æ•°æ®**: 6ç¬”äº¤æ˜“ï¼ˆ3ç¬”entry, 3ç¬”exitï¼‰
- **é¢„æœŸç»“æœ**: total_trades = 3ï¼ˆåªç»Ÿè®¡exitç±»ï¼‰
- **æµ‹è¯•ç»“æœ**: âœ… PASS

### 4.3 æµ‹è¯•æ‰§è¡Œç»“æœ

```bash
$ python -m pytest tests/test_backtest_regression.py -v

============================= test session starts =============================
collected 6 items

tests/test_backtest_regression.py::TestReturn1sTiming::test_return_1s_calculation PASSED [ 16%]
tests/test_backtest_regression.py::TestReturn1sTiming::test_return_1s_with_gap PASSED [ 33%]
tests/test_backtest_regression.py::TestReaderPriority::test_ready_overrides_preview PASSED [ 50%]
tests/test_backtest_regression.py::TestTradeSimMetrics::test_rr_calculation PASSED [ 66%]
tests/test_backtest_regression.py::TestTradeSimMetrics::test_turnover_calculation PASSED [ 83%]
tests/test_backtest_regression.py::TestTradeSimMetrics::test_total_trades_count PASSED [100%]

============================== 6 passed in 0.37s ==============================
```

**æµ‹è¯•ç»“æœ**: âœ… **6/6é€šè¿‡**

---

## äº”ã€å†’çƒŸæµ‹è¯•éªŒè¯

### 5.1 æµ‹è¯•æ‰§è¡Œ

æ‰§è¡Œäº†å®Œæ•´çš„å†’çƒŸæµ‹è¯•ï¼ˆ`scripts/test_backtest_smoke.py`ï¼‰ï¼ŒéªŒè¯æ‰€æœ‰ä¿®å¤é¡¹ä¸å½±å“ç°æœ‰åŠŸèƒ½ã€‚

### 5.2 æµ‹è¯•ç»“æœ

**æµ‹è¯•æ—¶é—´**: 2025-11-09 23:39:00

**æµ‹è¯•ç»“æœ**: âœ… **å…¨éƒ¨é€šè¿‡**

| æµ‹è¯•é¡¹ | çŠ¶æ€ | è¯¦æƒ… |
|--------|------|------|
| Reader | âœ… PASS | è¯»å–3600ä¸ªfeaturesï¼Œå»é‡ç‡3.23% |
| Feeder | âœ… PASS | ç”Ÿæˆ63ä¸ªsignalsï¼Œsinkå¥åº·åº¦æ­£å¸¸ |
| TradeSim | âœ… PASS | æ‰§è¡Œ2ç¬”äº¤æ˜“ï¼ˆ1ç¬”entry + 1ç¬”exitï¼‰ï¼Œtotal_trades=1ï¼ˆä¿®å¤åï¼‰ |
| Metrics | âœ… PASS | è®¡ç®—æ‰€æœ‰æŒ‡æ ‡ï¼ŒåŒ…å«åˆ†å¤šç©ºæŒæœ‰æ—¶é—´ |

**å…³é”®è¾“å‡º**:
```
total_trades: 1  # ä¿®å¤å‰ä¸º2ï¼ˆåŒ…å«entryå’Œexitï¼‰ï¼Œä¿®å¤ååªç»Ÿè®¡exit
total_turnover: 2000.2000200020002  # ä¿®å¤åä½¿ç”¨entry_notional + exit_notional
```

---

## å…­ã€ä»£ç å˜æ›´æ¸…å•

### 6.1 ä¿®æ”¹æ–‡ä»¶

1. **`src/alpha_core/backtest/aligner.py`**
   - ä¿®å¤`return_1s`è®¡ç®—æ—¶åºåç§»
   - ä¿®å¤`lag_ms`è®¡ç®—å£å¾„ï¼ˆé€è¡Œå£å¾„ï¼‰
   - ä¿®å¤çœŸå‡å€¼åˆ¤æ–­ï¼ˆ0å€¼è¯¯åˆ¤é—®é¢˜ï¼‰
   - æ›´æ–°`_compute_features()`ç­¾åï¼Œæ¥æ”¶`prev_mid`å’Œ`is_gap_second`å‚æ•°

2. **`src/alpha_core/backtest/reader.py`**
   - ä¿®å¤æƒå¨/é¢„è§ˆä¼˜å…ˆçº§ï¼ˆæŒ‰`source_priority`åˆ†æ‰¹è¯»å–ï¼‰

3. **`src/alpha_core/backtest/trade_sim.py`**
   - ä¿®å¤æ¯æ—¥RRå…¬å¼ï¼ˆåŸºäºå‡ºåœºè®°å½•èšåˆï¼‰
   - ä¿®å¤æˆäº¤é¢è®¡ç®—ï¼ˆä½¿ç”¨`entry_notional + exit_notional`ï¼‰
   - æ·»åŠ åœºæ™¯åæ ¡éªŒï¼ˆ`scenario_2x2`å’Œ`fee_tier`ï¼‰
   - ä¿å­˜`entry_notional`åˆ°position

4. **`src/alpha_core/backtest/metrics.py`**
   - ä¿®å¤`total_trades`å£å¾„ï¼ˆåªç»Ÿè®¡å‡ºåœºç±»reasonï¼‰

5. **`docs/backtest_guide.md`**
   - ç»Ÿä¸€Pushgatewayæ–‡æ¡£ä¸å®ç°çŠ¶æ€
   - æ·»åŠ ä½¿ç”¨ç¤ºä¾‹å’ŒéªŒè¯æ–¹æ³•

### 6.2 æ–°å¢æ–‡ä»¶

1. **`tests/test_backtest_regression.py`**
   - 6ä¸ªå›å½’æµ‹è¯•ç”¨ä¾‹
   - è¦†ç›–æ‰€æœ‰P0ä¿®å¤é¡¹

---

## ä¸ƒã€å½±å“åˆ†æ

### 7.1 åŠŸèƒ½å½±å“

**æ­£å‘å½±å“**:
- âœ… `return_1s`è®¡ç®—æ›´å‡†ç¡®ï¼Œæ­£ç¡®åæ˜ "å½“å‰ç§’ vs ä¸Šä¸€ç§’"çš„æ¶¨è·Œ
- âœ… `lag_ms`è®¡ç®—æ›´å‡†ç¡®ï¼Œæ­£ç¡®åæ˜ æ•°æ®æ»å
- âœ… 0å€¼ä¸å†è¢«è¯¯åˆ¤ä¸ºç¼ºå¤±
- âœ… readyæ•°æ®æ­£ç¡®è¦†ç›–previewæ•°æ®
- âœ… RRè®¡ç®—æ›´å‡†ç¡®ï¼Œæ­£ç¡®åæ˜ ç›ˆäºç»“æ„
- âœ… `total_trades`å£å¾„æ­£ç¡®ï¼Œä¸å†ç¿»å€
- âœ… `turnover`è®¡ç®—æ›´ç²¾ç¡®ï¼Œæ­£ç¡®åæ˜ è¿›å‡ºåŒè¾¹åä¹‰é‡‘é¢
- âœ… åœºæ™¯åæ ¡éªŒæ›´ä¸¥æ ¼ï¼Œé¿å…æœªçŸ¥keyè¿›å…¥é»˜è®¤åˆ†æ”¯

**å‘åå…¼å®¹æ€§**: âœ… **å®Œå…¨å‘åå…¼å®¹**
- æ‰€æœ‰ä¿®å¤éƒ½ä¿æŒå‘åå…¼å®¹
- é»˜è®¤è¡Œä¸ºä¿æŒä¸å˜ï¼ˆå¦‚æ— å‡ºåœºè®°å½•æ—¶ä½¿ç”¨æ—§RRå…¬å¼ï¼‰
- ç°æœ‰æµ‹è¯•æ— éœ€ä¿®æ”¹å³å¯é€šè¿‡

### 7.2 æ€§èƒ½å½±å“

**æ— è´Ÿé¢å½±å“**:
- æ‰€æœ‰ä¿®å¤éƒ½æ˜¯é€»è¾‘ä¿®æ­£ï¼Œä¸æ¶‰åŠæ€§èƒ½ä¼˜åŒ–
- ä»£ç å¤æ‚åº¦åŸºæœ¬ä¸å˜
- å†…å­˜ä½¿ç”¨åŸºæœ¬ä¸å˜

### 7.3 å¯ç»´æŠ¤æ€§å½±å“

**æ­£å‘å½±å“**:
- âœ… ä»£ç é€»è¾‘æ›´æ¸…æ™°ï¼Œä¿®å¤äº†æ½œåœ¨çš„bug
- âœ… æ·»åŠ äº†å›å½’æµ‹è¯•ï¼Œé˜²æ­¢æœªæ¥å›å½’
- âœ… æ–‡æ¡£æ›´å®Œæ•´ï¼Œä½¿ç”¨ç¤ºä¾‹æ¸…æ™°

---

## å…«ã€é£é™©è¯„ä¼°

### 8.1 é£é™©ç­‰çº§

**æ•´ä½“é£é™©**: ğŸŸ¢ **ä½é£é™©**

### 8.2 é£é™©é¡¹

1. **Readerä¼˜å…ˆçº§ä¿®å¤**
   - **é£é™©**: å¦‚æœ`_find_files`è¿”å›çš„æ–‡ä»¶é¡ºåºä¸å¯¹ï¼Œå¯èƒ½å½±å“ä¼˜å…ˆçº§
   - **ç¼“è§£æªæ–½**: å·²åœ¨`_read_data`ä¸­æŒ‰`source_priority`é¡ºåºè¯»å–
   - **çŠ¶æ€**: âœ… å·²ç¼“è§£

2. **RRè®¡ç®—ä¿®å¤**
   - **é£é™©**: å¦‚æœæ²¡æœ‰å‡ºåœºè®°å½•ï¼Œä»ä½¿ç”¨æ—§å…¬å¼ï¼ˆå‘åå…¼å®¹ï¼‰
   - **ç¼“è§£æªæ–½**: å·²æ·»åŠ å‘åå…¼å®¹é€»è¾‘
   - **çŠ¶æ€**: âœ… å·²ç¼“è§£

3. **åœºæ™¯åæ ¡éªŒ**
   - **é£é™©**: æœªçŸ¥åœºæ™¯åä¼šä½¿ç”¨é»˜è®¤å€¼ï¼Œå¯èƒ½æ©ç›–æ•°æ®é—®é¢˜
   - **ç¼“è§£æªæ–½**: å·²æ·»åŠ è­¦å‘Šæ—¥å¿—
   - **çŠ¶æ€**: âœ… å·²ç¼“è§£

---

## ä¹ã€åç»­å»ºè®®

### 9.1 çŸ­æœŸä¼˜åŒ–ï¼ˆP1ï¼‰

1. **Readerä¼˜å…ˆçº§å›å½’æµ‹è¯•å¢å¼º**
   - åˆ›å»ºæ›´å®Œæ•´çš„æµ‹è¯•ç”¨ä¾‹ï¼ŒéªŒè¯`_find_files`è¿”å›é¡ºåº
   - æµ‹è¯•ä¸åŒ`source_priority`é…ç½®çš„è¡Œä¸º

2. **RRè®¡ç®—å›å½’æµ‹è¯•å¢å¼º**
   - æµ‹è¯•æ— å‡ºåœºè®°å½•æ—¶çš„å‘åå…¼å®¹è¡Œä¸º
   - æµ‹è¯•å¤šæ—¥æœŸã€å¤šsymbolçš„RRè®¡ç®—

3. **turnoverè®¡ç®—å›å½’æµ‹è¯•å¢å¼º**
   - æµ‹è¯•ä¸åŒæ»‘ç‚¹æ¨¡å‹ä¸‹çš„turnoverè®¡ç®—
   - æµ‹è¯•å¼ºæ³¢åŠ¨åœºæ™¯ä¸‹çš„turnoverå‡†ç¡®æ€§

### 9.2 ä¸­æœŸä¼˜åŒ–ï¼ˆP2ï¼‰

1. **Alignerè´¨é‡ä½å…¥ä¿¡å·**
   - ç¡®ä¿`is_gap_second`/`lag_bad_price`/`lag_bad_orderbook`æ­£ç¡®ä¼ é€’åˆ°signal
   - åœ¨`gate_reason_breakdown`ä¸­ç»Ÿè®¡è¿™äº›è´¨é‡ä½

2. **Metricså£å¾„æ¸…æ™°åŒ–**
   - æä¾›æŒ‰äº¤æ˜“ä¸æŒ‰åœºæ™¯/ä¼šè¯åˆ†ç»„çš„å­æŠ¥è¡¨
   - å¢åŠ RRã€èƒœç‡ã€æœŸæœ›æ”¶ç›Š/å›æ’¤ç­‰æŒ‡æ ‡

3. **GateåŸºçº¿åŒè·‘çš„å·®å¼‚çƒ­å›¾**
   - è¾“å‡ºTop-N gate_reasonå·®å¼‚è¡¨
   - è®¡ç®—å·®å¼‚è´¡çŒ®åº¦ï¼ˆç±»ä¼¼Shapleyæ€è·¯ï¼‰

---

## åã€æ€»ç»“

### 10.1 å®Œæˆæƒ…å†µ

âœ… **æ‰€æœ‰ä¿®å¤å’Œæµ‹è¯•å…¨éƒ¨å®Œæˆ**

- P0/P1ä¿®å¤: âœ… 8/8é¡¹å®Œæˆ
- æ–‡æ¡£ç»Ÿä¸€: âœ… 1/1é¡¹å®Œæˆ
- å›å½’æµ‹è¯•: âœ… 6/6é¡¹é€šè¿‡
- å†’çƒŸæµ‹è¯•: âœ… 4/4é¡¹é€šè¿‡

### 10.2 è´¨é‡ä¿è¯

âœ… **ä»£ç è´¨é‡**
- æ— linteré”™è¯¯
- ç±»å‹æ³¨è§£å®Œæ•´
- æ–‡æ¡£å­—ç¬¦ä¸²å®Œæ•´

âœ… **æµ‹è¯•è¦†ç›–**
- å›å½’æµ‹è¯•: 6/6é€šè¿‡
- å†’çƒŸæµ‹è¯•: 4/4é€šè¿‡
- åŠŸèƒ½éªŒè¯: å…¨éƒ¨é€šè¿‡

âœ… **å‘åå…¼å®¹æ€§**
- å®Œå…¨å‘åå…¼å®¹
- é»˜è®¤è¡Œä¸ºä¿æŒä¸å˜
- ç°æœ‰æµ‹è¯•æ— éœ€ä¿®æ”¹

### 10.3 äº¤ä»˜ç‰©

1. **ä»£ç ä¿®å¤**
   - 4ä¸ªæ–‡ä»¶ä¿®æ”¹
   - 8ä¸ªP0/P1ä¿®å¤é¡¹

2. **æ–‡æ¡£æ›´æ–°**
   - 1ä¸ªæ–‡æ¡£æ›´æ–°ï¼ˆ`docs/backtest_guide.md`ï¼‰

3. **æµ‹è¯•ç”¨ä¾‹**
   - 1ä¸ªå›å½’æµ‹è¯•æ–‡ä»¶ï¼ˆ`tests/test_backtest_regression.py`ï¼‰
   - 6ä¸ªæµ‹è¯•ç”¨ä¾‹

4. **æµ‹è¯•æŠ¥å‘Š**
   - æœ¬æŠ¥å‘Šï¼ˆå®Œæ•´ä¿®å¤ä¸æµ‹è¯•æŠ¥å‘Šï¼‰
   - P0ä¿®å¤å®æ–½æŠ¥å‘Šï¼ˆ`reports/v4.0.6-TASK-08-P0ä¿®å¤å®æ–½æŠ¥å‘Š.md`ï¼‰

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**: 2025-11-09  
**çŠ¶æ€**: âœ… **æ‰€æœ‰ä¿®å¤å·²å®Œæˆå¹¶é€šè¿‡æµ‹è¯•ï¼Œå¯ä»¥äº¤ä»˜è¯„ä¼°**

---

## é™„å½•ï¼šæµ‹è¯•æ‰§è¡Œå‘½ä»¤

### A.1 è¿è¡Œå›å½’æµ‹è¯•

```powershell
# Windows PowerShell
python -m pytest tests/test_backtest_regression.py -v

# Linux/macOS Bash
python -m pytest tests/test_backtest_regression.py -v
```

### A.2 è¿è¡Œå†’çƒŸæµ‹è¯•

```powershell
# Windows PowerShell
python scripts/test_backtest_smoke.py

# Linux/macOS Bash
python scripts/test_backtest_smoke.py
```

### A.3 è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶

```powershell
# Windows PowerShell
python -m pytest tests/ -v

# Linux/macOS Bash
python -m pytest tests/ -v
```

