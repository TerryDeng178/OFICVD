# TASK-07A LIVE模式60分钟测试启动报告

> **启动时间**: 2025-11-08  
> **测试模式**: LIVE模式（V13_REPLAY_MODE=0）  
> **Sink模式**: dual（JSONL + SQLite）  
> **运行时长**: 60分钟

---

## 1. 测试配置

### 1.1 环境变量

- `V13_REPLAY_MODE=0`（LIVE模式）
- `V13_SINK=dual`（双Sink模式）
- `REPORT_TZ=Asia/Tokyo`（报表时区）
- `TIMESERIES_TYPE=prometheus`（时序库类型）
- `TIMESERIES_URL=http://localhost:9091`（时序库地址，如果未设置）
- `RUN_ID=task07a_live_YYYYMMDD_HHMMSS`（自动生成）

### 1.2 执行命令

```bash
python -m orchestrator.run \
  --config ./config/defaults.yaml \
  --enable harvest,signal,broker,report \
  --sink dual \
  --minutes 60
```

---

## 2. 测试脚本

已创建专用测试脚本：
- `scripts/run_task07a_live_60min.py`：完整的60分钟测试脚本
  - 自动设置环境变量
  - 时序库可达性预检（可选）
  - 运行60分钟测试
  - 验证证据包完整性
  - 运行双Sink等价性测试

已创建监控脚本：
- `scripts/monitor_task07a_live.py`：监控测试进度
  - 显示运行信息
  - 显示进程状态
  - 显示报告统计
  - 检查TASK-07A必须项

---

## 3. 测试执行

### 3.1 启动方式

测试已在后台启动，可以通过以下方式监控：

```bash
# 监控测试进度
python scripts/monitor_task07a_live.py

# 或指定RUN_ID
python scripts/monitor_task07a_live.py task07a_live_YYYYMMDD_HHMMSS
```

### 3.2 预期产出物

测试完成后，应生成以下文件：

1. **run_manifest.json**
   - 位置: `deploy/artifacts/ofi_cvd/run_logs/run_manifest_*.json`
   - 包含: 运行统计、进程状态、时序库导出统计、告警记录、资源使用、关闭顺序、Harvester SLO指标

2. **source_manifest.json**
   - 位置: `deploy/artifacts/ofi_cvd/source_manifest_*.json`
   - 包含: symbol列表、会话时间、WS端点、配置快照

3. **parity_diff.json**
   - 位置: `deploy/artifacts/ofi_cvd/parity_diff_*.json`
   - 包含: 双Sink等价性分析结果

4. **日报文件**
   - JSON: `logs/report/summary_*.json`
   - Markdown: `logs/report/summary_*.md`

5. **日志文件**
   - `logs/orchestrator/orchestrator.log`
   - `logs/orchestrator/*_stdout.log`
   - `logs/orchestrator/*_stderr.log`

---

## 4. 验证清单

测试完成后，需要验证以下项目：

### 4.1 核心功能 ✅

- [ ] 运行时长 ≥ 60分钟
- [ ] 所有进程健康状态为 `healthy`
- [ ] 信号产出正常（预期 ~9,000-10,000 信号/分钟）

### 4.2 TASK-07A必须项

- [ ] **时序库导出统计**: `timeseries_export.export_count ≥ 60`, `error_count = 0`
- [ ] **告警记录**: `alerts` 字段存在且包含触发/恢复时间
- [ ] **Harvester SLO指标**: `queue_dropped=0`, `reconnect_count≤3`, `substream_timeout_detected=false`
- [ ] **资源使用**: `max_rss_mb < 600`, `max_open_files < 256`
- [ ] **关闭顺序**: `shutdown_order` 字段存在且顺序正确
- [ ] **source_manifest.json**: 已生成且包含所有必需字段

### 4.3 双Sink等价性

- [ ] 使用 `--sink dual` 运行
- [ ] 生成 `parity_diff.json`
- [ ] 差异 < 0.5%（total/confirm/strong_ratio）
- [ ] 生成两份日报（JSONL + SQLite）

---

## 5. 监控建议

### 5.1 实时监控

在测试运行期间，可以：

1. **查看orchestrator日志**:
   ```bash
   tail -f logs/orchestrator/orchestrator.log
   ```

2. **监控进程状态**:
   ```bash
   python scripts/monitor_task07a_live.py
   ```

3. **检查资源使用**:
   - 使用系统监控工具（如 `htop`、`top`）
   - 检查RSS内存使用（应 < 600MB）
   - 检查文件描述符数（应 < 256）

### 5.2 时序库监控（如果可用）

如果时序库（Prometheus/InfluxDB）可用，可以：

1. **查看时序数据**:
   - Prometheus: 访问 `http://localhost:9090`（如果Prometheus已启动）
   - InfluxDB: 使用InfluxDB客户端查询数据

2. **验证导出频率**:
   - 每分钟至少1次导出
   - 无错误日志

---

## 6. 故障处理

### 6.1 如果测试提前退出

1. 检查 `logs/orchestrator/orchestrator.log` 中的错误信息
2. 检查进程状态（是否有进程崩溃）
3. 检查资源限制（内存、文件描述符）

### 6.2 如果时序库连接失败

- 代码已处理：会记录警告但不中断运行
- 检查 `run_manifest.timeseries_export.error_count`
- 如果 `error_count > 0`，检查时序库连接配置

### 6.3 如果双Sink等价性测试失败

1. 检查 `parity_diff.json` 中的差异详情
2. 验证 `run_id` 是否正确匹配
3. 检查JSONL和SQLite数据的时间范围是否一致

---

## 7. 测试完成后

### 7.1 验证证据包

运行验证脚本：

```bash
python scripts/monitor_task07a_live.py <RUN_ID>
```

### 7.2 生成测试报告

根据验证结果，生成详细的测试报告，包括：

1. 运行统计（信号数、强信号占比等）
2. TASK-07A必须项验证结果
3. 双Sink等价性验证结果
4. 时序库导出验证结果
5. 资源使用情况
6. 告警记录情况

---

**报告生成时间**: 2025-11-08  
**测试状态**: ⏳ **运行中**  
**预计完成时间**: 60分钟后

