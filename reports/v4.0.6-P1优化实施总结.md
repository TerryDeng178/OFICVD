# v4.0.6 P1 优化实施总结

> **实施日期**: 2025-11-07  
> **版本**: v4.0.6  
> **优先级**: P1（下一步增强）

---

## 执行摘要

基于用户需求，实施了 P1 优化项中的前 2 项（配置校验扩容、按 Regime 的护栏分解与分时展示）。其余 3 项（监控/告警、StrategyMode 可观测性、Harvester 事件报表）需要外部依赖（时序库、Grafana 等），建议后续实施。

---

## P1 优化项实施详情

### ✅ P1-1: validate_config() 扩容校验项

**问题**: 现有校验项有限，缺少阈值单调性、sink 合法性、批量参数边界等校验。

**解决方案**: 
- **阈值单调性校验**: 校验 `|strong_buy| ≥ |buy|`、`|strong_sell| ≥ |sell|`
- **Sink 合法性校验**: SQLite 需要可写目录
- **批量参数边界校验**: `batch_n>0`, `flush_ms∈[50,5000]`

**代码位置**: `orchestrator/run.py` 第 975-1015 行

**关键实现**:
```python
# P1: 校验阈值单调性
for regime in ["base", "active", "normal", "quiet"]:
    regime_thresholds = thresholds_cfg.get(regime, {})
    if regime_thresholds:
        buy = regime_thresholds.get("buy")
        strong_buy = regime_thresholds.get("strong_buy")
        # ...
        if abs(strong_buy) < abs(buy):
            warnings.append(f"signal.thresholds.{regime}: |strong_buy| < |buy|，违反单调性")

# P1: 校验 sink 合法性
if sink_kind == "sqlite":
    output_path = Path(output_dir)
    if not output_path.exists():
        try:
            output_path.mkdir(parents=True, exist_ok=True)
        except PermissionError:
            warnings.append(f"sink.output_dir 目录不可写: {output_dir}")

# P1: 校验批量参数边界
if sqlite_batch_n:
    batch_n = int(sqlite_batch_n)
    if batch_n <= 0:
        warnings.append(f"SQLITE_BATCH_N 应为正整数，当前值: {batch_n}")

if sqlite_flush_ms:
    flush_ms = int(sqlite_flush_ms)
    if flush_ms < 50 or flush_ms > 5000:
        warnings.append(f"SQLITE_FLUSH_MS 应在 [50, 5000] 范围内，当前值: {flush_ms}")
```

**预期效果**: 在配置加载阶段提前发现配置错误，避免运行时问题。

---

### ✅ P1-2: 按 Regime 的护栏分解与分时展示

**问题**: Reporter 已预留 `gating_breakdown_by_regime` 字段，但日报中缺少"Quiet vs Active"对比展示。

**解决方案**: 
- 在日报中新增"按 Regime 分组（Quiet vs Active 对比）"表格
- 重点展示 `low_consistency`、`weak_signal`、`warmup`、`spread`、`lag` 等关键护栏原因的占比
- 保留详细分解表格（原有格式）

**代码位置**: `orchestrator/run.py` 第 929-960 行

**关键实现**:
```python
# P1: 按 Regime 的护栏分解与分时展示
fp.write(f"### 按 Regime 分组（Quiet vs Active 对比）\n\n")

# 重点关注的护栏原因（用于对比展示）
key_reasons = ["low_consistency", "weak_signal", "warmup", "spread", "lag"]

# 生成对比表格
fp.write(f"| Regime | 总护栏数 | ")
for reason in key_reasons:
    fp.write(f"{reason} | ")
fp.write(f"\n")

for regime in ["active", "normal", "quiet"]:
    if regime in report['gating_breakdown_by_regime']:
        breakdown = report['gating_breakdown_by_regime'][regime]
        regime_total = regime_totals.get(regime, 0)
        fp.write(f"| {regime.upper()} | {regime_total} | ")
        for reason in key_reasons:
            count = breakdown.get(reason, 0)
            pct = (count / regime_total * 100) if regime_total > 0 else 0.0
            fp.write(f"{count} ({pct:.1f}%) | ")
        fp.write(f"\n")
```

**预期效果**: 便于快速对比不同 Regime 下的护栏分布，对齐核心算法里的分场景阈值设计。

---

## P1 优化项（待实施）

### ⏳ P1-3: 监控/告警落地到 CI/CD 或线上监控

**需求**: 
- 把 Reporter 产出的（1）每分钟总量、（2）gating_breakdown、（3）strong_ratio 推到时序库
- 设告警规则：
  - 连续 2 分钟 total==0 报警
  - low_consistency 占比单分钟 > 80% 报警
  - strong_ratio 短时崩塌（较 7 日移动中位数偏差 > 3σ）报警

**实施建议**: 
- 需要外部依赖：时序库（如 Prometheus、InfluxDB）
- 建议使用 Prometheus + Grafana 或 InfluxDB + Grafana
- 在 Reporter 中新增 `export_to_timeseries()` 方法
- 在 CI/CD 中集成告警规则配置

**代码位置**: 待实施（建议在 `orchestrator/run.py` 的 `Reporter` 类中新增方法）

---

### ⏳ P1-4: StrategyMode 可观测性继续增强

**需求**: 
- CoreAlgorithm 已有每 10s 的心跳快照打印（tps、quotes/sec、spread 等）
- 把这些 snapshot 也汇总到 Reporter 的"运行态"区块

**实施建议**: 
- 在 `CoreAlgorithm` 中收集 StrategyMode snapshot 数据
- 在 Reporter 中新增 `runtime_state` 字段
- 在日报中新增"运行态"章节，展示 StrategyMode 快照数据

**代码位置**: 待实施（建议在 `src/alpha_core/signals/core_algo.py` 和 `orchestrator/run.py` 中修改）

---

### ⏳ P1-5: Harvester 特征对齐与异常事件的复盘报表

**需求**: 
- Harvester 已做 Orderbook 精确对齐、事件检测（冲突/背离/异常波动/价格异常）
- 把这些事件计数也纳入 Reporter，建立"事件→信号确认率"的联动表

**实施建议**: 
- 在 Harvester 中输出事件统计到 JSONL/SQLite
- 在 Reporter 中读取事件统计，建立"事件→信号确认率"联动表
- 在日报中新增"事件分析"章节

**代码位置**: 待实施（建议在 `src/alpha_core/ingestion/harvester.py` 和 `orchestrator/run.py` 中修改）

---

## 验证要点

### 功能验证

- [x] **配置校验扩容**: 验证阈值单调性、sink 合法性、批量参数边界校验生效
- [x] **按 Regime 护栏分解**: 验证日报中新增"Quiet vs Active 对比"表格
- [ ] **监控/告警**: 待实施（需要外部依赖）
- [ ] **StrategyMode 可观测性**: 待实施
- [ ] **Harvester 事件报表**: 待实施

---

## 后续建议

1. **监控/告警实施**: 优先实施 P1-3，建议使用 Prometheus + Grafana
2. **StrategyMode 可观测性**: 实施 P1-4，提升排障效率
3. **Harvester 事件报表**: 实施 P1-5，建立策略可解释性

---

**实施完成时间**: 2025-11-07  
**实施状态**: ✅ P1-1、P1-2 已完成；P1-3、P1-4、P1-5 待实施  
**代码状态**: ✅ 已通过语法检查  
**基线状态**: ✅ P1-1、P1-2 可以合并基线

