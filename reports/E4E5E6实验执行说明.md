# E4/E5/E6实验执行说明

## 实验目标

### E4组：E1入口节流 + E2 Maker策略合并
- **目标**：降频+降成本
- **验收标准**：
  - `trades_per_hour ≤ 25`（中位数）
  - `cost_bps ≤ 1.85`（中位数）
  - `maker_ratio_actual`显著提升

### E5组：TP/SL + 死区回调
- **目标**：抬单笔收益
- **验收标准**：
  - `avg_pnl_per_trade ≥ 0`（P25分位）
  - `win_rate ≥ 30%`

### E6组：极限降频闸
- **目标**：直插≤20/h
- **验收标准**：
  - `trades_per_hour ≤ 20`（中位数）
  - `win_rate ≥ 25%`

---

## 配置文件

- `runtime/optimizer/group_e4_combined.yaml` - E4组配置
- `runtime/optimizer/group_e5_optimized_tp_sl.yaml` - E5组配置
- `runtime/optimizer/group_e6_ultra_low_tps.yaml` - E6组配置

---

## 执行命令

### 运行实验

```powershell
$env:PYTHONUTF8=1
python scripts/run_e_experiments.py `
  --input deploy/data/ofi_cvd `
  --date 2025-11-09 `
  --symbols BTCUSDT,ETHUSDT,BNBUSDT `
  --minutes 60 `
  --groups E4,E5,E6
```

### 检查运行状态

```powershell
python scripts/check_e_experiments_status.py
```

### 验收实验

```powershell
python scripts/validate_e456_experiments.py
```

---

## 关键参数对比

| 参数 | D组 | E1 | E2 | E4 | E5 | E6 |
|------|-----|----|----|----|----|----|
| `weak_signal_threshold` | 0.70 | 0.78 | 0.70 | **0.78** | 0.70 | **0.80** |
| `consistency_min` | 0.40 | 0.48 | 0.40 | **0.48** | 0.40 | **0.50** |
| `dedupe_ms` | 4000 | 6000 | 4000 | **6000** | 4000 | **8000** |
| `min_consecutive` | 3 | 3 | 3 | 3 | 3 | **4** |
| `maker_fee_ratio` | 0.4 | 0.4 | 0.35 | **0.35** | 0.4 | 0.4 |
| `scenario_probs.Q_L` | 0.85 | 0.85 | 0.90 | **0.90** | 0.85 | 0.85 |
| `scenario_probs.A_L` | 0.75 | 0.75 | 0.80 | **0.80** | 0.75 | 0.75 |
| `take_profit_bps` | 12 | 12 | 12 | 12 | **15** | 12 |
| `stop_loss_bps` | 10 | 10 | 10 | 10 | **8** | 10 |
| `deadband_bps` | 0 | 0 | 0 | 0 | **1.5** | 0 |

---

## 本轮"通过"标准（四条）

1. **频率**：≤ 20/h（中位数；若E6通过，E4/E5以此为硬约束）
2. **成本**：`cost_bps ≤ 1.75` 且 `maker_ratio_actual`显著提升
3. **单笔收益**：`avg_pnl_per_trade ≥ 0`（P25）
4. **稳健性**：三交易对都不过分掉队（ETH不能明显为负）

---

## 费用路径验证（并行进行）

### Maker实际命中率检查
- 检查E2/E4中实际`maker_ratio_actual`是否上升
- 若没有，增大被动单TTL与允许的排队深度阈值
- 必要时引入二次重挂（`max_pending_orders=2`）与轻度`price_offset_bps`

### 滑点分布对比
- 对比`effective_spread_bps`（含滑点）的P50/P95
- 若Maker提升但成本仍不降，多半是滑点/排队带来的"隐性成本"

---

## 输出文件

- `runtime/optimizer/e_experiments_comparison.json` - 实验对比结果
- `runtime/optimizer/e456_experiments_validation.json` - E4/E5/E6验收结果
- `runtime/optimizer/group_e4_validation/backtest_*/` - E4组结果目录
- `runtime/optimizer/group_e5_validation/backtest_*/` - E5组结果目录
- `runtime/optimizer/group_e6_validation/backtest_*/` - E6组结果目录

---

## 预期完成时间

每个实验约60分钟（60分钟回测），三个实验可并行运行，总时间约60分钟。

---

## 下一步

1. 等待E4/E5/E6实验完成
2. 运行验收脚本检查结果
3. 根据验收结果决定下一步优化方向
4. 如果Maker比例未提升，进入费用路径验证流程

