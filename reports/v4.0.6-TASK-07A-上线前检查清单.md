# TASK-07A 上线前检查清单

**版本**: v4.0.6  
**状态**: 生产可灰度  
**检查日期**: 2025-11-09

---

## 一、结论确认

### ✅ 可以接受，建议进入"生产可灰度"

**验证结果**:
- ✅ 双Sink一致性：差异0.0333%，远小于0.25%阈值
- ✅ P0修复：100%完成并验证通过
- ✅ 健康检查：所有进程healthy
- ✅ 数据一致性：确认量/强信号占比匹配良好

**待完成事项**:
- ⏳ 时序库导出验证（P0.5）
- ⏳ 60分钟Soak Test（P0.5）

---

## 二、P0.5 上线前"最后一跳"

### 2.1 时序库导出打通验证

#### 测试目标
- 验证时序库导出功能正常工作
- 确认`export_count`和`error_count`统计正确
- 验证导出数据格式正确

#### 测试步骤

**步骤1: 配置环境变量**
```powershell
# Prometheus Pushgateway
$env:TIMESERIES_ENABLED = "1"
$env:TIMESERIES_TYPE = "prometheus"
$env:TIMESERIES_URL = "http://localhost:9091"

# 或 InfluxDB v2
$env:TIMESERIES_ENABLED = "1"
$env:TIMESERIES_TYPE = "influxdb"
$env:INFLUX_URL = "http://localhost:8086"
$env:INFLUX_ORG = "myorg"
$env:INFLUX_BUCKET = "mybucket"
$env:INFLUX_TOKEN = "your-token"
```

**步骤2: 运行10分钟测试**
```powershell
$env:V13_REPLAY_MODE = "0"
$env:V13_INPUT_MODE = "preview"
$env:V13_SINK = "dual"
$env:RUN_ID = "timeseries_export_$(Get-Date -Format 'yyyyMMdd_HHmmss')"

python -m orchestrator.run `
  --config ./config/defaults.yaml `
  --enable harvest,signal,broker,report `
  --sink dual `
  --minutes 10
```

**步骤3: 验证结果**
- ✅ `timeseries_export.export_count` > 0
- ✅ `timeseries_export.error_count` = 0
- ✅ `timeseries_data.total` > 0
- ✅ 时序库侧能看到数据曲线

#### 验收标准
- [ ] `export_count` ≥ 确认信号量
- [ ] `error_count` = 0
- [ ] `timeseries_data`字段完整（total、gating_breakdown、strong_ratio、per_minute）
- [ ] 时序库侧数据可见

---

### 2.2 60分钟Soak Test

#### 测试目标
- 验证长时间运行稳定性
- 验证数据一致性（parity差异）
- 验证SQLite WAL管理
- 验证吞吐和丢包情况

#### 测试步骤

**步骤1: 运行60分钟测试**
```powershell
$env:V13_REPLAY_MODE = "0"
$env:V13_INPUT_MODE = "preview"
$env:V13_SINK = "dual"
$env:RUN_ID = "soak_test_60min_$(Get-Date -Format 'yyyyMMdd_HHmmss')"

python -m orchestrator.run `
  --config ./config/defaults.yaml `
  --enable harvest,signal,broker,report `
  --sink dual `
  --minutes 60
```

**步骤2: 监控指标**
- SQLite WAL文件大小（`signals.db-wal`）
- WAL checkpoint日志（关闭时触发）
- 数据一致性差异（parity check）
- 吞吐量（rows/sec）
- 丢包数（dropped）

**步骤3: 验证结果**
```powershell
# 数据一致性验证
python scripts/verify_sink_parity.py --run-id <RUN_ID>

# 检查WAL文件大小
Get-ChildItem runtime\signals.db-wal | Select-Object Name, Length

# 检查关闭日志
Get-Content logs\signal\signal_stderr.log | Select-String -Pattern "关闭|checkpoint|WAL"
```

#### 验收标准
- [ ] JSONL vs SQLite差异 < 0.25%（当前0.0333%）
- [ ] SQLite WAL不无限增大
- [ ] WAL checkpoint在关闭时触发（日志确认）
- [ ] 无丢包（dropped = 0）
- [ ] 吞吐稳定（rows/sec波动<20%）

---

### 2.3 参数快照

#### 目标
保存环境变量快照，与`run_manifest`和`source_manifest`一起归档，便于完全复现。

#### 执行步骤

**步骤1: 收集环境变量**
```powershell
# 创建环境变量快照脚本
$env_snapshot = @{
    "V13_REPLAY_MODE" = $env:V13_REPLAY_MODE
    "V13_INPUT_MODE" = $env:V13_INPUT_MODE
    "V13_SINK" = $env:V13_SINK
    "SQLITE_BATCH_N" = $env:SQLITE_BATCH_N
    "SQLITE_FLUSH_MS" = $env:SQLITE_FLUSH_MS
    "FSYNC_EVERY_N" = $env:FSYNC_EVERY_N
    "TIMESERIES_ENABLED" = $env:TIMESERIES_ENABLED
    "TIMESERIES_TYPE" = $env:TIMESERIES_TYPE
    "TIMESERIES_URL" = $env:TIMESERIES_URL
    "INFLUX_URL" = $env:INFLUX_URL
    "INFLUX_ORG" = $env:INFLUX_ORG
    "INFLUX_BUCKET" = $env:INFLUX_BUCKET
    "RUN_ID" = $env:RUN_ID
}

$env_snapshot | ConvertTo-Json | Out-File -FilePath "deploy/artifacts/ofi_cvd/env_snapshot_$(Get-Date -Format 'yyyyMMdd_HHmmss').json" -Encoding UTF8
```

**步骤2: 归档清单**
- `run_manifest_<RUN_ID>.json`
- `source_manifest_<RUN_ID>.json`
- `env_snapshot_<timestamp>.json`
- `summary_<timestamp>.json`
- `parity_diff_<RUN_ID>.json`（如有）

---

## 三、关键验证点（已确认）

### ✅ SQLite表结构与幂等性
- PRIMARY KEY (run_id, ts_ms, symbol)
- 列完整：signal_type、guard_reason、created_at、run_id
- 迁移逻辑完善（旧表→新表数据搬迁）

### ✅ 批量写入与超时
- WAL模式、busy_timeout、temp_store=MEMORY、cache_size优化
- SQLITE_BATCH_N/SQLITE_FLUSH_MS环境变量支持
- **待补充**: 启动时打印最终生效值

### ✅ 双Sink构造与关闭
- build_sink('dual')同时写JSONL/SQLite
- MultiSink独立emit/close，避免相互影响

### ✅ RUN_ID贯穿
- JSONL与SQLite都写入run_id
- 支持按run_id对账

### ✅ 日报/健康检查
- 时序库导出计数、错误数统计
- 启动时连接预检（告警但不阻断）

---

## 四、P1改进清单（下个小版本）

### 4.1 可观测性完善

#### 队列水位/丢弃计数可视化
- **目标**: 统一Prometheus指标（queue_size/dropped/fsync_count/batch_flush_count）
- **位置**: Reporter的`per_minute`指标
- **实现**: 从SQLite Sink/Jsonl Sink获取队列和drop计数，纳入日报展示

#### 护栏原因分解
- **目标**: 接入看板页或时序库，做阈值告警
- **位置**: 日报已有`gating_breakdown`和按regime/分钟分组
- **实现**: 将`low_consistency/weak_signal`等接入时序库，设置告警阈值

---

### 4.2 参数提示与预检

#### 启动期打印所有关键env
- **目标**: 打印V13_SINK/SQLITE_BATCH_N/SQLITE_FLUSH_MS/FSYNC_EVERY_N/TIMESERIES_*
- **位置**: SqliteSink已打印，需补充JsonlSink
- **实现**: JsonlSink同步打印fsync策略

#### timeseries预检增强
- **目标**: 失败时添加重试/降级提示文案，写入日报warnings
- **位置**: Reporter._check_timeseries_health()
- **实现**: 连接失败时记录详细诊断信息到warnings

---

### 4.3 Windows/macOS兼容性"再保险"

#### SQLite
- ✅ WAL、busy_timeout、批量提交已启用（Windows友好）
- **保持现状**

#### JSONL
- **目标**: 后台线程实现、原子换名、fsync
- **实现**: 
  - V13_JSONL_OPEN_ATTEMPTS/V13_JSONL_OPEN_BASESLEEP在Windows下默认更保守
  - rotate阶段做原子换名和fsync

---

## 五、风险与关注点

### 5.1 数据源真实LIVE覆盖
- **当前**: preview历史数据（功能验证可接受）
- **建议**: 正式交易前接Binance Futures WS做一次端到端测试

### 5.2 跨版本表迁移
- **当前**: 已有完善的迁移脚本与OR IGNORE保护
- **建议**: 生产库首次启用前做一次全量备份

---

## 六、执行记录

### 6.1 时序库导出验证
- [ ] 测试时间: ___________
- [ ] RUN_ID: ___________
- [ ] 结果: ___________
- [ ] 备注: ___________

### 6.2 60分钟Soak Test
- [ ] 测试时间: ___________
- [ ] RUN_ID: ___________
- [ ] 结果: ___________
- [ ] 备注: ___________

### 6.3 参数快照
- [ ] 快照时间: ___________
- [ ] 文件路径: ___________
- [ ] 备注: ___________

---

**检查清单版本**: v1.0  
**创建时间**: 2025-11-09  
**审核状态**: 待审核

