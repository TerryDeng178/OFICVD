name: equivalence-ci

on:
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'src/**'
      - 'mcp/**'
      - 'tests/**'
      - 'requirements*.txt'
      - 'pyproject.toml'
  workflow_dispatch:

jobs:
  equivalence:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]
        py: ['3.11', '3.12']
    concurrency:
      group: ${{ github.workflow }}-${{ github.ref }}
      cancel-in-progress: true

    steps:
      - uses: actions/checkout@v4

      # 跳过机制加锁：需要 CODEOWNERS 审批
      - name: Check skip-equivalence permission
        if: contains(join(fromJson(toJson(github.event.pull_request.labels)).*.name, ','), 'skip-equivalence')
        run: |
          # CODEOWNERS 列表（根据实际情况调整）
          ALLOWED_USERS="terrydeng178,repo-owner"
          if [[ ! $ALLOWED_USERS =~ (^|,)$GITHUB_ACTOR($|,) ]]; then
            echo "❌ equiv-skip 需要 CODEOWNERS 审批"
            echo "允许用户: $ALLOWED_USERS"
            echo "当前用户: $GITHUB_ACTOR"
            exit 1
          else
            echo "✅ CODEOWNERS 已审批跳过等价性测试"
          fi
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.py }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]" -c constraints.txt

      # 轻量级等价性用例（样例夹具、无外部服务）
      - name: Run equivalence tests (light)
        run: |
          mkdir -p reports
          python -m pytest -m "equivalence and not slow" \
            --maxfail=1 --disable-warnings \
            --junitxml=reports/junit.xml \
            -v  # CI中保持详细输出便于调试
        env:
          V13_REPLAY_MODE: "1"   # 回放一致性
          CI_MODE: "light"       # 测试用小样例/快速路径

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: equivalence-reports
          path: |
            reports/
            runtime/equiv_test/equiv_diff_*.json

