name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  sink-parity:
    name: 双 Sink 结果对齐回归
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]
        python-version: ['3.11']
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e .
    
    - name: 双 Sink 结果对齐回归测试
      shell: bash
      env:
        V13_REPLAY_MODE: 1
        V13_INPUT_MODE: preview
        REPORT_TZ: Asia/Tokyo
      run: |
        if [ "${{ runner.os }}" == "Windows" ]; then
          powershell -File ./scripts/verify_sink_parity.ps1 -Config ./config/defaults.replay.yaml -Minutes 2
        else
          chmod +x ./scripts/verify_sink_parity.sh
          ./scripts/verify_sink_parity.sh ./config/defaults.replay.yaml 2
        fi
    
    - name: P0: DoD 固化为 CI 断言
      shell: bash
      run: |
        # 检查报表是否生成
        REPORT_FILE=$(find logs/report -name "summary_*.json" -type f | head -1)
        if [ -z "$REPORT_FILE" ]; then
          echo "报表未生成"
          exit 1
        fi
        
        # 检查 warnings 不包含 NO_INPUT_FILES/QUIET_RUN/ALL_GATED
        WARNINGS=$(python3 -c "import json, sys; data=json.load(open('$REPORT_FILE')); print(' '.join(data.get('warnings', [])))")
        if echo "$WARNINGS" | grep -qE "(NO_INPUT_FILES|QUIET_RUN|ALL_GATED)"; then
          echo "报表包含不允许的警告: $WARNINGS"
          exit 1
        fi
        
        # 检查 run_manifest 是否生成且 source_versions 字段完整
        MANIFEST_FILE=$(find deploy/artifacts/ofi_cvd/run_logs -name "run_manifest_*.json" -type f | head -1)
        if [ -z "$MANIFEST_FILE" ]; then
          echo "运行清单未生成"
          exit 1
        fi
        
        python3 <<EOF
        import json, sys
        with open("$MANIFEST_FILE", "r") as f:
          manifest = json.load(f)
        source_versions = manifest.get("source_versions", {})
        required_fields = ["git_head", "python_version"]
        for field in required_fields:
          if field not in source_versions:
            print(f"source_versions 缺少必需字段: {field}")
            sys.exit(1)
        print("DoD 断言通过")
        EOF
    
    - name: 上传运行清单（发布证据）
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: run-manifests-${{ matrix.os }}-${{ github.run_number }}
        path: |
          deploy/artifacts/ofi_cvd/run_logs/*.json
          logs/report/*.json
          logs/report/*.md
          logs/report/parity_diff_*.json
        retention-days: 30

  backtest-test:
    name: 回测 Harness 测试（跨平台）
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]
        python-version: ['3.11']
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e .
    
    - name: 生成测试数据（features）
      run: |
        python scripts/generate_test_features.py --output deploy/data/ofi_cvd/ready/features/BTCUSDT --count 100
    
    - name: 运行回测冒烟测试
      shell: bash
      run: |
        if [ "${{ runner.os }}" == "Windows" ]; then
          python scripts/test_backtest_smoke.py
        else
          python scripts/test_backtest_smoke.py
        fi
    
    - name: 运行回测集成测试
      shell: bash
      run: |
        python scripts/test_backtest_integration.py
    
    - name: 检查回测输出
      shell: bash
      run: |
        # 检查输出文件是否存在
        if [ ! -d "runtime/backtest" ]; then
          echo "回测输出目录不存在"
          exit 1
        fi
        
        # 检查metrics.json是否存在
        METRICS_FILE=$(find runtime/backtest -name "metrics.json" -type f | head -1)
        if [ -z "$METRICS_FILE" ]; then
          echo "metrics.json未生成"
          exit 1
        fi
        
        # 检查run_manifest.json是否存在
        MANIFEST_FILE=$(find runtime/backtest -name "run_manifest.json" -type f | head -1)
        if [ -z "$MANIFEST_FILE" ]; then
          echo "run_manifest.json未生成"
          exit 1
        fi
        
        # P1.7: 保存metrics用于跨平台比较
        mkdir -p ci_artifacts
        cp "$METRICS_FILE" "ci_artifacts/metrics_${{ matrix.os }}.json"
        cp "$MANIFEST_FILE" "ci_artifacts/manifest_${{ matrix.os }}.json"
    
    - name: P1.7: 跨平台metrics差异比较
      if: matrix.os == 'ubuntu-latest'
      shell: bash
      run: |
        # 下载Windows平台的metrics
        if [ -f "ci_artifacts/metrics_windows-latest.json" ] && [ -f "ci_artifacts/metrics_ubuntu-latest.json" ]; then
          python scripts/compare_cross_platform_metrics.py \
            --windows-metrics ci_artifacts/metrics_windows-latest.json \
            --unix-metrics ci_artifacts/metrics_ubuntu-latest.json \
            --threshold 0.05
        else
          echo "Warning: Cross-platform metrics comparison skipped (files not found)"
        fi
    
    - name: 上传回测输出（发布证据）
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: backtest-output-${{ matrix.os }}-${{ github.run_number }}
        path: |
          runtime/backtest/**/*.json
          runtime/backtest/**/*.jsonl
        retention-days: 30

  smoke-test:
    name: SMOKE 快速回归
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e .
    
    - name: SMOKE 测试（JSONL）
      env:
        V13_INPUT_MODE: preview
        REPORT_TZ: Asia/Tokyo
      run: |
        python -m orchestrator.run \
          --config ./config/defaults.smoke.yaml \
          --enable signal,report \
          --sink jsonl \
          --minutes 1 \
          --debug
    
    - name: 检查报表生成
      run: |
        if [ ! -f logs/report/summary_*.json ]; then
          echo "报表未生成"
          exit 1
        fi
    
    - name: 上传运行清单（发布证据）
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: smoke-test-manifests-${{ github.run_number }}
        path: |
          deploy/artifacts/ofi_cvd/run_logs/*.json
          logs/report/*.json
          logs/report/*.md
          logs/report/parity_diff_*.json
        retention-days: 30

