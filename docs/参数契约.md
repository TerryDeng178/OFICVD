# 回放＋回测 Harness 参数契约

> **版本**: v4.0.6  
> **更新日期**: 2025-11-09  
> **目的**: 统一CLI/配置→组件参数映射表，确保全局一致性

---

## 一、参数映射总览

### 1.1 CLI参数 → 组件参数映射

| CLI参数 | 组件 | 配置键 | 默认值 | 说明 |
|---------|------|--------|--------|------|
| `--input` | Reader | `input_dir` | - | 输入数据目录 |
| `--date` | Reader | `date` | `None` | 日期过滤（YYYY-MM-DD） |
| `--symbols` | Reader | `symbols` | `None` | 交易对列表（逗号分隔） |
| `--kinds` | Reader | `kinds` | - | 数据类型（features/prices/orderbook） |
| `--start-ms` | Reader | `start_ms` | `None` | 开始时间戳（Unix ms） |
| `--end-ms` | Reader | `end_ms` | `None` | 结束时间戳（Unix ms） |
| `--minutes` | Reader | `minutes` | `None` | 处理分钟数 |
| `--session` | Reader | `session` | `None` | 会话过滤（NY/AS/EU） |
| `--include-preview` | Reader | `include_preview` | `False` | 是否扫描preview目录 |
| `--source-priority` | Reader | `source_priority` | `["ready"]` | 数据源优先级 |
| `--config` | All | `config_path` | `./config/backtest.yaml` | 配置文件路径 |
| `--output` | All | `output_dir` | `./runtime/backtest` | 输出目录 |
| `--sink` | Feeder | `sink_kind` | `jsonl` | 信号Sink类型（jsonl/sqlite/null） |
| `--taker-fee-bps` | TradeSim | `taker_fee_bps` | `2.0` | 交易手续费（基点） |
| `--slippage-bps` | TradeSim | `slippage_bps` | `1.0` | 滑点（基点） |
| `--ignore-gating` | TradeSim | `ignore_gating_in_backtest` | `False` | 忽略gating（纯策略评估） |

---

## 二、组件参数详细说明

### 2.1 Reader参数

**类**: `DataReader`  
**文件**: `src/alpha_core/backtest/reader.py`

| 参数 | 类型 | 默认值 | 取值范围 | 影响面 | 说明 |
|------|------|--------|----------|--------|------|
| `input_dir` | `Path` | - | - | Reader | 输入数据根目录 |
| `date` | `Optional[str]` | `None` | YYYY-MM-DD | Reader | 日期过滤，用于对齐验证 |
| `symbols` | `Optional[List[str]]` | `None` | 交易对列表 | Reader | 交易对过滤 |
| `kinds` | `Optional[List[str]]` | `None` | features/prices/orderbook | Reader | 数据类型过滤 |
| `start_ms` | `Optional[int]` | `None` | Unix时间戳（ms） | Reader | 开始时间过滤 |
| `end_ms` | `Optional[int]` | `None` | Unix时间戳（ms） | Reader | 结束时间过滤 |
| `minutes` | `Optional[int]` | `None` | > 0 | Reader | 处理分钟数（行级过滤） |
| `session` | `Optional[str]` | `None` | NY/AS/EU | Reader | 会话过滤 |
| `include_preview` | `bool` | `False` | True/False | Reader | 是否扫描preview目录（P0修复） |
| `source_priority` | `Optional[List[str]]` | `["ready"]` | ["ready", "preview"] | Reader | 数据源优先级（P0修复） |

**使用建议**:
- 用于对齐验证时，必须指定 `--date` 或 `--start-ms/--end-ms`
- 默认不扫preview，避免时间窗错位
- `minutes` 仅做行级过滤，文件发现阶段不限制时间段

---

### 2.2 Aligner参数

**类**: `DataAligner`  
**文件**: `src/alpha_core/backtest/aligner.py`

| 参数 | 类型 | 默认值 | 取值范围 | 影响面 | 说明 |
|------|------|--------|----------|--------|------|
| `max_lag_ms` | `int` | `5000` | > 0 | Aligner | 最大对齐延迟（ms） |

**输出特征字段**:
- `return_1s`: 1秒收益率（bps），`(mid[t]-mid[t-1])/mid[t-1]*10000`
- `lag_ms_price`: 价格数据延迟（ms），该秒与上一次观测秒差×1000
- `lag_ms_orderbook`: 订单簿数据延迟（ms），该秒与上一次观测秒差×1000
- `scenario_2x2`: 场景标签（A_H/A_L/Q_H/Q_L），基于活跃度和波动率
- `ofi_z`: OFI Z-score（如果可获取）
- `cvd_z`: CVD Z-score（如果可获取）
- `fusion_score`: 融合分数（如果可获取）

---

### 2.3 Feeder参数

**类**: `ReplayFeeder`  
**文件**: `src/alpha_core/backtest/feeder.py`

| 参数 | 类型 | 默认值 | 取值范围 | 影响面 | 说明 |
|------|------|--------|----------|--------|------|
| `config` | `Optional[Dict]` | `{}` | - | Feeder/Algo | 信号配置 |
| `output_dir` | `Optional[Path]` | `None` | - | Feeder | 信号输出目录 |
| `sink_kind` | `str` | `jsonl` | jsonl/sqlite/null | Feeder | 信号Sink类型 |

**环境变量**:
- `V13_REPLAY_MODE=1`: 自动设置，确保与生产内核一致
- `RUN_ID`: 用于对账和追踪

**配置项**:
- `replay_mode`: 自动设置为1
- `sink.kind`: 从CLI或配置读取

---

### 2.4 TradeSim参数

**类**: `TradeSimulator`  
**文件**: `src/alpha_core/backtest/trade_sim.py`

| 参数 | 类型 | 默认值 | 取值范围 | 影响面 | 说明 |
|------|------|--------|----------|--------|------|
| `config` | `Dict` | - | - | TradeSim | 回测配置（backtest section） |
| `output_dir` | `Path` | - | - | TradeSim | 输出目录 |
| `ignore_gating_in_backtest` | `bool` | `False` | True/False | TradeSim | 忽略gating（P0修复） |

**配置键（backtest section）**:

| 配置键 | 类型 | 默认值 | 取值范围 | 说明 |
|--------|------|--------|----------|------|
| `taker_fee_bps` | `float` | `2.0` | ≥ 0 | 交易手续费（基点） |
| `slippage_bps` | `float` | `1.0` | ≥ 0 | 滑点（基点） |
| `notional_per_trade` | `float` | `1000` | > 0 | 每笔交易名义金额 |
| `reverse_on_signal` | `bool` | `False` | True/False | 是否在反向信号时反转仓位 |
| `take_profit_bps` | `Optional[float]` | `None` | > 0 | 止盈阈值（基点） |
| `stop_loss_bps` | `Optional[float]` | `None` | > 0 | 止损阈值（基点） |
| `min_hold_time_sec` | `Optional[int]` | `None` | > 0 | 最小持仓时间（秒） |

**PnL计算**:
- `gross_pnl`: 毛收益（不考虑费用和滑点）
- `net_pnl`: 净收益 = `gross_pnl - entry_fee - exit_fee`（P0修复：不包含slippage_cost）
- `slippage`: 滑点成本（监控指标，不参与净值计算）

---

### 2.5 Metrics参数

**类**: `MetricsAggregator`  
**文件**: `src/alpha_core/backtest/metrics.py`

| 参数 | 类型 | 默认值 | 取值范围 | 影响面 | 说明 |
|------|------|--------|----------|--------|------|
| `output_dir` | `Path` | - | - | Metrics | 输出目录 |

**计算的指标**:

| 指标 | 类型 | 计算公式 | 年化因子 | 说明 |
|------|------|----------|----------|------|
| `total_pnl` | `float` | 累计净收益 | - | 总净收益（美元） |
| `total_fee` | `float` | 累计费用 | - | 总交易费用（美元） |
| `total_slippage` | `float` | 累计滑点 | - | 总滑点成本（监控指标） |
| `win_rate` | `float` | wins / (wins + losses) | - | 胜率 |
| `risk_reward_ratio` | `float` | avg_win / avg_loss | - | 风险收益比 |
| `sharpe_ratio` | `float` | mean_return / std_return * √252 | √252 | 年化Sharpe比率 |
| `sortino_ratio` | `float` | mean_return / downside_std * √252 | √252 | 年化Sortino比率 |
| `max_drawdown` | `float` | max(peak - pnl) | - | 最大回撤（美元） |
| `MAR` | `float` | annual_return / max_drawdown | 252 | 年化收益/最大回撤（P0修复） |
| `avg_hold_sec` | `float` | 平均持仓时间 | - | 平均持仓时间（秒） |

**年化口径**:
- `pnl_series`时间粒度：日（daily）
- Sharpe/Sortino年化因子：√252（交易日）
- MAR年化因子：252（交易日）

**P0修复**:
- MAR计算：`if dd_max > 0: MAR = annual_return / dd_max`（修正前：`dd_max < 0`）

---

## 三、配置文件结构

### 3.1 backtest.yaml结构

```yaml
signal:
  # Feeder配置
  replay_mode: 1  # 自动设置
  sink:
    kind: jsonl  # jsonl/sqlite/null

components:
  reader:
    include_preview: false  # P0修复：默认不扫preview
    source_priority: ["ready"]
  aligner:
    max_lag_ms: 5000

strategy:
  # 策略参数（与CORE_ALGO对齐）

risk:
  # 风控参数（与CORE_ALGO对齐）

backtest:
  # TradeSim参数
  taker_fee_bps: 2.0
  slippage_bps: 1.0
  notional_per_trade: 1000
  reverse_on_signal: false
  take_profit_bps: null
  stop_loss_bps: null
  min_hold_time_sec: null
  ignore_gating_in_backtest: false  # P0修复：门控绕过
```

---

## 四、参数优先级

### 4.1 优先级顺序（高→低）

1. **CLI参数**（最高优先级）
2. **环境变量**（如果支持）
3. **配置文件**（backtest.yaml）
4. **组件默认值**（最低优先级）

### 4.2 参数覆盖示例

```python
# CLI: --taker-fee-bps 3.0
# Config: taker_fee_bps: 2.0
# Default: 2.0
# 最终值: 3.0 (CLI优先)
```

---

## 五、对齐验证参数要求

### 5.1 必须参数

用于对齐验证时，必须指定以下参数之一：

1. **`--date`**: 日期过滤（推荐）
2. **`--start-ms` + `--end-ms`**: 时间范围过滤
3. **`--start-ms` + `--minutes`**: 时间范围过滤（分钟数）

### 5.2 推荐参数

- `--date`: 确保时间窗对齐
- `--symbols`: 限制交易对范围
- `--include-preview`: 默认False，避免时间窗错位

---

## 六、数据契约

### 6.1 Features Schema

**输入特征字段**（Reader/Aligner输出）:

```python
{
    "second_ts": int,  # 秒级时间戳
    "ts_ms": int,  # 毫秒级时间戳
    "symbol": str,  # 交易对
    "mid": float,  # 中间价
    "best_bid": float,  # 最佳买价
    "best_ask": float,  # 最佳卖价
    "spread_bps": float,  # 价差（基点）
    "scenario_2x2": str,  # 场景标签（A_H/A_L/Q_H/Q_L）
    "return_1s": float,  # 1秒收益率（bps，P0修复）
    "lag_ms_price": int,  # 价格延迟（ms，P0修复）
    "lag_ms_orderbook": int,  # 订单簿延迟（ms，P0修复）
    "ofi_z": float,  # OFI Z-score（如果可获取）
    "cvd_z": float,  # CVD Z-score（如果可获取）
    "fusion_score": float,  # 融合分数（如果可获取）
}
```

### 6.2 Signals Schema

**信号字段**（Feeder/CORE_ALGO输出）:

```python
{
    "ts_ms": int,  # 时间戳（ms）
    "symbol": str,  # 交易对
    "signal_type": str,  # 信号类型（buy/sell/strong_buy/strong_sell/neutral/pending）
    "confirm": bool,  # 是否确认
    "gating": bool,  # 是否被门控
    "run_id": str,  # 运行ID（用于对账）
    "created_at": str,  # 创建时间（ISO格式）
    # ... 其他CORE_ALGO字段
}
```

### 6.3 Trades Schema

**交易记录字段**（TradeSim输出）:

```python
{
    "ts_ms": int,  # 时间戳（ms）
    "symbol": str,  # 交易对
    "side": str,  # 方向（buy/sell）
    "px": float,  # 成交价（已包含滑点）
    "qty": float,  # 数量
    "fee": float,  # 费用（entry或exit）
    "slippage_bps": float,  # 滑点（基点）
    "reason": str,  # 原因（entry/exit/reverse_signal/take_profit/stop_loss/timeout）
    "pos_after": int,  # 持仓后数量（1/-1/0）
    "gross_pnl": float,  # 毛收益（仅exit交易）
    "net_pnl": float,  # 净收益（仅exit交易，P0修复：不包含slippage_cost）
}
```

### 6.4 Metrics Schema

**指标字段**（MetricsAggregator输出）:

```python
{
    "total_trades": int,  # 总交易数
    "total_pnl": float,  # 总净收益（美元）
    "total_fee": float,  # 总费用（美元）
    "total_slippage": float,  # 总滑点（监控指标）
    "total_turnover": float,  # 总成交额（美元）
    "win_rate": float,  # 胜率
    "risk_reward_ratio": float,  # 风险收益比
    "sharpe_ratio": float,  # Sharpe比率（年化）
    "sortino_ratio": float,  # Sortino比率（年化）
    "max_drawdown": float,  # 最大回撤（美元）
    "MAR": float,  # 年化收益/最大回撤（P0修复）
    "avg_hold_sec": float,  # 平均持仓时间（秒）
    "scenario_breakdown": dict,  # 场景切片统计
}
```

---

## 七、环境变量

### 7.1 回测相关环境变量

| 环境变量 | 默认值 | 说明 | 影响组件 |
|----------|--------|------|----------|
| `V13_REPLAY_MODE` | `1` | 回放模式（自动设置） | Feeder/Algo |
| `RUN_ID` | 自动生成 | 运行ID（用于对账） | All |
| `V13_SINK` | `jsonl` | Sink类型 | Feeder |
| `V13_OUTPUT_DIR` | `./runtime` | 输出目录 | Feeder |

---

## 八、使用示例

### 8.1 基本使用

```powershell
# 使用默认配置
python scripts/replay_harness.py `
  --input deploy/data/ofi_cvd `
  --kinds features `
  --minutes 60
```

### 8.2 对齐验证使用

```powershell
# 必须指定时间范围
python scripts/replay_harness.py `
  --input deploy/data/ofi_cvd `
  --kinds features `
  --date 2025-11-08 `
  --symbols BTCUSDT `
  --minutes 60
```

### 8.3 纯策略评估使用

```powershell
# 忽略gating，仅评估策略本体
python scripts/replay_harness.py `
  --input deploy/data/ofi_cvd `
  --kinds features `
  --date 2025-11-08 `
  --ignore-gating `
  --minutes 60
```

---

## 九、参数验证规则

### 9.1 必填参数

- `--input`: 输入目录（必须）
- `--kinds`: 数据类型（必须）

### 9.2 对齐验证必填

- `--date` 或 `--start-ms/--end-ms`: 时间范围（必须）

### 9.3 取值范围验证

- `taker_fee_bps`: ≥ 0
- `slippage_bps`: ≥ 0
- `notional_per_trade`: > 0
- `minutes`: > 0
- `max_lag_ms`: > 0

---

## 十、变更历史

### v4.0.6 (2025-11-09)

**P0修复**:
- ✅ `include_preview`: 默认值改为`False`
- ✅ `ignore_gating_in_backtest`: 新增参数
- ✅ `return_1s`, `lag_ms_*`: 新增特征字段
- ✅ MAR计算：修正公式判定

**P1修复**:
- ✅ 参数契约文档：本文档

---

**文档版本**: v1.0  
**最后更新**: 2025-11-09  
**维护者**: TASK-08团队

