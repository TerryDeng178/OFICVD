# P0 StrategyMode 100% Quiet 修复验证检查清单

## 快速结论（TL;DR）

✅ **修复已落地**：Schedule 默认开启 + 空数组语义修复 + 重复代码清理  
✅ **冒烟测试通过**：Active≈100%（符合 smoke 配置预期）  
✅ **性能可接受**：~837 rows/sec（1.2ms/row），仍在实时系统可接受范围  
⚠️ **生产前需调整**：Active≈100% 仅适用于冒烟，生产环境需切换配置

---

## 一、关键修复验证清单

### 1.1 Schedule 默认开启 + 空窗口=全天有效

**修复位置**: `src/alpha_core/signals/core_algo.py` 第 252 行

**验证方法**:
```python
# 检查默认值
from alpha_core.signals.core_algo import CoreAlgorithm
from alpha_core.risk.strategy_mode import StrategyModeManager

# 测试默认配置
cfg = {}  # 空配置
algo = CoreAlgorithm(config=cfg)
# 检查 _strategy_mode_config 中的 schedule.enabled 应为 True
```

**预期结果**: ✅ `schedule.enabled = True`, `active_windows = []`

**证据**: 报告第 251-252 行展示了修改点与新默认值语义

---

### 1.2 enabled_weekdays: [] 语义改为"所有星期启用"

**修复位置**: `src/alpha_core/risk/strategy_mode.py` 第 508-513 行

**验证方法**:
```python
from alpha_core.risk.strategy_mode import StrategyModeManager
import json

cfg = {
    'strategy': {
        'mode': 'auto',
        'triggers': {
            'schedule': {
                'enabled': True,
                'enabled_weekdays': [],  # 空数组
                'active_windows': []
            }
        }
    }
}
m = StrategyModeManager(runtime_cfg=cfg)
result = m.check_schedule_active()
print(f"check_schedule_active: {result}")  # 应为 True
```

**预期结果**: ✅ `check_schedule_active()` 返回 `True`

**证据**: 报告第 508-513 行展示了修前修后逻辑

---

### 1.3 重复方法移除

**修复位置**: `src/alpha_core/signals/core_algo.py` 第 576-659 行（已删除）

**验证方法**:
```bash
# 检查文件末尾是否还有重复代码
grep -n "_create_market_activity\|_infer_regime" src/alpha_core/signals/core_algo.py
# 应该只有一处定义
```

**预期结果**: ✅ 每个方法只有一处定义

**证据**: 报告记录了删除重复实现的位置

---

### 1.4 FeaturePipe 语法错误修复

**修复位置**: `src/alpha_core/microstructure/feature_pipe.py` 第 725-775 行（已删除）

**验证方法**:
```python
# 尝试导入，不应有语法错误
from alpha_core.microstructure.feature_pipe import FeaturePipe
pipe = FeaturePipe()
# 应该能正常实例化
```

**预期结果**: ✅ 无 `IndentationError`，能正常实例化

**证据**: 报告说明修复位置；当前 FeaturePipe 能正常实例化 OFI/CVD/Fusion/Div

---

## 二、配置验证清单

### 2.1 Smoke 配置核对

**文件**: `config/defaults.smoke.yaml`

**关键配置项**:

| 配置项 | 值 | 说明 |
|--------|-----|------|
| `strategy_mode.mode` | `auto` | ✅ |
| `strategy_mode.triggers.combine_logic` | `OR` | ✅ OR 逻辑 |
| `strategy_mode.triggers.schedule.enabled` | `true` | ✅ 已启用 |
| `strategy_mode.triggers.schedule.enabled_weekdays` | `[]` | ✅ 空数组=所有星期 |
| `strategy_mode.triggers.schedule.active_windows` | `[]` | ✅ 空数组=全天有效 |
| `strategy_mode.triggers.market.enabled` | `true` | ✅ 已启用 |
| `signal.weak_signal_threshold` | `0.08` | ✅ 放宽（默认 0.2） |
| `signal.consistency_min` | `0.05` | ✅ 放宽（默认 0.15） |
| `signal.thresholds.quiet.buy` | `0.40` | ✅ 下探（默认 0.7） |

**验证命令**:
```bash
# 检查配置是否正确加载
python -c "
import yaml
with open('config/defaults.smoke.yaml', 'r', encoding='utf-8') as f:
    cfg = yaml.safe_load(f)
    sm = cfg.get('strategy_mode', {})
    triggers = sm.get('triggers', {})
    schedule = triggers.get('schedule', {})
    print(f'schedule.enabled: {schedule.get(\"enabled\")}')
    print(f'schedule.enabled_weekdays: {schedule.get(\"enabled_weekdays\")}')
    print(f'schedule.active_windows: {schedule.get(\"active_windows\")}')
    print(f'combine_logic: {triggers.get(\"combine_logic\")}')
"
```

**预期结果**: ✅ 所有配置项符合预期

---

### 2.2 Staging 配置创建

**文件**: `config/defaults.staging.yaml`（需创建）

**关键配置项**:

| 配置项 | 值 | 说明 |
|--------|-----|------|
| `combine_logic` | `AND` | ✅ 改为 AND |
| `schedule.enabled_weekdays` | `["Mon", "Tue", "Wed", "Thu", "Fri"]` | ✅ 仅工作日 |
| `schedule.active_windows` | 核心交易时段 | ✅ 排除凌晨 |
| `market.basic_gate_multiplier` | `0.5` | ✅ 收紧（smoke: 0.3） |
| `signal.weak_signal_threshold` | `0.15` | ✅ 收紧（smoke: 0.08） |
| `signal.consistency_min` | `0.10` | ✅ 收紧（smoke: 0.05） |

**验证命令**:
```bash
# 检查 staging 配置是否存在
test -f config/defaults.staging.yaml && echo "✅ Staging 配置已创建" || echo "❌ 需要创建"
```

**预期结果**: ✅ Staging 配置已创建

---

## 三、组件接线验证清单

### 3.1 FeaturePipe → CoreAlgo 映射

**验证项**:

| FeaturePipe 输出 | CoreAlgo 消费 | 状态 |
|------------------|--------------|------|
| `z_ofi` (zscore_window/100) | `z_ofi` | ✅ |
| `z_cvd` (window_ms/100) | `z_cvd` | ✅ |
| `fusion_score` (w_ofi/w_cvd) | `fusion_score` 或计算 | ✅ |
| `div_type` (lookback_bars) | `div_type` | ✅ |
| `trade_rate`, `quote_rate`, `realized_vol_bps`, `volume_usd` | `_create_market_activity()` | ✅ |

**验证方法**:
```python
# 检查 FeaturePipe 输出字段
from alpha_core.microstructure.feature_pipe import FeaturePipe
# 运行一个样本，检查输出字段
```

**预期结果**: ✅ 所有字段正确映射

---

### 3.2 CoreAlgo → StrategyMode 接线

**验证项**:

| CoreAlgo 调用 | StrategyMode 方法 | 状态 |
|---------------|-------------------|------|
| `_create_market_activity()` | `MarketActivity` 对象 | ✅ |
| `manager.update_mode(activity)` | 更新模式 | ✅ |
| `manager.get_current_mode()` | 获取当前模式 | ✅ |
| `manager._get_trigger_snapshot()` | 获取触发器快照 | ✅ |
| 心跳日志（每 10s） | JSON 格式输出 | ✅ |

**验证方法**:
```bash
# 运行 smoke 测试，检查日志
python -m mcp.signal_server.app \
  --config config/defaults.smoke.yaml \
  --input <features_jsonl> \
  --sink jsonl \
  --out ./runtime 2>&1 | grep -E "\[StrategyMode\]|schedule_active|market_active"
```

**预期结果**: ✅ 每 10 秒输出 JSON 格式心跳日志，包含 `schedule_active` 和 `market_active`

---

### 3.3 MCP 薄壳验证

**文件**: `mcp/signal_server/app.py`

**验证项**:

| 功能 | 实现 | 状态 |
|------|------|------|
| 配置加载 | `load_signal_config()` | ✅ |
| 合并 strategy_mode | `signal_cfg["strategy_mode"] = raw["strategy_mode"]` | ✅ |
| 使用包内 CoreAlgorithm | `from alpha_core.signals import CoreAlgorithm` | ✅ |
| 支持 --input (文件/目录/stdin) | `iter_feature_rows()` | ✅ |
| 支持 --sink (jsonl/sqlite/null) | `build_sink()` | ✅ |

**验证方法**:
```bash
# 检查导入路径
grep "from alpha_core.signals import" mcp/signal_server/app.py
# 应该显示: from alpha_core.signals import CoreAlgorithm
```

**预期结果**: ✅ 使用包内的 `alpha_core.signals.CoreAlgorithm`

---

## 四、立即执行检查清单

### 4.1 用包内 CoreAlgo 运行 smoke

**命令**:
```bash
cd F:\OFICVD
python -m mcp.signal_server.app \
  --config config/defaults.smoke.yaml \
  --input runtime/runs/<最新RUN_ID>/features_*.jsonl \
  --sink jsonl \
  --out ./runtime/test_verification
```

**检查点**:
- ✅ 日志中 `[StrategyMode] Config loaded: mode=auto, schedule_enabled=True`
- ✅ 每 10 秒输出 `[StrategyMode] {"schedule_active": true, "market_active": ...}` 心跳
- ✅ 无异常或回退到简化逻辑的警告

---

### 4.2 创建 Staging 配置

**操作**:
```bash
# 复制 smoke 配置
cp config/defaults.smoke.yaml config/defaults.staging.yaml

# 手动编辑或使用脚本修改三处：
# 1. combine_logic: OR -> AND
# 2. schedule.enabled_weekdays: [] -> ["Mon", "Tue", "Wed", "Thu", "Fri"]
# 3. schedule.active_windows: [] -> 核心交易时段
# 4. market.basic_gate_multiplier: 0.3 -> 0.5
# 5. signal 阈值收紧
```

**验证**:
```bash
# 检查配置语法
python -c "import yaml; yaml.safe_load(open('config/defaults.staging.yaml', 'r', encoding='utf-8'))"
```

**预期结果**: ✅ Staging 配置创建成功，语法正确

---

### 4.3 Activity 轻量估计验证

**检查点**:
- ✅ `_create_market_activity()` 中的兜底逻辑是否正常工作
- ✅ 当 `trade_rate`/`quote_rate` 为 null 时，是否使用 `activity.tps` 或行到达率估算
- ✅ 日志中 `trades_per_min` 和 `quotes_per_sec` 是否有合理值（非 0）

**验证方法**:
```python
# 检查兜底逻辑
from alpha_core.signals.core_algo import CoreAlgorithm

algo = CoreAlgorithm()
# 模拟缺少 trade_rate 的行
row = {
    "ts_ms": 1234567890000,
    "symbol": "BTCUSDT",
    "z_ofi": 0.5,
    "z_cvd": 0.3,
    # 缺少 trade_rate, quote_rate
}
activity = algo._create_market_activity(row)
print(f"trades_per_min: {activity.trades_per_min}")  # 应该有值（非 0）
```

**预期结果**: ✅ 兜底逻辑正常工作，能估算出合理的活动度

---

### 4.4 一致性门与阈值验证

**检查点**:
- ✅ Smoke 配置：`consistency_min=0.05`, `weak_signal_threshold=0.08`（已放宽）
- ✅ Staging 配置：`consistency_min=0.10`, `weak_signal_threshold=0.15`（需收紧）
- ✅ 生产配置：需进一步收紧（待创建）

**验证方法**:
```bash
# 对比不同配置的阈值
for env in smoke staging; do
  echo "=== $env ==="
  python -c "
import yaml
with open(f'config/defaults.$env.yaml', 'r', encoding='utf-8') as f:
    cfg = yaml.safe_load(f)
    signal = cfg.get('signal', {})
    print(f'consistency_min: {signal.get(\"consistency_min\")}')
    print(f'weak_signal_threshold: {signal.get(\"weak_signal_threshold\")}')
"
done
```

**预期结果**: ✅ Staging 阈值比 Smoke 收紧，生产需进一步收紧

---

## 五、风险点与建议

### 5.1 Active≈100% 仅适用于冒烟

**风险**: 生产环境如果使用 smoke 配置，会导致 Active 占比过高（99%），不符合真实市场情况

**建议**:
- ✅ 生产前切换到方案 1（仅 Market 触发）或方案 3（AND 逻辑）
- ✅ 参考报告第 8.2 节的三套配置模板

---

### 5.2 activity.tps=0.0 的历史问题

**风险**: 如果 schedule 关闭或周末/夜间 schedule 不生效，可能回到"全 quiet/全 normal"问题

**建议**:
- ✅ 确保 `_create_market_activity()` 的兜底逻辑正常工作
- ✅ 生产环境建议补齐 activity 侧统计（FeaturePipe 输出或 CoreAlgo 轻量滑窗估计）

---

### 5.3 一致性门与阈值

**风险**: Smoke 配置已放宽，生产环境需收紧，否则误报率可能过高

**建议**:
- ✅ Smoke: 保持放宽（用于 CI/E2E 验证）
- ✅ Staging: 收紧到中等水平（`consistency_min=0.10`, `weak_signal_threshold=0.15`）
- ✅ Prod: 进一步收紧（`consistency_min=0.15`, `weak_signal_threshold=0.20`）

---

## 六、配置基线建议

### 6.1 Smoke（现状，保留用于 CI/E2E）

```yaml
strategy_mode:
  triggers:
    combine_logic: OR
    schedule:
      enabled: true
      enabled_weekdays: []
      active_windows: []  # 全天有效
    market:
      basic_gate_multiplier: 0.3  # 放宽
signal:
  weak_signal_threshold: 0.08    # 放宽
  consistency_min: 0.05           # 放宽
```

**用途**: CI/E2E 验证，确保功能正常

---

### 6.2 Staging（预生产验证）

```yaml
strategy_mode:
  triggers:
    combine_logic: AND             # 改为 AND
    schedule:
      enabled: true
      enabled_weekdays: ["Mon", "Tue", "Wed", "Thu", "Fri"]  # 仅工作日
      active_windows: [核心交易时段]  # 排除凌晨
    market:
      basic_gate_multiplier: 0.5   # 收紧
signal:
  weak_signal_threshold: 0.15     # 收紧
  consistency_min: 0.10           # 收紧
```

**用途**: 预生产验证，接近真实环境

---

### 6.3 Prod（生产环境）

```yaml
strategy_mode:
  triggers:
    combine_logic: OR              # 或 AND，根据策略选择
    schedule:
      enabled: false              # 方案1：关闭 schedule，完全依赖 market
      # 或 enabled: true + 明确时段（方案2）
    market:
      basic_gate_multiplier: 1.0  # 生产级阈值
      min_trades_per_min: 30      # 品种化阈值
      min_quote_updates_per_sec: 5
      max_spread_bps: 15
      min_volatility_bps: 0.5
      min_volume_usd: 10000
signal:
  weak_signal_threshold: 0.20     # 生产级阈值
  consistency_min: 0.15           # 生产级阈值
```

**用途**: 生产环境，严格阈值

---

## 七、验证通过标准

### 7.1 功能验证

- ✅ Schedule 默认开启，空窗口=全天有效
- ✅ enabled_weekdays 空数组语义正确
- ✅ OR 逻辑正常工作
- ✅ 心跳日志 JSON 格式正确
- ✅ 无重复代码，无语法错误

### 7.2 配置验证

- ✅ Smoke 配置：OR + 全天有效，阈值放宽
- ✅ Staging 配置：AND + 工作日核心时段，阈值收紧
- ✅ 配置语法正确，能正常加载

### 7.3 性能验证

- ✅ 吞吐量：~837 rows/sec（可接受）
- ✅ 延迟：~1.2 ms/row（可接受）
- ✅ 资源使用：正常范围

### 7.4 集成验证

- ✅ FeaturePipe → CoreAlgo 映射正确
- ✅ CoreAlgo → StrategyMode 接线正确
- ✅ MCP 薄壳使用包内 CoreAlgorithm
- ✅ 端到端 smoke 测试通过

---

**检查清单版本**: v1.0  
**最后更新**: 2025-11-07  
**维护者**: AI Assistant

